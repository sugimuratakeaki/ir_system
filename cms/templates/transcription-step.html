{% extends "base.html" %}

{% block title %}æ–‡å­—èµ·ã“ã—ãƒ»ç·¨é›† - {{ meeting_data.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/ir-management.css">
<style>
/* æ–‡å­—èµ·ã“ã—å°‚ç”¨ç”»é¢ã‚¹ã‚¿ã‚¤ãƒ« */
.transcription-workspace {
    display: grid;
    grid-template-columns: 1fr;
    grid-template-rows: min-content 1fr;
    height: calc(100vh - 140px);
    gap: 1rem;
}

/* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆé€²æ—ãƒãƒ¼ */
.compact-progress {
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
    color: white;
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 0;
    z-index: 10;
}

.compact-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.compact-title {
    font-size: 1.125rem;
    font-weight: bold;
    margin-bottom: 0.25rem;
}

.compact-meta {
    font-size: 0.75rem;
    opacity: 0.9;
}

.step-navigation {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
}

.nav-step {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.2);
    cursor: pointer;
    transition: all 0.2s;
}

.nav-step.active {
    background: rgba(255, 255, 255, 0.3);
    font-weight: 600;
}

/* ãƒ¡ã‚¤ãƒ³ä½œæ¥­ã‚¨ãƒªã‚¢ */
.transcription-main {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 0;
    overflow: hidden;
}

.transcript-editor-area {
    display: flex;
    flex-direction: column;
    height: 100%;
}

/* éŸ³å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ */
.audio-player {
    background: #f8fafc;
    border-bottom: 2px solid #e5e7eb;
    padding: 1.5rem;
    flex-shrink: 0;
}

.player-main {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 1rem;
}

.play-button {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: #3b82f6;
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 1.5rem;
    transition: all 0.2s;
}

.play-button:hover {
    background: #2563eb;
    transform: scale(1.05);
}

.playback-controls {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.progress-container {
    position: relative;
}

.progress-bar {
    width: 100%;
    height: 12px;
    background: #e5e7eb;
    border-radius: 6px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #3b82f6, #1e40af);
    border-radius: 6px;
    width: 25%;
    transition: width 0.1s;
}

.progress-markers {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 100%;
    pointer-events: none;
}

.progress-marker {
    position: absolute;
    width: 2px;
    height: 100%;
    background: #f59e0b;
    border-radius: 1px;
}

.time-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-family: monospace;
    font-size: 0.875rem;
    color: #6b7280;
}

.playback-speed {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.speed-btn {
    padding: 0.25rem 0.5rem;
    border: 1px solid #d1d5db;
    background: white;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}

.speed-btn.active {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

/* ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ */
.editor-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.editor-toolbar {
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
    padding: 0.75rem 1.5rem;
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
}

.toolbar-section {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.toolbar-btn {
    padding: 0.5rem 0.75rem;
    border: 1px solid #d1d5db;
    background: white;
    border-radius: 6px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.toolbar-btn:hover {
    background: #f3f4f6;
}

.toolbar-btn.active {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.search-box {
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.75rem;
    width: 200px;
}

/* æ–‡å­—èµ·ã“ã—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
.transcript-content {
    flex: 1;
    padding: 1.5rem;
    overflow-y: auto;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.transcript-segment {
    margin-bottom: 1.5rem;
    padding: 1.5rem;
    border-radius: 8px;
    border-left: 3px solid transparent;
    transition: all 0.2s;
    position: relative;
    background: #fafafa;
    border: 1px solid #f0f0f0;
}

.transcript-segment:hover {
    background: #f8fafc;
    border-color: #e5e7eb;
}

.transcript-segment.current {
    background: #fef3c7;
    border-left-color: #f59e0b;
    border-color: #fbbf24;
}

.transcript-segment.highlighted {
    background: #dbeafe;
    border-left-color: #3b82f6;
    border-color: #93c5fd;
}

.transcript-segment.important {
    background: #fee2e2;
    border-left-color: #ef4444;
    border-color: #fca5a5;
}

.segment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.speaker-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.speaker-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #3b82f6;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
}

.speaker-name {
    font-weight: 600;
    color: #111827;
    font-size: 0.875rem;
}

.timestamp-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: #6b7280;
}

.timestamp-link {
    font-family: monospace;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    transition: all 0.2s;
}

.timestamp-link:hover {
    background: #e5e7eb;
    color: #3b82f6;
}

.segment-text {
    font-size: 1rem;
    line-height: 1.8;
    color: #1f2937;
    margin-bottom: 1rem;
    padding: 0.75rem;
    border-radius: 6px;
    background: white;
    border: 1px solid #e5e7eb;
    min-height: 100px;
    resize: vertical;
    font-family: inherit;
    outline: none;
    transition: border-color 0.2s;
}

.segment-text:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.segment-actions {
    display: flex;
    gap: 0.5rem;
    opacity: 0;
    transition: opacity 0.2s;
}

.transcript-segment:hover .segment-actions {
    opacity: 1;
}

.segment-btn {
    padding: 0.375rem 0.75rem;
    border: none;
    background: #f3f4f6;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.segment-btn:hover {
    background: #e5e7eb;
}

.segment-btn.active {
    background: #3b82f6;
    color: white;
}

/* ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« */
.transcription-sidebar {
    background: #f8fafc;
    border-left: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.sidebar-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    background: white;
}

.sidebar-title {
    font-weight: 600;
    color: #111827;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sidebar-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.stat-item {
    text-align: center;
    padding: 0.75rem;
    background: #f9fafb;
    border-radius: 6px;
}

.stat-value {
    font-size: 1.125rem;
    font-weight: bold;
    color: #111827;
}

.stat-label {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.25rem;
}

.sidebar-content {
    flex: 1;
    padding: 1.5rem;
    overflow-y: auto;
}

.sidebar-section {
    margin-bottom: 2rem;
}

.section-title {
    font-weight: 600;
    color: #111827;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
}

.speaker-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.speaker-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}

.speaker-item:hover {
    background: #f3f4f6;
}

.speaker-item.active {
    background: #dbeafe;
    border: 1px solid #93c5fd;
}

.action-shortcuts {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.5rem;
}

.shortcut-btn {
    padding: 0.75rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.875rem;
}

.shortcut-btn:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
}

.shortcut-key {
    float: right;
    font-size: 0.75rem;
    color: #6b7280;
    font-family: monospace;
}

/* ãƒ•ãƒƒã‚¿ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ */
.action-bar {
    background: #f8fafc;
    border-top: 1px solid #e5e7eb;
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}

.save-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #6b7280;
}

.save-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #10b981;
}

.save-indicator.saving {
    background: #f59e0b;
    animation: pulse 2s infinite;
}

.action-buttons {
    display: flex;
    gap: 0.75rem;
}

.btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-secondary {
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #d1d5db;
}

.btn-primary {
    background: #3b82f6;
    color: white;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>
{% endblock %}

{% block content %}
<div class="transcription-workspace">
    <!-- ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆé€²æ—ãƒãƒ¼ -->
    <div class="compact-progress">
        <div class="compact-header">
            <div>
                <h1 class="compact-title">{{ meeting_data.title }}</h1>
                <div class="compact-meta">
                    {{ meeting_data.investor_name }} â€¢ {{ meeting_data.formatted_date }} â€¢ æ–‡å­—èµ·ã“ã—ãƒ»ç·¨é›†
                </div>
            </div>
            <div class="step-navigation">
                <div class="nav-step" onclick="goToStep('upload')">ğŸ“ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
                <div class="nav-step active" onclick="goToStep('transcription')">ğŸ“ æ–‡å­—èµ·ã“ã—</div>
                <div class="nav-step" onclick="goToStep('ai_summary')">ğŸ¤– AIè¦ç´„</div>
                <div class="nav-step" onclick="goToStep('faq')">â“ FAQ</div>
                <div class="nav-step" onclick="goToStep('review')">âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
                <div class="nav-step" onclick="goToStep('publish')">ğŸŒ å…¬é–‹</div>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ä½œæ¥­ã‚¨ãƒªã‚¢ -->
    <div class="transcription-main">
        <!-- ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ -->
        <div class="transcript-editor-area">
            <!-- éŸ³å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
            <div class="audio-player">
                <div class="player-main">
                    <button class="play-button" onclick="togglePlayback()">
                        <span id="play-icon">â–¶ï¸</span>
                    </button>
                    <div class="playback-controls">
                        <div class="progress-container">
                            <div class="progress-bar" onclick="seekAudio(event)">
                                <div class="progress-fill" id="progress-fill"></div>
                                <div class="progress-markers">
                                    <div class="progress-marker" style="left: 15%;"></div>
                                    <div class="progress-marker" style="left: 35%;"></div>
                                    <div class="progress-marker" style="left: 67%;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="time-info">
                            <span id="current-time">12:34</span>
                            <span>{{ meeting_data.files[0].duration if meeting_data.files else '1:30:45' }}</span>
                        </div>
                    </div>
                </div>
                <div class="playback-speed">
                    <span style="font-size: 0.75rem; color: #6b7280; margin-right: 0.5rem;">å†ç”Ÿé€Ÿåº¦:</span>
                    <button class="speed-btn" onclick="setPlaybackSpeed(0.75)">0.75x</button>
                    <button class="speed-btn active" onclick="setPlaybackSpeed(1.0)">1.0x</button>
                    <button class="speed-btn" onclick="setPlaybackSpeed(1.25)">1.25x</button>
                    <button class="speed-btn" onclick="setPlaybackSpeed(1.5)">1.5x</button>
                    <span style="margin-left: 1rem; font-size: 0.75rem; color: #6b7280;">
                        ğŸ¤ èªè­˜ç²¾åº¦: {{ meeting_data.transcript_stats.accuracy if meeting_data.transcript_stats else '96' }}%
                    </span>
                </div>
            </div>

            <!-- ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
            <div class="editor-toolbar">
                <div class="toolbar-section">
                    <button class="toolbar-btn" onclick="highlightMode()">
                        ğŸ–ï¸ ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    </button>
                    <button class="toolbar-btn" onclick="importantMode()">
                        â­ é‡è¦
                    </button>
                    <button class="toolbar-btn" onclick="speakerMode()">
                        ğŸ‘¤ è©±è€…åˆ†é›¢
                    </button>
                </div>
                <div class="toolbar-section">
                    <button class="toolbar-btn" onclick="undoAction()">
                        â†¶ å…ƒã«æˆ»ã™
                    </button>
                    <button class="toolbar-btn" onclick="redoAction()">
                        â†· ã‚„ã‚Šç›´ã—
                    </button>
                </div>
                <div class="toolbar-section">
                    <input type="text" class="search-box" placeholder="ğŸ” æ–‡å­—èµ·ã“ã—å†…ã‚’æ¤œç´¢..." onkeyup="searchTranscript(this.value)">
                </div>
                <div class="toolbar-section" style="margin-left: auto;">
                    <span style="font-size: 0.75rem; color: #6b7280;">
                        ç·æ–‡å­—æ•°: {{ meeting_data.transcript_stats.total_chars if meeting_data.transcript_stats else '15,680' }}æ–‡å­— | 
                        èª­äº†æ™‚é–“: ç´„{{ meeting_data.transcript_stats.reading_time if meeting_data.transcript_stats else '12' }}åˆ†
                    </span>
                </div>
            </div>

            <!-- æ–‡å­—èµ·ã“ã—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="transcript-content">
                {% if meeting_data.transcript_preview %}
                {% set segments = meeting_data.transcript_preview.split('\n\n') %}
                {% for segment in segments %}
                {% if segment.strip() %}
                <div class="transcript-segment" data-timestamp="00:{{ loop.index }}:{{ loop.index * 5 }}" id="segment-{{ loop.index }}">
                    <div class="segment-header">
                        <div class="speaker-info">
                            <div class="speaker-avatar">
                                {% if 'ç”°ä¸­ï¼ˆCEOï¼‰' in segment %}T
                                {% elif 'ä½è—¤ï¼ˆCFOï¼‰' in segment %}S
                                {% elif 'æŠ•è³‡å®¶' in segment %}I
                                {% else %}?{% endif %}
                            </div>
                            <span class="speaker-name">
                                {% if 'ç”°ä¸­ï¼ˆCEOï¼‰' in segment %}ç”°ä¸­ï¼ˆCEOï¼‰
                                {% elif 'ä½è—¤ï¼ˆCFOï¼‰' in segment %}ä½è—¤ï¼ˆCFOï¼‰
                                {% elif 'æŠ•è³‡å®¶' in segment %}{{ meeting_data.investor_name }}
                                {% else %}ç™ºè¨€è€…{% endif %}
                            </span>
                        </div>
                        <div class="timestamp-info">
                            <span class="timestamp-link" onclick="jumpToTime('00:{{ loop.index }}:{{ loop.index * 5 }}')">
                                {{ loop.index }}:{{ '%02d'|format(loop.index * 5) }}
                            </span>
                            <span>â€¢</span>
                            <span>{{ loop.index * 30 }}æ–‡å­—</span>
                        </div>
                    </div>
                    <textarea class="segment-text" oninput="markAsEdited(this)" onblur="autoSave()">{{ segment.replace('ã€ç”°ä¸­ï¼ˆCEOï¼‰ã€‘', '').replace('ã€ä½è—¤ï¼ˆCFOï¼‰ã€‘', '').replace('ã€æŠ•è³‡å®¶ã€‘', '').strip() }}</textarea>
                    <div class="segment-actions">
                        <button class="segment-btn" onclick="highlightSegment({{ loop.index }})">
                            ğŸ–ï¸ ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                        </button>
                        <button class="segment-btn" onclick="markImportant({{ loop.index }})">
                            â­ é‡è¦
                        </button>
                        <button class="segment-btn" onclick="addNote({{ loop.index }})">
                            ğŸ“ ãƒ¡ãƒ¢
                        </button>
                        <button class="segment-btn" onclick="splitSegment({{ loop.index }})">
                            âœ‚ï¸ åˆ†å‰²
                        </button>
                        <button class="segment-btn" onclick="deleteSegment({{ loop.index }})">
                            ğŸ—‘ï¸ å‰Šé™¤
                        </button>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
                {% else %}
                <div style="text-align: center; padding: 4rem; color: #6b7280;">
                    <div style="font-size: 4rem; margin-bottom: 1.5rem;">ğŸ“</div>
                    <h3 style="font-size: 1.25rem; margin-bottom: 0.5rem;">æ–‡å­—èµ·ã“ã—ã‚’é–‹å§‹</h3>
                    <p>éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®AIæ–‡å­—èµ·ã“ã—ã‚’é–‹å§‹ã™ã‚‹ã‹ã€æ‰‹å‹•ã§æ–‡å­—èµ·ã“ã—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                    <button class="btn btn-primary" onclick="startTranscription()" style="margin-top: 1.5rem;">
                        ğŸ¤– AIæ–‡å­—èµ·ã“ã—é–‹å§‹
                    </button>
                </div>
                {% endif %}
            </div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
            <div class="action-bar">
                <div class="save-status">
                    <div class="save-indicator" id="save-indicator"></div>
                    <span>æœ€çµ‚ä¿å­˜: {{ current_time }}</span>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="exportTranscript()">
                        ğŸ“¤ æ›¸ãå‡ºã—
                    </button>
                    <button class="btn btn-secondary" onclick="saveDraft()">
                        ğŸ’¾ ä¿å­˜
                    </button>
                    <button class="btn btn-primary" onclick="proceedToSummary()">
                        ğŸ¤– AIè¦ç´„ã¸é€²ã‚€
                    </button>
                </div>
            </div>
        </div>

        <!-- ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« -->
        <div class="transcription-sidebar">
            <div class="sidebar-header">
                <h3 class="sidebar-title">ğŸ“Š æ–‡å­—èµ·ã“ã—æƒ…å ±</h3>
                <div class="sidebar-stats">
                    <div class="stat-item">
                        <div class="stat-value">{{ segments|length if segments else '8' }}</div>
                        <div class="stat-label">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">96%</div>
                        <div class="stat-label">èªè­˜ç²¾åº¦</div>
                    </div>
                </div>
            </div>

            <div class="sidebar-content">
                <!-- è©±è€…ä¸€è¦§ -->
                <div class="sidebar-section">
                    <h4 class="section-title">ğŸ‘¥ è©±è€…ä¸€è¦§</h4>
                    <div class="speaker-list">
                        <div class="speaker-item active" onclick="filterBySpeaker('ç”°ä¸­CEO')">
                            <div class="speaker-avatar">T</div>
                            <div>
                                <div style="font-weight: 600; font-size: 0.875rem;">ç”°ä¸­ï¼ˆCEOï¼‰</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">45% (3,200æ–‡å­—)</div>
                            </div>
                        </div>
                        <div class="speaker-item" onclick="filterBySpeaker('ä½è—¤CFO')">
                            <div class="speaker-avatar">S</div>
                            <div>
                                <div style="font-weight: 600; font-size: 0.875rem;">ä½è—¤ï¼ˆCFOï¼‰</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">25% (1,800æ–‡å­—)</div>
                            </div>
                        </div>
                        <div class="speaker-item" onclick="filterBySpeaker('æŠ•è³‡å®¶')">
                            <div class="speaker-avatar">I</div>
                            <div>
                                <div style="font-weight: 600; font-size: 0.875rem;">{{ meeting_data.investor_name }}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">30% (2,100æ–‡å­—)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="sidebar-section">
                    <h4 class="section-title">âš¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h4>
                    <div class="action-shortcuts">
                        <button class="shortcut-btn" onclick="jumpToImportant()">
                            â­ é‡è¦ç®‡æ‰€ã¸ã‚¸ãƒ£ãƒ³ãƒ—
                            <span class="shortcut-key">Ctrl+I</span>
                        </button>
                        <button class="shortcut-btn" onclick="jumpToHighlighted()">
                            ğŸ–ï¸ ãƒã‚¤ãƒ©ã‚¤ãƒˆç®‡æ‰€ã¸
                            <span class="shortcut-key">Ctrl+H</span>
                        </button>
                        <button class="shortcut-btn" onclick="togglePlayback()">
                            â–¶ï¸ å†ç”Ÿ/åœæ­¢
                            <span class="shortcut-key">Space</span>
                        </button>
                        <button class="shortcut-btn" onclick="jumpBackward()">
                            âª 10ç§’æˆ»ã‚‹
                            <span class="shortcut-key">â†</span>
                        </button>
                        <button class="shortcut-btn" onclick="jumpForward()">
                            â© 10ç§’é€²ã‚€
                            <span class="shortcut-key">â†’</span>
                        </button>
                    </div>
                </div>

                <!-- AIæ”¯æ´ -->
                <div class="sidebar-section">
                    <h4 class="section-title">ğŸ¤– AIæ”¯æ´</h4>
                    <div class="action-shortcuts">
                        <button class="shortcut-btn" onclick="improveAccuracy()">
                            ğŸ¯ èªè­˜ç²¾åº¦å‘ä¸Š
                        </button>
                        <button class="shortcut-btn" onclick="autoCorrect()">
                            âœ¨ è‡ªå‹•æ ¡æ­£
                        </button>
                        <button class="shortcut-btn" onclick="detectKeyPoints()">
                            ğŸ” é‡è¦ãƒã‚¤ãƒ³ãƒˆæ¤œå‡º
                        </button>
                        <button class="shortcut-btn" onclick="generateSummary()">
                            ğŸ“ è¦ç´„ç”Ÿæˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
const meetingId = '{{ meeting_id }}';
let isPlaying = false;
let currentTime = 0;
let totalDuration = 5445; // 1:30:45 in seconds
let autoSaveInterval;
let editHistory = [];
let historyIndex = -1;

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    startAutoSave();
    initializeKeyboardShortcuts();
    updateTimeDisplay();
});

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
function initializeKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 's':
                    e.preventDefault();
                    saveDraft();
                    break;
                case 'z':
                    e.preventDefault();
                    undoAction();
                    break;
                case 'y':
                    e.preventDefault();
                    redoAction();
                    break;
                case 'i':
                    e.preventDefault();
                    jumpToImportant();
                    break;
                case 'h':
                    e.preventDefault();
                    jumpToHighlighted();
                    break;
            }
        } else if (e.key === ' ' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
            togglePlayback();
        } else if (e.key === 'ArrowLeft' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
            jumpBackward();
        } else if (e.key === 'ArrowRight' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
            jumpForward();
        }
    });
}

// éŸ³å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ©Ÿèƒ½
function togglePlayback() {
    isPlaying = !isPlaying;
    const playIcon = document.getElementById('play-icon');
    if (playIcon) {
        playIcon.textContent = isPlaying ? 'â¸ï¸' : 'â–¶ï¸';
    }
    
    if (isPlaying) {
        startPlaybackTimer();
    } else {
        stopPlaybackTimer();
    }
    
    showNotification(isPlaying ? 'å†ç”Ÿé–‹å§‹' : 'å†ç”Ÿåœæ­¢', 'info');
}

function startPlaybackTimer() {
    window.playbackTimer = setInterval(function() {
        currentTime += 1;
        if (currentTime >= totalDuration) {
            currentTime = totalDuration;
            togglePlayback();
        }
        updateTimeDisplay();
        updateProgressBar();
        highlightCurrentSegment();
    }, 1000);
}

function stopPlaybackTimer() {
    if (window.playbackTimer) {
        clearInterval(window.playbackTimer);
    }
}

function updateTimeDisplay() {
    const currentTimeElement = document.getElementById('current-time');
    if (currentTimeElement) {
        currentTimeElement.textContent = formatTime(currentTime);
    }
}

function updateProgressBar() {
    const progressFill = document.getElementById('progress-fill');
    if (progressFill) {
        const percentage = (currentTime / totalDuration) * 100;
        progressFill.style.width = percentage + '%';
    }
}

function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
}

function seekAudio(event) {
    const progressBar = event.currentTarget;
    const rect = progressBar.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const percentage = clickX / rect.width;
    
    currentTime = totalDuration * percentage;
    updateTimeDisplay();
    updateProgressBar();
    highlightCurrentSegment();
}

function jumpToTime(timestamp) {
    const parts = timestamp.split(':').map(Number);
    let seconds = 0;
    
    if (parts.length === 2) {
        seconds = parts[0] * 60 + parts[1];
    } else if (parts.length === 3) {
        seconds = parts[0] * 3600 + parts[1] * 60 + parts[2];
    }
    
    currentTime = seconds;
    updateTimeDisplay();
    updateProgressBar();
    highlightCurrentSegment();
    showNotification(`â­ï¸ ${timestamp} ã«ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã—ãŸ`, 'info');
}

function jumpBackward() {
    currentTime = Math.max(0, currentTime - 10);
    updateTimeDisplay();
    updateProgressBar();
    highlightCurrentSegment();
}

function jumpForward() {
    currentTime = Math.min(totalDuration, currentTime + 10);
    updateTimeDisplay();
    updateProgressBar();
    highlightCurrentSegment();
}

function setPlaybackSpeed(speed) {
    document.querySelectorAll('.speed-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    showNotification(`å†ç”Ÿé€Ÿåº¦ã‚’ ${speed}x ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'info');
}

function highlightCurrentSegment() {
    document.querySelectorAll('.transcript-segment').forEach(segment => {
        segment.classList.remove('current');
    });
    
    // ç¾åœ¨ã®æ™‚é–“ã«å¯¾å¿œã™ã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    const currentSegmentIndex = Math.floor(currentTime / 60) + 1;
    const currentSegment = document.getElementById(`segment-${currentSegmentIndex}`);
    if (currentSegment) {
        currentSegment.classList.add('current');
        currentSegment.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// ç·¨é›†æ©Ÿèƒ½
function markAsEdited(textarea) {
    const segment = textarea.closest('.transcript-segment');
    if (!segment.classList.contains('edited')) {
        segment.classList.add('edited');
        addToHistory('edit', segment.id, textarea.value);
    }
    
    // è‡ªå‹•ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
    const indicator = document.getElementById('save-indicator');
    if (indicator) {
        indicator.classList.add('saving');
    }
}

function addToHistory(action, targetId, data) {
    editHistory = editHistory.slice(0, historyIndex + 1);
    editHistory.push({ action, targetId, data, timestamp: Date.now() });
    historyIndex = editHistory.length - 1;
}

function undoAction() {
    if (historyIndex > 0) {
        historyIndex--;
        const action = editHistory[historyIndex];
        // å®Ÿè£…: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å…ƒã«æˆ»ã™
        showNotification('å¤‰æ›´ã‚’å…ƒã«æˆ»ã—ã¾ã—ãŸ', 'info');
    }
}

function redoAction() {
    if (historyIndex < editHistory.length - 1) {
        historyIndex++;
        const action = editHistory[historyIndex];
        // å®Ÿè£…: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚„ã‚Šç›´ã™
        showNotification('å¤‰æ›´ã‚’ã‚„ã‚Šç›´ã—ã¾ã—ãŸ', 'info');
    }
}

function highlightSegment(segmentId) {
    const segment = document.getElementById(`segment-${segmentId}`);
    if (segment) {
        segment.classList.toggle('highlighted');
        const isHighlighted = segment.classList.contains('highlighted');
        showNotification(isHighlighted ? 'ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ã¾ã—ãŸ' : 'ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤ã—ã¾ã—ãŸ', 'success');
        addToHistory('highlight', `segment-${segmentId}`, isHighlighted);
    }
}

function markImportant(segmentId) {
    const segment = document.getElementById(`segment-${segmentId}`);
    if (segment) {
        segment.classList.toggle('important');
        const isImportant = segment.classList.contains('important');
        showNotification(isImportant ? 'é‡è¦ç®‡æ‰€ã«ãƒãƒ¼ã‚¯ã—ã¾ã—ãŸ' : 'é‡è¦ãƒãƒ¼ã‚¯ã‚’è§£é™¤ã—ã¾ã—ãŸ', 'success');
        addToHistory('important', `segment-${segmentId}`, isImportant);
    }
}

function addNote(segmentId) {
    const noteText = prompt('ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
    if (noteText) {
        const segment = document.getElementById(`segment-${segmentId}`);
        let noteElement = segment.querySelector('.segment-note');
        if (!noteElement) {
            noteElement = document.createElement('div');
            noteElement.className = 'segment-note';
            noteElement.style.cssText = 'margin-top: 0.75rem; padding: 0.75rem; background: #fef3c7; border-radius: 6px; border-left: 3px solid #f59e0b;';
            segment.appendChild(noteElement);
        }
        noteElement.innerHTML = `<span style="font-weight: 600; color: #92400e; font-size: 0.75rem;">ğŸ“ ãƒ¡ãƒ¢:</span> <span style="color: #451a03; font-size: 0.875rem;">${noteText}</span>`;
        showNotification('ãƒ¡ãƒ¢ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
        addToHistory('note', `segment-${segmentId}`, noteText);
    }
}

function splitSegment(segmentId) {
    if (confirm('ã“ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’åˆ†å‰²ã—ã¾ã™ã‹ï¼Ÿ')) {
        showNotification('ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†å‰²æ©Ÿèƒ½ã‚’å®Ÿè£…ä¸­...', 'info');
    }
}

function deleteSegment(segmentId) {
    if (confirm('ã“ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        const segment = document.getElementById(`segment-${segmentId}`);
        if (segment) {
            segment.style.display = 'none';
            showNotification('ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            addToHistory('delete', `segment-${segmentId}`, true);
        }
    }
}

// æ¤œç´¢æ©Ÿèƒ½
function searchTranscript(query) {
    const segments = document.querySelectorAll('.transcript-segment');
    segments.forEach(segment => {
        const text = segment.querySelector('.segment-text').value.toLowerCase();
        if (query && text.includes(query.toLowerCase())) {
            segment.style.border = '2px solid #3b82f6';
            segment.style.background = '#dbeafe';
        } else {
            segment.style.border = '';
            segment.style.background = '';
        }
    });
}

// ã‚µã‚¤ãƒ‰ãƒãƒ¼æ©Ÿèƒ½
function filterBySpeaker(speaker) {
    document.querySelectorAll('.speaker-item').forEach(item => item.classList.remove('active'));
    event.target.closest('.speaker-item').classList.add('active');
    
    const segments = document.querySelectorAll('.transcript-segment');
    segments.forEach(segment => {
        // è©±è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®å®Ÿè£…
        segment.style.opacity = '1';
    });
    
    showNotification(`${speaker}ã®ç™ºè¨€ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã—ãŸ`, 'info');
}

function jumpToImportant() {
    const importantSegment = document.querySelector('.transcript-segment.important');
    if (importantSegment) {
        importantSegment.scrollIntoView({ behavior: 'smooth', block: 'center' });
        showNotification('é‡è¦ç®‡æ‰€ã«ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã—ãŸ', 'info');
    } else {
        showNotification('é‡è¦ç®‡æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
    }
}

function jumpToHighlighted() {
    const highlightedSegment = document.querySelector('.transcript-segment.highlighted');
    if (highlightedSegment) {
        highlightedSegment.scrollIntoView({ behavior: 'smooth', block: 'center' });
        showNotification('ãƒã‚¤ãƒ©ã‚¤ãƒˆç®‡æ‰€ã«ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã—ãŸ', 'info');
    } else {
        showNotification('ãƒã‚¤ãƒ©ã‚¤ãƒˆç®‡æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
    }
}

// AIæ©Ÿèƒ½
function improveAccuracy() {
    showNotification('ğŸ¤– AIèªè­˜ç²¾åº¦å‘ä¸Šã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...', 'info');
    setTimeout(() => {
        showNotification('âœ¨ èªè­˜ç²¾åº¦ãŒ98%ã«å‘ä¸Šã—ã¾ã—ãŸï¼', 'success');
    }, 3000);
}

function autoCorrect() {
    showNotification('ğŸ¤– è‡ªå‹•æ ¡æ­£ã‚’å®Ÿè¡Œä¸­...', 'info');
    setTimeout(() => {
        showNotification('âœ… 12ç®‡æ‰€ã®èª¤å­—ãƒ»è„±å­—ã‚’ä¿®æ­£ã—ã¾ã—ãŸ', 'success');
    }, 2000);
}

function detectKeyPoints() {
    showNotification('ğŸ” é‡è¦ãƒã‚¤ãƒ³ãƒˆã‚’æ¤œå‡ºä¸­...', 'info');
    setTimeout(() => {
        showNotification('â­ 5ç®‡æ‰€ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆã‚’æ¤œå‡ºã—ã¾ã—ãŸ', 'success');
    }, 2500);
}

function generateSummary() {
    showNotification('ğŸ“ è¦ç´„ã‚’ç”Ÿæˆä¸­...', 'info');
    setTimeout(() => {
        showNotification('ğŸ“‹ è¦ç´„ãŒå®Œæˆã—ã¾ã—ãŸ', 'success');
    }, 4000);
}

// ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
function goToStep(step) {
    const stepUrls = {
        'upload': `/upload-step?id=${meetingId}`,
        'transcription': `/transcription-step?id=${meetingId}`,
        'ai_summary': `/ai-summary-step?id=${meetingId}`,
        'faq': `/faq-step?id=${meetingId}`,
        'review': `/review-step?id=${meetingId}`,
        'publish': `/publish-step?id=${meetingId}`
    };
    
    if (stepUrls[step]) {
        window.location.href = stepUrls[step];
    }
}

function proceedToSummary() {
    if (confirm('æ–‡å­—èµ·ã“ã—ç·¨é›†ã‚’å®Œäº†ã—ã¦AIè¦ç´„ã«é€²ã¿ã¾ã™ã‹ï¼Ÿ')) {
        saveDraft();
        setTimeout(() => {
            goToStep('ai_summary');
        }, 1000);
    }
}

// ä¿å­˜ãƒ»æ›¸ãå‡ºã—
function autoSave() {
    const indicator = document.getElementById('save-indicator');
    if (indicator) {
        indicator.classList.add('saving');
        setTimeout(() => {
            indicator.classList.remove('saving');
        }, 1000);
    }
}

function startAutoSave() {
    autoSaveInterval = setInterval(autoSave, 30000);
}

function saveDraft() {
    showNotification('ğŸ’¾ æ–‡å­—èµ·ã“ã—ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
    autoSave();
}

function exportTranscript() {
    showNotification('ğŸ“¤ æ–‡å­—èµ·ã“ã—ã‚’æ›¸ãå‡ºã—ä¸­...', 'info');
    setTimeout(() => {
        showNotification('âœ… æ›¸ãå‡ºã—ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
    }, 2000);
}

function startTranscription() {
    showNotification('ğŸ¤– AIæ–‡å­—èµ·ã“ã—ã‚’é–‹å§‹ã—ã¾ã™...', 'info');
    setTimeout(() => {
        location.reload();
    }, 3000);
}

// é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg z-50 transform transition-all duration-300';
    
    const colors = {
        success: 'bg-green-500 text-white',
        error: 'bg-red-500 text-white',
        warning: 'bg-yellow-500 text-white',
        info: 'bg-blue-500 text-white'
    };
    
    notification.className += ' ' + (colors[type] || colors.info);
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(400px)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
</script>
{% endblock %} 
{% extends 'base-three-column.html' %}

{% block title %}{{ meeting_data.title }} - 議事録編集{% endblock %}

{% block left_sidebar_title %}投資家・履歴情報{% endblock %}
{% block right_panel_title %}🤖 AIアシスタント{% endblock %}
{% block right_panel_toggle_text %}AI分析{% endblock %}

{% block main_title %}{{ meeting_data.title }}{% endblock %}
{% block main_subtitle %}統合議事録編集システム{% endblock %}

{% block three_column_extra_css %}
<style>
/* 統合議事録編集システム専用スタイル */

/* パイプライン進捗バー（上部固定）*/
.pipeline-progress {
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
    color: white;
    border-radius: 8px;
    padding: 1rem 1.5rem;
    margin-bottom: 0.75rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 0;
    z-index: 10;
}

.pipeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.meeting-info h1 {
    font-size: 1.25rem;
    font-weight: bold;
    margin-bottom: 0.25rem;
    line-height: 1.2;
}

.meeting-meta {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    font-size: 0.875rem;
    opacity: 0.9;
}

.meeting-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.action-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
}

.priority-high {
    background: rgba(239, 68, 68, 0.2);
    color: #dc2626;
}

.days-elapsed {
    background: rgba(245, 158, 11, 0.2);
    color: #d97706;
}

/* 段階インジケーター */
.stage-pipeline {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 0.75rem;
}

.stages-container {
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.stages-container::-webkit-scrollbar {
    display: none;
}

.stage-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.75rem 0.5rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    min-width: 100px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    flex-shrink: 0;
}

.stage-item:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
}

.stage-item.active {
    background: rgba(34, 197, 94, 0.3);
    box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.5);
}

.stage-item.completed {
    background: rgba(34, 197, 94, 0.2);
}

.stage-icon {
    font-size: 1.25rem;
    margin-bottom: 0.25rem;
}

.stage-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-align: center;
    line-height: 1.2;
    margin-bottom: 0.25rem;
    white-space: pre-line;
}

.stage-desc {
    font-size: 0.625rem;
    opacity: 0.8;
    text-align: center;
    line-height: 1.2;
}

/* 左サイドバー専用スタイル */
.investor-profile {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.investor-avatar {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.25rem;
}

.investor-info h4 {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.investor-info p {
    font-size: 0.875rem;
    color: #6b7280;
}

.investor-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

.stat-item {
    text-align: center;
    padding: 0.75rem;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.stat-value {
    font-size: 1.25rem;
    font-weight: bold;
    color: #1f2937;
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.75rem;
    color: #6b7280;
}

.past-meetings, .related-docs {
    space-y: 0.5rem;
}

.past-meeting, .doc-item {
    padding: 0.75rem;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-bottom: 0.5rem;
}

.past-meeting:hover, .doc-item:hover {
    background: #f1f5f9;
    border-color: #cbd5e1;
}

.meeting-date {
    font-size: 0.75rem;
    color: #6b7280;
    margin-bottom: 0.25rem;
}

.meeting-topic {
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.meeting-score {
    font-size: 0.75rem;
    color: #059669;
}

.doc-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.doc-icon {
    font-size: 1rem;
}

.doc-name {
    font-size: 0.875rem;
    font-weight: 500;
}

/* ワークエリア専用スタイル */
.work-area-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.current-stage-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.stage-icon {
    font-size: 2rem;
}

.stage-details h3 {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.stage-details p {
    font-size: 0.875rem;
    color: #6b7280;
}

.stage-actions {
    display: flex;
    gap: 0.5rem;
}

/* AI アシスタント専用スタイル */
.ai-suggestion {
    background: #f0f9ff;
    border: 1px solid #0ea5e9;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.suggestion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.suggestion-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #0c4a6e;
}

.confidence-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    background: rgba(14, 165, 233, 0.1);
    color: #0c4a6e;
    border-radius: 4px;
}

.suggestion-content {
    font-size: 0.875rem;
    color: #374151;
    margin-bottom: 0.75rem;
    line-height: 1.5;
}

.suggestion-actions {
    display: flex;
    gap: 0.5rem;
}

.suggestion-btn {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
}

.suggestion-btn.primary {
    background: #0ea5e9;
    color: white;
}

.suggestion-btn.primary:hover {
    background: #0284c7;
}

.suggestion-btn.secondary {
    background: #f1f5f9;
    color: #64748b;
    border: 1px solid #cbd5e1;
}

.suggestion-btn.secondary:hover {
    background: #e2e8f0;
    border-color: #94a3b8;
}

/* レスポンシブ対応 */
@media (max-width: 1200px) {
    .stages-container {
        gap: 0.25rem;
    }
    
    .stage-item {
        min-width: 80px;
        padding: 0.5rem 0.25rem;
    }
    
    .stage-label {
        font-size: 0.625rem;
    }
    
    .stage-desc {
        display: none;
    }
}

@media (max-width: 768px) {
    .meeting-actions {
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .pipeline-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }
    
    .stage-item {
        min-width: 60px;
    }
}
</style>
{% endblock %}

{% block left_sidebar_content %}
<!-- 投資家プロファイル -->
<div class="investor-profile">
    <div class="investor-avatar">
        {{ meeting_data.investor_name[0] }}
    </div>
    <div class="investor-info">
        <h4>{{ meeting_data.investor_name }}</h4>
        <p>{{ meeting_data.investor_type }}</p>
    </div>
</div>
<div class="investor-stats">
    <div class="stat-item">
        <div class="stat-value">12</div>
        <div class="stat-label">総面談回数</div>
    </div>
    <div class="stat-item">
        <div class="stat-value">8.5</div>
        <div class="stat-label">満足度</div>
    </div>
</div>

<h3>📋 過去面談履歴</h3>
<div class="past-meetings">
    <div class="past-meeting" onclick="compareWithPast('2023-10-15')">
        <div class="meeting-date">2023-10-15</div>
        <div class="meeting-topic">Q2決算説明、ESG戦略</div>
        <div class="meeting-score">満足度: 8.2</div>
    </div>
    <div class="past-meeting" onclick="compareWithPast('2023-07-15')">
        <div class="meeting-date">2023-07-15</div>
        <div class="meeting-topic">中期経営計画、M&A戦略</div>
        <div class="meeting-score">満足度: 7.8</div>
    </div>
</div>

<h3>📄 関連資料</h3>
<div class="related-docs">
    <div class="doc-item" onclick="openDocument('q3-earnings')">
        <span class="doc-icon">📊</span>
        <span class="doc-name">Q3決算資料</span>
    </div>
    <div class="doc-item" onclick="openDocument('mid-term-plan')">
        <span class="doc-icon">📈</span>
        <span class="doc-name">中期経営計画</span>
    </div>
    <div class="doc-item" onclick="openDocument('esg-report')">
        <span class="doc-icon">🌱</span>
        <span class="doc-name">ESGレポート</span>
    </div>
</div>
{% endblock %}

{% block main_header %}
<!-- パイプライン進捗バー -->
<div class="pipeline-progress">
    <div class="pipeline-header">
        <div class="meeting-info">
            <h1>{{ meeting_data.title }}</h1>
            <div class="meeting-meta">
                <span>{{ meeting_data.investor_name }}</span>
                <span>•</span>
                <span>{{ meeting_data.formatted_date }}</span>
                <span>•</span>
                <span>{{ meeting_data.type }}</span>
            </div>
        </div>
        <div class="meeting-actions">
            {% if meeting_data.priority == 'high' %}
            <div class="action-badge priority-high">
                🔥 優先度高
            </div>
            {% endif %}
            {% if meeting_data.days_elapsed > 3 %}
            <div class="action-badge days-elapsed">
                ⚠️ {{ meeting_data.days_elapsed }}日経過
            </div>
            {% endif %}
            <button class="btn btn-secondary" onclick="exportData()">
                📤 書き出し
            </button>
        </div>
    </div>
    
    <!-- 段階インジケーター -->
    <div class="stage-pipeline">
        <div class="stages-container">
            {% set stages = [
                {'id': 'upload', 'icon': '📹', 'label': 'ファイル\nアップロード', 'desc': '音声・資料の取り込み'},
                {'id': 'transcription', 'icon': '📝', 'label': '文字起こし\n・編集', 'desc': '音声のテキスト化と編集'},
                {'id': 'ai_summary', 'icon': '🤖', 'label': 'AI要約\n・分析', 'desc': '自動要約と洞察抽出'},
                {'id': 'faq', 'icon': '❓', 'label': 'FAQ\n作成', 'desc': '質疑応答の整理'},
                {'id': 'review', 'icon': '✅', 'label': 'レビュー\n・承認', 'desc': '内容確認と承認'},
                {'id': 'publish', 'icon': '🌐', 'label': '公開\n・配信', 'desc': '最終公開と共有'}
            ] %}
            
            {% for stage in stages %}
            <div class="stage-item {% if stage.id == meeting_data.current_stage %}active{% elif stage.id in meeting_data.completed_stages %}completed{% endif %}" 
                 onclick="switchStage('{{ stage.id }}')">
                <div class="stage-icon">{{ stage.icon }}</div>
                <div class="stage-label">{{ stage.label }}</div>
                <div class="stage-desc">{{ stage.desc }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block main_content %}
<!-- ワークエリアヘッダー -->
<div class="work-area-header">
    <div class="current-stage-info">
        <div class="stage-icon">
            {% if meeting_data.current_stage == 'upload' %}📹
            {% elif meeting_data.current_stage == 'transcription' %}📝
            {% elif meeting_data.current_stage == 'ai_summary' %}🤖
            {% elif meeting_data.current_stage == 'faq' %}❓
            {% elif meeting_data.current_stage == 'review' %}✅
            {% elif meeting_data.current_stage == 'publish' %}🌐
            {% endif %}
        </div>
        <div class="stage-details">
            <h3>
                {% if meeting_data.current_stage == 'upload' %}ファイルアップロード・基本情報
                {% elif meeting_data.current_stage == 'transcription' %}文字起こし・音声編集
                {% elif meeting_data.current_stage == 'ai_summary' %}AI要約・分析
                {% elif meeting_data.current_stage == 'faq' %}FAQ作成・編集
                {% elif meeting_data.current_stage == 'review' %}レビュー・承認
                {% elif meeting_data.current_stage == 'publish' %}公開・配信
                {% endif %}
            </h3>
            <p>
                {% if meeting_data.current_stage_info.message %}
                    {{ meeting_data.current_stage_info.message }}
                {% else %}
                    現在のステップの作業を進めてください
                {% endif %}
            </p>
        </div>
    </div>
    <div class="stage-actions">
        {% if meeting_data.current_stage == 'upload' %}
        <button class="btn btn-primary" onclick="startUpload()">
            📤 アップロード開始
        </button>
        {% elif meeting_data.current_stage == 'transcription' %}
        <button class="btn btn-primary" onclick="startTranscription()">
            🎙️ 文字起こし開始
        </button>
        <button class="btn btn-secondary" onclick="editTranscript()">
            ✏️ 編集
        </button>
        {% elif meeting_data.current_stage == 'ai_summary' %}
        <button class="btn btn-primary" onclick="generateSummary()">
            🤖 要約生成
        </button>
        <button class="btn btn-secondary" onclick="refineSummary()">
            🎨 調整
        </button>
        {% elif meeting_data.current_stage == 'faq' %}
        <button class="btn btn-primary" onclick="createFAQ()">
            ❓ FAQ作成
        </button>
        <button class="btn btn-secondary" onclick="importFAQ()">
            📥 テンプレート取込
        </button>
        {% elif meeting_data.current_stage == 'review' %}
        <button class="btn btn-primary" onclick="approveContent()">
            ✅ 承認
        </button>
        <button class="btn btn-warning" onclick="requestRevision()">
            🔄 修正依頼
        </button>
        {% elif meeting_data.current_stage == 'publish' %}
        <button class="btn btn-primary" onclick="publish()">
            🌐 公開
        </button>
        <button class="btn btn-secondary" onclick="schedulePublish()">
            ⏰ 予約投稿
        </button>
        {% endif %}
    </div>
</div>

<!-- ステージ別コンテンツエリア -->
<div class="stage-content">
    {% if meeting_data.current_stage == 'upload' %}
    <!-- アップロードステージのコンテンツ -->
    <div id="upload-content">
        <div class="upload-area" id="uploadArea">
            <div class="upload-placeholder">
                <span style="font-size: 3rem; color: #d1d5db; margin-bottom: 1rem;">📤</span>
                <p style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">音声ファイルをドラッグ&ドロップ</p>
                <p style="color: #6b7280; margin-bottom: 1rem;">または下のボタンからファイルを選択</p>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    📁 ファイルを選択
                </button>
                <input type="file" id="fileInput" style="display: none;" accept="audio/*,video/*" onchange="handleFileSelect(event)">
            </div>
        </div>
        
        <div class="upload-info">
            <h4>アップロード情報</h4>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">サポート形式</span>
                    <span class="info-value">MP3, MP4, WAV, M4A</span>
                </div>
                <div class="info-item">
                    <span class="info-label">最大サイズ</span>
                    <span class="info-value">500MB</span>
                </div>
                <div class="info-item">
                    <span class="info-label">推奨時間</span>
                    <span class="info-value">～3時間</span>
                </div>
            </div>
        </div>
    </div>
    
    {% elif meeting_data.current_stage == 'transcription' %}
    <!-- 文字起こしステージのコンテンツ -->
    <div id="transcription-content">
        <div class="transcription-editor">
            <div class="editor-toolbar">
                <div class="playback-controls">
                    <button class="control-btn" onclick="togglePlayback()">
                        <span id="playButton">⏸️</span>
                    </button>
                    <div class="time-display">
                        <span id="currentTime">25:30</span> / <span id="totalTime">1:30:45</span>
                    </div>
                    <input type="range" id="progressSlider" min="0" max="5445" value="1530" onchange="seekTo(this.value)">
                    <button class="control-btn" onclick="adjustSpeed()">
                        <span id="speedButton">1.0x</span>
                    </button>
                </div>
                <div class="editing-tools">
                    <button class="tool-btn" onclick="insertTimestamp()">🕐 タイムスタンプ</button>
                    <button class="tool-btn" onclick="insertSpeaker()">👤 話者変更</button>
                    <button class="tool-btn" onclick="markUncertain()">❓ 不明箇所</button>
                </div>
            </div>
            
            <div class="transcript-text">
                <div contenteditable="true" id="transcriptEditor">
                    <p><strong>[00:25:30] 投資家A:</strong> AI事業における御社の競争優位性についてお聞かせください。特に、大手テック企業との差別化要因について詳しく知りたいです。</p>
                    
                    <p><strong>[00:26:15] IR担当者:</strong> ありがとうございます。弊社のAI事業における競争優位性は、主に3つの要素から構成されています。</p>
                    
                    <p><strong>[00:26:30] IR担当者:</strong> 第一に、業界特化型のデータセットの蓄積です。弊社は過去10年間にわたって、製造業向けの専門的なデータを収集・整理してきており、この領域では他社に大きく先行しています。</p>
                    
                    <p><span class="uncertain">[00:27:10] IR担当者: 第二に、※※※※（聞き取れない）※※※※による独自のアルゴリズム開発です。</span></p>
                    
                    <p><strong>[00:27:45] IR担当者:</strong> そして第三に、顧客との密接な関係構築です。我々は単にソフトウェアを提供するのではなく、顧客の業務プロセス全体を理解し、カスタマイズされたソリューションを提供しています。</p>
                </div>
            </div>
        </div>
    </div>
    
    {% elif meeting_data.current_stage == 'ai_summary' %}
    <!-- AI要約ステージのコンテンツ -->
    <div id="ai-summary-content">
        <div class="summary-sections">
            <div class="summary-section">
                <h4>📋 会議要約</h4>
                <div class="summary-text" contenteditable="true">
                    <p><strong>主要議題:</strong> AI事業の競争優位性、ESG戦略の進捗、今後の投資計画</p>
                    
                    <p><strong>キーポイント:</strong></p>
                    <ul>
                        <li>AI事業では業界特化型データセットで競合優位を確立</li>
                        <li>製造業向けソリューションで市場シェア25%を達成</li>
                        <li>ESG投資を今期20%増額、カーボンニュートラル目標を2030年に前倒し</li>
                        <li>新規設備投資により生産効率を15%向上予定</li>
                    </ul>
                    
                    <p><strong>投資家の関心事項:</strong></p>
                    <ul>
                        <li>AI事業の収益性と成長持続性</li>
                        <li>大手テック企業との競争戦略</li>
                        <li>ESG投資のROI測定方法</li>
                        <li>技術者採用計画と人材定着率</li>
                    </ul>
                </div>
            </div>
            
            <div class="summary-section">
                <h4>🎯 アクションアイテム</h4>
                <div class="action-items">
                    <div class="action-item">
                        <div class="action-header">
                            <span class="action-title">追加資料の準備</span>
                            <span class="action-priority high">優先度: 高</span>
                        </div>
                        <div class="action-description">AI事業の詳細なロードマップ資料を次回面談までに準備</div>
                        <div class="action-deadline">期限: 2024-01-15</div>
                    </div>
                    
                    <div class="action-item">
                        <div class="action-header">
                            <span class="action-title">ESG指標の詳細説明</span>
                            <span class="action-priority medium">優先度: 中</span>
                        </div>
                        <div class="action-description">カーボンニュートラル達成のための具体的施策とタイムライン</div>
                        <div class="action-deadline">期限: 2024-01-20</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% elif meeting_data.current_stage == 'faq' %}
    <!-- FAQ作成ステージのコンテンツ -->
    <div id="faq-content">
        <div class="faq-editor">
            <div class="faq-controls">
                <button class="btn btn-primary" onclick="addFAQ()">+ FAQ追加</button>
                <button class="btn btn-secondary" onclick="importTemplate()">📥 テンプレート</button>
                <button class="btn btn-secondary" onclick="sortFAQs()">🔄 並び替え</button>
            </div>
            
            <div class="faq-list">
                <div class="faq-item">
                    <div class="faq-question" contenteditable="true">
                        <strong>Q:</strong> AI事業における御社の競争優位性は何ですか？
                    </div>
                    <div class="faq-answer" contenteditable="true">
                        <strong>A:</strong> 弊社のAI事業における競争優位性は主に3つあります。第一に、10年間蓄積してきた業界特化型データセット、第二に独自のアルゴリズム開発力、第三に顧客との密接な関係構築によるカスタマイズされたソリューション提供です。特に製造業向けでは市場シェア25%を達成しており、大手テック企業とは差別化された競争戦略を展開しています。
                    </div>
                    <div class="faq-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editFAQ(1)">編集</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteFAQ(1)">削除</button>
                    </div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question" contenteditable="true">
                        <strong>Q:</strong> ESG投資の具体的な計画と成果測定方法を教えてください。
                    </div>
                    <div class="faq-answer" contenteditable="true">
                        <strong>A:</strong> 弊社では今期ESG投資を20%増額し、カーボンニュートラル目標を2030年に前倒しで設定しました。具体的施策として、再生可能エネルギーの導入拡大、省エネ設備への投資、サプライチェーン全体でのCO2削減などを推進しています。成果測定については、ISO14001準拠の環境マネジメントシステムを活用し、四半期ごとに進捗を報告しています。
                    </div>
                    <div class="faq-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editFAQ(2)">編集</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteFAQ(2)">削除</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% elif meeting_data.current_stage == 'review' %}
    <!-- レビューステージのコンテンツ -->
    <div id="review-content">
        <div class="review-sections">
            <div class="review-checklist">
                <h4>✅ レビューチェックリスト</h4>
                <div class="checklist-items">
                    <label class="checklist-item">
                        <input type="checkbox" checked>
                        <span>文字起こしの正確性確認</span>
                    </label>
                    <label class="checklist-item">
                        <input type="checkbox" checked>
                        <span>要約内容の妥当性検証</span>
                    </label>
                    <label class="checklist-item">
                        <input type="checkbox">
                        <span>FAQ内容の適切性確認</span>
                    </label>
                    <label class="checklist-item">
                        <input type="checkbox">
                        <span>機密情報の除去確認</span>
                    </label>
                    <label class="checklist-item">
                        <input type="checkbox">
                        <span>法務・コンプライアンスチェック</span>
                    </label>
                </div>
            </div>
            
            <div class="review-comments">
                <h4>💬 レビューコメント</h4>
                <div class="comment-form">
                    <textarea placeholder="レビューコメントを入力してください..." rows="4"></textarea>
                    <button class="btn btn-primary">コメント追加</button>
                </div>
                
                <div class="comment-list">
                    <div class="comment-item">
                        <div class="comment-header">
                            <span class="comment-author">田中 太郎</span>
                            <span class="comment-date">2024-01-10 14:30</span>
                        </div>
                        <div class="comment-content">
                            AI事業の競争優位性の説明で、具体的な数値データをもう少し詳しく記載した方が良いと思います。
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% elif meeting_data.current_stage == 'publish' %}
    <!-- 公開ステージのコンテンツ -->
    <div id="publish-content">
        <div class="publish-options">
            <div class="publish-section">
                <h4>🌐 公開設定</h4>
                <div class="option-group">
                    <label class="option-item">
                        <input type="radio" name="publish-type" value="immediate" checked>
                        <span>即座に公開</span>
                    </label>
                    <label class="option-item">
                        <input type="radio" name="publish-type" value="scheduled">
                        <span>予約投稿</span>
                        <input type="datetime-local" class="schedule-input" style="margin-left: 1rem;">
                    </label>
                </div>
            </div>
            
            <div class="publish-section">
                <h4>👥 公開範囲</h4>
                <div class="option-group">
                    <label class="option-item">
                        <input type="checkbox" checked>
                        <span>投資家向けポータル</span>
                    </label>
                    <label class="option-item">
                        <input type="checkbox">
                        <span>一般向けWebサイト</span>
                    </label>
                    <label class="option-item">
                        <input type="checkbox">
                        <span>メール配信</span>
                    </label>
                </div>
            </div>
            
            <div class="publish-section">
                <h4>📧 通知設定</h4>
                <div class="option-group">
                    <label class="option-item">
                        <input type="checkbox" checked>
                        <span>関係者への通知</span>
                    </label>
                    <label class="option-item">
                        <input type="checkbox">
                        <span>投資家への自動通知</span>
                    </label>
                </div>
            </div>
        </div>
        
        <div class="publish-preview">
            <h4>👀 公開プレビュー</h4>
            <div class="preview-content">
                <iframe src="/preview/{{ meeting_id }}" style="width: 100%; height: 400px; border: 1px solid #e2e8f0; border-radius: 8px;"></iframe>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block right_panel_content %}
<!-- リアルタイムAI提案 -->
<div class="ai-suggestion">
    <div class="suggestion-header">
        <span class="suggestion-title">📝 FAQ候補を検出</span>
        <span class="confidence-badge">信頼度: 94%</span>
    </div>
    <div class="suggestion-content">
        「AI事業の競争優位性について」のFAQを作成することを推奨します。この質問は過去3回の面談でも言及されています。
    </div>
    <div class="suggestion-actions">
        <button class="suggestion-btn primary" onclick="createFAQ('ai_competition')">FAQを作成</button>
        <button class="suggestion-btn secondary" onclick="dismissSuggestion(1)">後で</button>
    </div>
</div>

<div class="ai-suggestion">
    <div class="suggestion-header">
        <span class="suggestion-title">⚠️ 重要な変化を検出</span>
        <span class="confidence-badge">信頼度: 87%</span>
    </div>
    <div class="suggestion-content">
        前回面談と比較して、技術優位性への関心が45%増加しています。追加資料の準備を推奨します。
    </div>
    <div class="suggestion-actions">
        <button class="suggestion-btn primary" onclick="prepareDocument('tech_advantage')">資料準備</button>
        <button class="suggestion-btn secondary" onclick="dismissSuggestion(2)">無視</button>
    </div>
</div>

<!-- AI分析結果 -->
<div style="margin-top: 2rem;">
    <h4 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 1rem; color: #111827;">📊 今回面談の分析</h4>
    <div style="padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <span style="font-size: 0.75rem; color: #6b7280;">感情分析</span>
            <span style="font-size: 0.75rem; font-weight: 600; color: #10b981;">ポジティブ 78%</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <span style="font-size: 0.75rem; color: #6b7280;">関心度</span>
            <span style="font-size: 0.75rem; font-weight: 600; color: #3b82f6;">高 (8.2/10)</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <span style="font-size: 0.75rem; color: #6b7280;">理解度</span>
            <span style="font-size: 0.75rem; font-weight: 600; color: #f59e0b;">中 (6.5/10)</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 0.75rem; color: #6b7280;">満足度</span>
            <span style="font-size: 0.75rem; font-weight: 600; color: #10b981;">高 (7.8/10)</span>
        </div>
    </div>
</div>
{% endblock %}

{% block three_column_extra_js %}
<script>
// グローバル変数
const meetingId = '{{ meeting_id }}';
let currentStage = '{{ meeting_data.current_stage }}';
let isPlaying = false;
let currentTime = 0;
let totalDuration = 5445; // 1:30:45 in seconds
let autoSaveInterval;

// 初期化
document.addEventListener('DOMContentLoaded', function() {
    initializeEditor();
    startAutoSave();
});

// エディター初期化
function initializeEditor() {
    // ステージ固有の初期化処理
    switch(currentStage) {
        case 'upload':
            initializeUpload();
            break;
        case 'transcription':
            initializeTranscription();
            break;
        case 'ai_summary':
            initializeSummary();
            break;
        case 'faq':
            initializeFAQ();
            break;
        case 'review':
            initializeReview();
            break;
        case 'publish':
            initializePublish();
            break;
    }
}

// アップロードステージ初期化
function initializeUpload() {
    const uploadArea = document.getElementById('uploadArea');
    if (uploadArea) {
        // ドラッグ&ドロップイベント
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
    }
}

// 文字起こしステージ初期化
function initializeTranscription() {
    // 音声プレイヤーの初期化
    updateTimeDisplay();
    setInterval(updateProgress, 1000);
}

// 要約ステージ初期化
function initializeSummary() {
    // 要約の自動保存設定
    const summaryTexts = document.querySelectorAll('.summary-text[contenteditable]');
    summaryTexts.forEach(text => {
        text.addEventListener('input', debounce(autoSaveSummary, 2000));
    });
}

// FAQステージ初期化
function initializeFAQ() {
    // FAQ項目のソート機能
    initializeSortable();
}

// レビューステージ初期化
function initializeReview() {
    // チェックリストの進捗更新
    updateReviewProgress();
}

// 公開ステージ初期化
function initializePublish() {
    // プレビューの更新
    refreshPreview();
}

// ステージ切り替え
function switchStage(stageId) {
    if (stageId === currentStage) return;
    
    // 現在の作業を保存
    saveCurrentWork();
    
    // 新しいステージに移動
    window.location.href = `/dialogue/edit?id=${meetingId}&stage=${stageId}`;
}

// 自動保存開始
function startAutoSave() {
    autoSaveInterval = setInterval(autoSave, 30000); // 30秒間隔
}

// 自動保存実行
function autoSave() {
    const data = gatherCurrentData();
    
    fetch(`/api/meetings/${meetingId}/autosave`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification('自動保存しました', 'success');
        }
    })
    .catch(error => {
        console.error('自動保存エラー:', error);
    });
}

// 現在のデータ収集
function gatherCurrentData() {
    const data = {
        stage: currentStage,
        timestamp: new Date().toISOString()
    };
    
    // ステージ別データ収集
    switch(currentStage) {
        case 'transcription':
            data.transcript = document.getElementById('transcriptEditor')?.innerHTML;
            data.currentTime = currentTime;
            break;
        case 'ai_summary':
            data.summary = document.querySelector('.summary-text')?.innerHTML;
            break;
        case 'faq':
            data.faqs = gatherFAQData();
            break;
        case 'review':
            data.checklist = gatherChecklistData();
            data.comments = gatherCommentsData();
            break;
    }
    
    return data;
}

// アップロード関連関数
function handleFileSelect(event) {
    const files = event.target.files;
    if (files.length > 0) {
        uploadFile(files[0]);
    }
}

function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.classList.add('drag-over');
}

function handleDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('drag-over');
    
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        uploadFile(files[0]);
    }
}

function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('meeting_id', meetingId);
    
    // アップロード進捗表示
    showUploadProgress();
    
    fetch('/api/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification('アップロード完了', 'success');
            // 次のステージに進む
            switchStage('transcription');
        } else {
            showNotification('アップロードに失敗しました', 'error');
        }
    })
    .catch(error => {
        console.error('アップロードエラー:', error);
        showNotification('アップロードエラーが発生しました', 'error');
    });
}

// 文字起こし関連関数
function togglePlayback() {
    isPlaying = !isPlaying;
    const playButton = document.getElementById('playButton');
    
    if (isPlaying) {
        playButton.textContent = '⏸️';
        // 実際の音声再生ロジック
    } else {
        playButton.textContent = '▶️';
        // 音声停止ロジック
    }
}

function seekTo(time) {
    currentTime = parseInt(time);
    updateTimeDisplay();
    // 実際のシーク処理
}

function adjustSpeed() {
    // 再生速度調整
    const speedButton = document.getElementById('speedButton');
    const speeds = ['0.5x', '0.75x', '1.0x', '1.25x', '1.5x', '2.0x'];
    const currentSpeed = speedButton.textContent;
    const currentIndex = speeds.indexOf(currentSpeed);
    const nextIndex = (currentIndex + 1) % speeds.length;
    speedButton.textContent = speeds[nextIndex];
}

function updateTimeDisplay() {
    const currentTimeEl = document.getElementById('currentTime');
    const progressSlider = document.getElementById('progressSlider');
    
    if (currentTimeEl) {
        currentTimeEl.textContent = formatTime(currentTime);
    }
    if (progressSlider) {
        progressSlider.value = currentTime;
    }
}

function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const remainingSeconds = seconds % 60;
    
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    } else {
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }
}

// 通知表示
function showNotification(message, type = 'info') {
    // 通知要素を作成
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    // スタイル設定
    Object.assign(notification.style, {
        position: 'fixed',
        top: '1rem',
        right: '1rem',
        padding: '0.75rem 1rem',
        borderRadius: '0.5rem',
        color: 'white',
        fontWeight: '500',
        zIndex: '9999',
        minWidth: '200px',
        textAlign: 'center'
    });
    
    // タイプ別色設定
    switch(type) {
        case 'success':
            notification.style.background = '#10b981';
            break;
        case 'error':
            notification.style.background = '#ef4444';
            break;
        case 'warning':
            notification.style.background = '#f59e0b';
            break;
        default:
            notification.style.background = '#3b82f6';
    }
    
    document.body.appendChild(notification);
    
    // 3秒後に削除
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// デバウンス関数
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// その他のユーティリティ関数
function exportData() {
    const data = gatherCurrentData();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `meeting-${meetingId}-export.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function saveCurrentWork() {
    const data = gatherCurrentData();
    localStorage.setItem(`meeting-${meetingId}-work`, JSON.stringify(data));
}

function compareWithPast(date) {
    window.open(`/compare/${meetingId}/${date}`, '_blank');
}

function openDocument(docId) {
    window.open(`/documents/${docId}`, '_blank');
}
</script>
{% endblock %} 
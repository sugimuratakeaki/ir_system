{% extends "base.html" %}

{% block title %}{{ meeting_data.title }} - 議事録編集{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/ir-management.css">
<style>
/* 統合議事録編集システム専用スタイル */
.unified-editor {
    display: grid;
    grid-template-columns: 300px 1fr 320px;
    grid-template-rows: min-content 1fr;
    height: calc(100vh - 140px);
    gap: 1rem;
    grid-template-areas: 
        "pipeline-header pipeline-header pipeline-header"
        "context-sidebar work-area ai-assistant";
}

/* パイプライン進捗バー（コンパクト版）*/
.pipeline-progress {
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
    color: white;
    border-radius: 8px;
    padding: 1rem 1.5rem;
    margin-bottom: 0.75rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 0;
    z-index: 10;
}

.pipeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.meeting-info h1 {
    font-size: 1.25rem;
    font-weight: bold;
    margin-bottom: 0.25rem;
    line-height: 1.2;
}

.meeting-meta {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    opacity: 0.9;
    font-size: 0.75rem;
}

.meeting-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.action-badge {
    padding: 0.375rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    white-space: nowrap;
}

.action-badge.priority-high {
    background: rgba(239, 68, 68, 0.2);
    color: #fef2f2;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.action-badge.days-elapsed {
    background: rgba(245, 158, 11, 0.2);
    color: #fef3c7;
    border: 1px solid rgba(245, 158, 11, 0.3);
}

/* 段階インジケーター（拡張版） */
.stage-pipeline {
    position: relative;
}

.stage-pipeline::before {
    content: '';
    position: absolute;
    top: 1.25rem;
    left: 0;
    right: 0;
    height: 1px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 1px;
}

.stages-container {
    display: flex;
    justify-content: space-between;
    position: relative;
    z-index: 1;
}

.stage-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0.5rem;
    border-radius: 8px;
}

.stage-item:hover {
    background: rgba(255, 255, 255, 0.1);
}

.stage-indicator {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    font-weight: bold;
    margin-bottom: 0.25rem;
    position: relative;
    transition: all 0.3s ease;
}

.stage-indicator.completed {
    background: #10b981;
    color: white;
    box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
}

.stage-indicator.active {
    background: #f59e0b;
    color: white;
    animation: pulse-ring 2s infinite;
    box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.3);
}

.stage-indicator.processing {
    background: #3b82f6;
    color: white;
    animation: processing-spin 2s linear infinite;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
}

.stage-indicator.inactive {
    background: rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.6);
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.stage-label {
    font-size: 0.625rem;
    font-weight: 600;
    text-align: center;
    opacity: 0.9;
    min-height: 1.5rem;
    display: flex;
    align-items: center;
    line-height: 1.1;
}

.stage-item.current .stage-label {
    opacity: 1;
    font-weight: 700;
}

.stage-progress {
    width: 3rem;
    height: 3px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
    margin-top: 0.25rem;
    overflow: hidden;
}

.stage-progress-fill {
    height: 100%;
    background: #10b981;
    border-radius: 2px;
    transition: width 0.3s ease;
}

/* パイプライン進捗バー */
.pipeline-progress {
    grid-area: pipeline-header;
}

/* サイドバー（投資家情報） */
.context-sidebar {
    grid-area: context-sidebar;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.sidebar-section {
    padding: 1.5rem;
    border-bottom: 1px solid #f3f4f6;
}

.sidebar-section:last-child {
    border-bottom: none;
    flex: 1;
}

.sidebar-section h3 {
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.investor-profile {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.investor-avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3b82f6, #1e40af);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.5rem;
}

.investor-info h4 {
    font-weight: 600;
    color: #111827;
    margin-bottom: 0.25rem;
}

.investor-info p {
    font-size: 0.875rem;
    color: #6b7280;
}

.investor-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.stat-item {
    text-align: center;
    padding: 0.75rem;
    background: #f9fafb;
    border-radius: 8px;
}

.stat-value {
    font-size: 1.25rem;
    font-weight: bold;
    color: #111827;
}

.stat-label {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.25rem;
}

/* メインワークエリア */
.work-area {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.work-area-header {
    background: #f8fafc;
    padding: 1.5rem;
    border-bottom: 2px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.current-stage-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.stage-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: #3b82f6;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.stage-details h3 {
    font-weight: 600;
    color: #111827;
    margin-bottom: 0.25rem;
}

.stage-details p {
    font-size: 0.875rem;
    color: #6b7280;
}

.stage-actions {
    display: flex;
    gap: 0.75rem;
}

.work-area {
    grid-area: work-area;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
    overflow-y: auto;
}

/* AIアシスタントパネル */
.ai-assistant {
    grid-area: ai-assistant;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.ai-header {
    background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
    color: white;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.ai-header h3 {
    font-weight: 600;
    font-size: 1rem;
}

.ai-content {
    flex: 1;
    padding: 1.5rem;
    overflow-y: auto;
}

.ai-suggestion {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    position: relative;
}

.suggestion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.suggestion-title {
    font-weight: 600;
    font-size: 0.875rem;
    color: #111827;
}

.confidence-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    background: #e0f2fe;
    color: #0c4a6e;
}

.suggestion-content {
    font-size: 0.875rem;
    color: #374151;
    line-height: 1.5;
    margin-bottom: 0.75rem;
}

.suggestion-actions {
    display: flex;
    gap: 0.5rem;
}

.suggestion-btn {
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
}

.suggestion-btn.primary {
    background: #3b82f6;
    color: white;
}

.suggestion-btn.primary:hover {
    background: #2563eb;
}

.suggestion-btn.secondary {
    background: #f3f4f6;
    color: #374151;
    border-color: #d1d5db;
}

.suggestion-btn.secondary:hover {
    background: #e5e7eb;
}

/* 段階別コンテンツスタイル */
.stage-content {
    display: none;
}

.stage-content.active {
    display: block;
}

/* Upload Stage */
.upload-area {
    border: 2px dashed #d1d5db;
    border-radius: 12px;
    padding: 3rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover {
    border-color: #3b82f6;
    background: #f8fafc;
}

.upload-area.drag-over {
    border-color: #10b981;
    background: #f0fdf4;
}

.file-list {
    margin-top: 2rem;
}

.file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background: #f9fafb;
    border-radius: 8px;
    margin-bottom: 0.75rem;
}

.file-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.file-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: #3b82f6;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.file-details h4 {
    font-weight: 600;
    color: #111827;
    margin-bottom: 0.25rem;
}

.file-meta {
    font-size: 0.75rem;
    color: #6b7280;
}

/* Transcription Stage */
.transcript-player {
    background: #f8fafc;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.player-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.play-button {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #3b82f6;
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 1.25rem;
    transition: background-color 0.2s;
}

.play-button:hover {
    background: #2563eb;
}

.progress-control {
    flex: 1;
    position: relative;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: #e5e7eb;
    border-radius: 4px;
    cursor: pointer;
    position: relative;
}

.progress-fill {
    height: 100%;
    background: #3b82f6;
    border-radius: 4px;
    width: 25%;
    transition: width 0.1s;
}

.time-display {
    font-family: monospace;
    font-size: 0.875rem;
    color: #6b7280;
    min-width: 100px;
    text-align: right;
}

.transcript-editor {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
}

.transcript-toolbar {
    background: #f9fafb;
    padding: 0.75rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.toolbar-btn {
    padding: 0.375rem 0.75rem;
    border: 1px solid #d1d5db;
    background: white;
    border-radius: 6px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}

.toolbar-btn:hover {
    background: #f3f4f6;
}

.toolbar-btn.active {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.transcript-content {
    max-height: 500px;
    overflow-y: auto;
    padding: 1rem;
}

.transcript-segment {
    margin-bottom: 1.5rem;
    padding: 1rem;
    border-radius: 8px;
    border-left: 3px solid transparent;
    transition: all 0.2s;
    position: relative;
}

.transcript-segment:hover {
    background: #f8fafc;
}

.transcript-segment.highlighted {
    background: #fef3c7;
    border-left-color: #f59e0b;
}

.transcript-segment.important {
    background: #fee2e2;
    border-left-color: #ef4444;
}

.segment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.speaker-name {
    font-weight: 600;
    color: #374151;
    font-size: 0.875rem;
}

.timestamp {
    font-family: monospace;
    font-size: 0.75rem;
    color: #6b7280;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.timestamp:hover {
    background: #e5e7eb;
    color: #3b82f6;
}

.segment-text {
    font-size: 0.875rem;
    line-height: 1.6;
    color: #1f2937;
    margin-bottom: 0.75rem;
}

.segment-actions {
    display: flex;
    gap: 0.5rem;
    opacity: 0;
    transition: opacity 0.2s;
}

.transcript-segment:hover .segment-actions {
    opacity: 1;
}

.segment-btn {
    padding: 0.25rem 0.5rem;
    border: none;
    background: #f3f4f6;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: background-color 0.2s;
}

.segment-btn:hover {
    background: #e5e7eb;
}

/* AI Summary Stage */
.summary-section {
    margin-bottom: 2rem;
}

.summary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.summary-title {
    font-weight: 600;
    font-size: 1.125rem;
    color: #111827;
}

.regenerate-btn {
    padding: 0.5rem 1rem;
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.875rem;
    cursor: pointer;
    transition: background-color 0.2s;
}

.regenerate-btn:hover {
    background: #2563eb;
}

.summary-content {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1.5rem;
}

.summary-textarea {
    width: 100%;
    border: none;
    background: transparent;
    resize: vertical;
    min-height: 120px;
    font-size: 0.875rem;
    line-height: 1.6;
    color: #374151;
}

.summary-textarea:focus {
    outline: none;
}

.key-points {
    margin-top: 2rem;
}

.key-point-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 0.75rem;
}

.key-point-checkbox {
    margin-top: 0.125rem;
}

.key-point-text {
    flex: 1;
    font-size: 0.875rem;
    color: #374151;
    line-height: 1.5;
}

/* フッターアクションバー */
.footer-actions {
    background: white;
    border-top: 1px solid #e5e7eb;
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 0 0 12px 12px;
}

.save-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #6b7280;
}

.save-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #10b981;
}

.save-indicator.saving {
    background: #f59e0b;
    animation: pulse 2s infinite;
}

.action-buttons {
    display: flex;
    gap: 0.75rem;
}

.btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-secondary {
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #d1d5db;
}

.btn-secondary:hover {
    background: #e5e7eb;
}

.btn-primary {
    background: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
}

.btn-success {
    background: #10b981;
    color: white;
}

.btn-success:hover {
    background: #059669;
}

/* アニメーション */
@keyframes pulse-ring {
    0% {
        box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.3);
    }
    50% {
        box-shadow: 0 0 0 8px rgba(245, 158, 11, 0.1);
    }
    100% {
        box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.3);
    }
}

@keyframes processing-spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

/* レスポンシブ対応 */
@media (max-width: 1200px) {
    .main-content {
        grid-template-columns: 250px 1fr 280px;
        gap: 1rem;
    }
}

@media (max-width: 1024px) {
    .main-content {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .context-sidebar,
    .ai-assistant {
        display: none;
    }
}

@media (max-width: 768px) {
    .pipeline-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .meeting-actions {
        justify-content: flex-start;
    }
    
    .stages-container {
        overflow-x: auto;
        padding-bottom: 1rem;
    }
    
    .stage-item {
        min-width: 80px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="unified-editor">
    <!-- パイプライン進捗バー -->
    <div class="pipeline-progress">
        <div class="pipeline-header">
            <div class="meeting-info">
                <h1>{{ meeting_data.title }}</h1>
                <div class="meeting-meta">
                    <span>{{ meeting_data.investor_name }}</span>
                    <span>•</span>
                    <span>{{ meeting_data.formatted_date }}</span>
                    <span>•</span>
                    <span>{{ meeting_data.type }}</span>
                </div>
            </div>
            <div class="meeting-actions">
                {% if meeting_data.priority == 'high' %}
                <div class="action-badge priority-high">
                    🔥 優先度高
                </div>
                {% endif %}
                {% if meeting_data.days_elapsed > 3 %}
                <div class="action-badge days-elapsed">
                    ⚠️ {{ meeting_data.days_elapsed }}日経過
                </div>
                {% endif %}
                <button class="btn btn-secondary" onclick="exportData()">
                    📤 書き出し
                </button>
            </div>
        </div>
        
        <!-- 段階インジケーター -->
        <div class="stage-pipeline">
            <div class="stages-container">
                {% set stages = [
                    {'id': 'upload', 'icon': '📹', 'label': 'ファイル\nアップロード', 'desc': '音声・資料の取り込み'},
                    {'id': 'transcription', 'icon': '📝', 'label': '文字起こし\n・編集', 'desc': '音声のテキスト化と編集'},
                    {'id': 'ai_summary', 'icon': '🤖', 'label': 'AI要約\n・分析', 'desc': '自動要約と洞察抽出'},
                    {'id': 'faq', 'icon': '❓', 'label': 'FAQ\n作成', 'desc': '質疑応答の整理'},
                    {'id': 'review', 'icon': '✅', 'label': 'レビュー\n・承認', 'desc': '内容確認と承認'},
                    {'id': 'publish', 'icon': '🌐', 'label': '公開\n・配信', 'desc': '最終公開と共有'}
                ] %}
                
                {% for stage in stages %}
                <div class="stage-item {{ 'current' if meeting_data.current_stage == stage.id else '' }}" 
                     onclick="switchToStage('{{ stage.id }}')">
                    <div class="stage-indicator 
                        {% if meeting_data.stages[stage.id].status in ['completed', 'approved', 'published'] %}completed
                        {% elif meeting_data.stages[stage.id].status in ['processing', 'in_progress'] %}processing
                        {% elif meeting_data.current_stage == stage.id %}active
                        {% else %}inactive{% endif %}">
                        {% if meeting_data.stages[stage.id].status == 'completed' %}✓
                        {% elif meeting_data.stages[stage.id].status in ['processing', 'in_progress'] %}⟳
                        {% else %}{{ stage.icon }}{% endif %}
                    </div>
                    <div class="stage-label">{{ stage.label }}</div>
                    {% if meeting_data.stages[stage.id].status == 'processing' %}
                    <div class="stage-progress">
                        <div class="stage-progress-fill" style="width: {{ meeting_data.stages[stage.id].progress }}%"></div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- 左サイドバー: 投資家情報・履歴 -->
    <div class="context-sidebar">
            <!-- 投資家プロファイル -->
            <div class="sidebar-section">
                <div class="investor-profile">
                    <div class="investor-avatar">
                        {{ meeting_data.investor_name[0] }}
                    </div>
                    <div class="investor-info">
                        <h4>{{ meeting_data.investor_name }}</h4>
                        <p>{{ meeting_data.investor_type }}</p>
                    </div>
                </div>
                <div class="investor-stats">
                    <div class="stat-item">
                        <div class="stat-value">12</div>
                        <div class="stat-label">総面談回数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">8.5</div>
                        <div class="stat-label">満足度</div>
                    </div>
                </div>
            </div>

            <!-- 過去面談履歴 -->
            <div class="sidebar-section">
                <h3>📋 過去面談履歴</h3>
                <div class="past-meetings">
                    <div class="past-meeting" onclick="compareWithPast('2023-10-15')">
                        <div class="meeting-date">2023-10-15</div>
                        <div class="meeting-topic">Q2決算説明、ESG戦略</div>
                        <div class="meeting-score">満足度: 8.2</div>
                    </div>
                    <div class="past-meeting" onclick="compareWithPast('2023-07-15')">
                        <div class="meeting-date">2023-07-15</div>
                        <div class="meeting-topic">中期経営計画、M&A戦略</div>
                        <div class="meeting-score">満足度: 7.8</div>
                    </div>
                </div>
            </div>

            <!-- 関連資料 -->
            <div class="sidebar-section">
                <h3>📄 関連資料</h3>
                <div class="related-docs">
                    <div class="doc-item" onclick="openDocument('q3-earnings')">
                        <span class="doc-icon">📊</span>
                        <span class="doc-name">Q3決算資料</span>
                    </div>
                    <div class="doc-item" onclick="openDocument('mid-term-plan')">
                        <span class="doc-icon">📈</span>
                        <span class="doc-name">中期経営計画</span>
                    </div>
                    <div class="doc-item" onclick="openDocument('esg-report')">
                        <span class="doc-icon">🌱</span>
                        <span class="doc-name">ESGレポート</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- メインワークエリア -->
        <div class="work-area">
            <!-- ワークエリアヘッダー -->
            <div class="work-area-header">
                <div class="current-stage-info">
                    <div class="stage-icon">
                        {% if meeting_data.current_stage == 'upload' %}📹
                        {% elif meeting_data.current_stage == 'transcription' %}📝
                        {% elif meeting_data.current_stage == 'ai_summary' %}🤖
                        {% elif meeting_data.current_stage == 'faq' %}❓
                        {% elif meeting_data.current_stage == 'review' %}✅
                        {% elif meeting_data.current_stage == 'publish' %}🌐
                        {% endif %}
                    </div>
                    <div class="stage-details">
                        <h3>
                            {% if meeting_data.current_stage == 'upload' %}ファイルアップロード・基本情報
                            {% elif meeting_data.current_stage == 'transcription' %}文字起こし・音声編集
                            {% elif meeting_data.current_stage == 'ai_summary' %}AI要約・分析
                            {% elif meeting_data.current_stage == 'faq' %}FAQ作成・編集
                            {% elif meeting_data.current_stage == 'review' %}レビュー・承認
                            {% elif meeting_data.current_stage == 'publish' %}公開・配信
                            {% endif %}
                        </h3>
                        <p>
                            {% if meeting_data.current_stage_info.message %}
                                {{ meeting_data.current_stage_info.message }}
                            {% else %}
                                現在のステップの作業を進めてください
                            {% endif %}
                        </p>
                    </div>
                </div>
                <div class="stage-actions">
                    {% if meeting_data.current_stage == 'upload' %}
                    <button class="btn btn-primary" onclick="startUpload()">
                        📁 ファイル選択
                    </button>
                    {% elif meeting_data.current_stage == 'transcription' %}
                    <button class="btn btn-secondary" onclick="togglePlayback()">
                        ▶️ 再生/停止
                    </button>
                    <button class="btn btn-primary" onclick="saveTranscript()">
                        💾 保存
                    </button>
                    {% elif meeting_data.current_stage == 'ai_summary' %}
                    <button class="btn btn-secondary" onclick="regenerateSummary()">
                        🔄 再生成
                    </button>
                    <button class="btn btn-primary" onclick="approveSummary()">
                        ✅ 承認
                    </button>
                    {% elif meeting_data.current_stage == 'faq' %}
                    <button class="btn btn-secondary" onclick="generateMoreFAQs()">
                        ➕ FAQ追加
                    </button>
                    <button class="btn btn-primary" onclick="completeFAQs()">
                        ✅ 完了
                    </button>
                    {% elif meeting_data.current_stage == 'review' %}
                    <button class="btn btn-secondary" onclick="requestChanges()">
                        📝 修正依頼
                    </button>
                    <button class="btn btn-primary" onclick="approveReview()">
                        ✅ 承認
                    </button>
                    {% elif meeting_data.current_stage == 'publish' %}
                    <button class="btn btn-secondary" onclick="schedulePublish()">
                        📅 予約公開
                    </button>
                    <button class="btn btn-success" onclick="publishNow()">
                        🌐 即座に公開
                    </button>
                    {% endif %}
                </div>
            </div>

            <!-- 動的コンテンツエリア -->
        <!-- ワークエリア: 段階別コンテンツ -->
    <div class="work-area">
                <!-- Upload Stage Content -->
                <div id="upload-content" class="stage-content {{ 'active' if meeting_data.current_stage == 'upload' else '' }}">
                    <div class="upload-area" onclick="selectFiles()" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📁</div>
                        <h3>ファイルをアップロード</h3>
                        <p>音声・動画ファイルや関連資料をドラッグ&ドロップまたはクリックして選択</p>
                        <p style="margin-top: 1rem; color: #6b7280; font-size: 0.875rem;">
                            対応形式: MP4, MP3, WAV, PDF (最大500MB)
                        </p>
                    </div>
                    
                    {% if meeting_data.files %}
                    <div class="file-list">
                        <h4 style="margin-bottom: 1rem;">アップロード済みファイル</h4>
                        {% for file in meeting_data.files %}
                        <div class="file-item">
                            <div class="file-info">
                                <div class="file-icon">
                                    {% if file.type == 'video' %}🎥
                                    {% elif file.type == 'audio' %}🎵
                                    {% else %}📄{% endif %}
                                </div>
                                <div class="file-details">
                                    <h4>{{ file.name }}</h4>
                                    <div class="file-meta">
                                        {{ file.size }}
                                        {% if file.duration %} • {{ file.duration }}{% endif %}
                                        {% if file.transcription_accuracy %} • 認識精度: {{ file.transcription_accuracy }}%{% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="file-actions">
                                <button class="btn btn-secondary" onclick="downloadFile('{{ file.id }}')">
                                    📥 ダウンロード
                                </button>
                                <button class="btn btn-secondary" onclick="deleteFile('{{ file.id }}')">
                                    🗑️ 削除
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- 基本情報入力フォーム -->
                    <div style="margin-top: 2rem;">
                        <h4 style="margin-bottom: 1rem;">基本情報</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">会議種別</label>
                                <select class="form-control">
                                    <option>個別面談</option>
                                    <option>決算説明会</option>
                                    <option>スモールミーティング</option>
                                    <option>カンファレンス</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">優先度</label>
                                <select class="form-control">
                                    <option value="high">高</option>
                                    <option value="medium">中</option>
                                    <option value="low">低</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transcription Stage Content -->
                <div id="transcription-content" class="stage-content {{ 'active' if meeting_data.current_stage == 'transcription' else '' }}">
                    <!-- 音声プレイヤー -->
                    <div class="transcript-player">
                        <div class="player-controls">
                            <button class="play-button" onclick="togglePlayback()">
                                <span id="play-icon">▶️</span>
                            </button>
                            <div class="progress-control">
                                <div class="progress-bar" onclick="seekAudio(event)">
                                    <div class="progress-fill" id="progress-fill"></div>
                                </div>
                            </div>
                            <div class="time-display">
                                <span id="current-time">12:34</span> / <span id="total-time">1:30:45</span>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                            <div style="font-size: 0.875rem; color: #6b7280;">
                                🎤 高音質録音 | 認識精度: 96%
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary" onclick="setPlaybackSpeed(0.75)">0.75x</button>
                                <button class="btn btn-secondary active" onclick="setPlaybackSpeed(1.0)">1.0x</button>
                                <button class="btn btn-secondary" onclick="setPlaybackSpeed(1.25)">1.25x</button>
                                <button class="btn btn-secondary" onclick="setPlaybackSpeed(1.5)">1.5x</button>
                            </div>
                        </div>
                    </div>

                    <!-- 文字起こしエディタ -->
                    <div class="transcript-editor">
                        <div class="transcript-toolbar">
                            <button class="toolbar-btn" onclick="highlightMode()">🖍️ ハイライト</button>
                            <button class="toolbar-btn" onclick="importantMode()">⭐ 重要</button>
                            <button class="toolbar-btn" onclick="speakerMode()">👤 話者</button>
                            <button class="toolbar-btn" onclick="searchMode()">🔍 検索</button>
                            <div style="margin-left: auto; font-size: 0.75rem; color: #6b7280;">
                                総文字数: 15,680文字 | 読了時間: 約12分
                            </div>
                        </div>
                        
                        <div class="transcript-content">
                            {% if meeting_data.transcript_preview %}
                            {% set segments = meeting_data.transcript_preview.split('\n\n') %}
                            {% for segment in segments %}
                            {% if segment.strip() %}
                            <div class="transcript-segment" data-timestamp="00:{{ loop.index }}:{{ loop.index * 5 }}">
                                <div class="segment-header">
                                    <span class="speaker-name">
                                        {% if '田中（CEO）' in segment %}田中（CEO）
                                        {% elif '佐藤（CFO）' in segment %}佐藤（CFO）
                                        {% elif '投資家' in segment %}投資家（{{ meeting_data.investor_name }}）
                                        {% else %}発言者{% endif %}
                                    </span>
                                    <span class="timestamp" onclick="jumpToTime('00:{{ loop.index }}:{{ loop.index * 5 }}')">
                                        {{ loop.index }}:{{ '%02d'|format(loop.index * 5) }}
                                    </span>
                                </div>
                                <div class="segment-text" contenteditable="true">
                                    {{ segment.replace('【田中（CEO）】', '').replace('【佐藤（CFO）】', '').replace('【投資家】', '').strip() }}
                                </div>
                                <div class="segment-actions">
                                    <button class="segment-btn" onclick="highlightSegment(this)">ハイライト</button>
                                    <button class="segment-btn" onclick="markImportant(this)">重要</button>
                                    <button class="segment-btn" onclick="addNote(this)">メモ</button>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                            {% else %}
                            <div style="text-align: center; padding: 3rem; color: #6b7280;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">📝</div>
                                <h3>文字起こしを開始してください</h3>
                                <p>音声ファイルがアップロードされたら、AI文字起こしを開始できます。</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- AI Summary Stage Content -->
                <div id="ai-summary-content" class="stage-content {{ 'active' if meeting_data.current_stage == 'ai_summary' else '' }}">
                    <!-- エグゼクティブサマリー -->
                    <div class="summary-section">
                        <div class="summary-header">
                            <h3 class="summary-title">📊 エグゼクティブサマリー</h3>
                            <button class="regenerate-btn" onclick="regenerateSummary('executive')">
                                🤖 AI再生成
                            </button>
                        </div>
                        <div class="summary-content">
                            <textarea class="summary-textarea" placeholder="AIがエグゼクティブサマリーを生成中...">第3四半期の業績は全体的に好調で、特にAI事業が予想を上回る成長を示しました。投資家からは競争優位性とESG目標について高い関心が寄せられ、具体的なロードマップの提示が求められました。</textarea>
                        </div>
                    </div>

                    <!-- 重要ポイント -->
                    <div class="summary-section">
                        <div class="summary-header">
                            <h3 class="summary-title">🔑 重要ポイント</h3>
                            <button class="regenerate-btn" onclick="regenerateKeyPoints()">
                                🎯 自動抽出
                            </button>
                        </div>
                        <div class="key-points">
                            <div class="key-point-item">
                                <input type="checkbox" class="key-point-checkbox" checked>
                                <span class="key-point-text">AI事業の売上が前年同期比150%成長</span>
                            </div>
                            <div class="key-point-item">
                                <input type="checkbox" class="key-point-checkbox" checked>
                                <span class="key-point-text">特許技術47件取得、業界リーデイングポジション</span>
                            </div>
                            <div class="key-point-item">
                                <input type="checkbox" class="key-point-checkbox">
                                <span class="key-point-text">ESGロードマップを2月末に公表予定</span>
                            </div>
                            <div class="key-point-item">
                                <input type="checkbox" class="key-point-checkbox">
                                <span class="key-point-text">競合優位性: 特許技術、データ資産、パートナーシップ</span>
                            </div>
                        </div>
                    </div>

                    <!-- 投資家の関心・懸念事項 -->
                    <div class="summary-section">
                        <div class="summary-header">
                            <h3 class="summary-title">💭 投資家の関心・懸念事項</h3>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 0.875rem; color: #ef4444;">懸念度: 高</span>
                            </div>
                        </div>
                        <div class="concerns-list">
                            <div class="concern-item" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: white;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600; color: #111827;">AI事業の競争優位性</span>
                                    <span style="padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; background: #fef2f2; color: #dc2626;">高</span>
                                </div>
                                <div style="font-size: 0.875rem; color: #374151; margin-bottom: 0.75rem;">
                                    競合他社との差別化要因、技術的優位性の持続可能性について詳細な説明を求められました。
                                </div>
                                <div style="font-size: 0.875rem; color: #1f2937; background: #f8fafc; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #3b82f6;">
                                    <strong>回答要点:</strong> 47件の特許技術、独自アルゴリズム、業界リーディングポジション
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FAQ Stage Content -->
                <div id="faq-content" class="stage-content {{ 'active' if meeting_data.current_stage == 'faq' else '' }}">
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">❓</div>
                        <h3>FAQ作成・編集</h3>
                        <p>AI分析結果からFAQを自動生成し、編集・承認を行います。</p>
                        <button class="btn btn-primary" style="margin-top: 1rem;" onclick="openFAQEditor()">
                            📝 FAQ編集画面を開く
                        </button>
                    </div>
                </div>

                <!-- Review Stage Content -->
                <div id="review-content" class="stage-content {{ 'active' if meeting_data.current_stage == 'review' else '' }}">
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">✅</div>
                        <h3>最終レビュー・承認</h3>
                        <p>作成された議事録、要約、FAQの最終確認を行います。</p>
                        <button class="btn btn-primary" style="margin-top: 1rem;" onclick="startReview()">
                            📋 レビューを開始
                        </button>
                    </div>
                </div>

                <!-- Publish Stage Content -->
                <div id="publish-content" class="stage-content {{ 'active' if meeting_data.current_stage == 'publish' else '' }}">
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🌐</div>
                        <h3>公開・配信設定</h3>
                        <p>承認された内容を適切なチャネルに公開・配信します。</p>
                        <button class="btn btn-success" style="margin-top: 1rem;" onclick="openPublishSettings()">
                            📤 公開設定を開く
                        </button>
                    </div>
                </div>
            </div>

            <!-- フッターアクションバー -->
            <div class="footer-actions">
                <div class="save-status">
                    <div class="save-indicator"></div>
                    <span>最終保存: {{ current_time }}</span>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="saveDraft()">
                        💾 下書き保存
                    </button>
                    <button class="btn btn-secondary" onclick="shareWithTeam()">
                        👥 チーム共有
                    </button>
                    <button class="btn btn-primary" onclick="proceedToNext()">
                        ➡️ 次のステップ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 右サイドバー: AIアシスタント -->
    <div class="ai-assistant">
            <div class="ai-header">
                <span style="font-size: 1.5rem;">🤖</span>
                <h3>AIアシスタント</h3>
            </div>
            <div class="ai-content">
                <!-- リアルタイムAI提案 -->
                <div class="ai-suggestion">
                    <div class="suggestion-header">
                        <span class="suggestion-title">📝 FAQ候補を検出</span>
                        <span class="confidence-badge">信頼度: 94%</span>
                    </div>
                    <div class="suggestion-content">
                        「AI事業の競争優位性について」のFAQを作成することを推奨します。この質問は過去3回の面談でも言及されています。
                    </div>
                    <div class="suggestion-actions">
                        <button class="suggestion-btn primary" onclick="createFAQ('ai_competition')">FAQを作成</button>
                        <button class="suggestion-btn secondary" onclick="dismissSuggestion(1)">後で</button>
                    </div>
                </div>

                <div class="ai-suggestion">
                    <div class="suggestion-header">
                        <span class="suggestion-title">⚠️ 重要な変化を検出</span>
                        <span class="confidence-badge">信頼度: 87%</span>
                    </div>
                    <div class="suggestion-content">
                        前回面談と比較して、技術優位性への関心が45%増加しています。追加資料の準備を推奨します。
                    </div>
                    <div class="suggestion-actions">
                        <button class="suggestion-btn primary" onclick="prepareDocument('tech_advantage')">資料準備</button>
                        <button class="suggestion-btn secondary" onclick="dismissSuggestion(2)">無視</button>
                    </div>
                </div>

                <!-- AI分析結果 -->
                <div style="margin-top: 2rem;">
                    <h4 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 1rem; color: #111827;">📊 今回面談の分析</h4>
                    <div style="padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-size: 0.75rem; color: #6b7280;">感情分析</span>
                            <span style="font-size: 0.75rem; font-weight: 600; color: #10b981;">ポジティブ 78%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-size: 0.75rem; color: #6b7280;">関心度</span>
                            <span style="font-size: 0.75rem; font-weight: 600; color: #3b82f6;">高 (8.2/10)</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-size: 0.75rem; color: #6b7280;">理解度</span>
                            <span style="font-size: 0.75rem; font-weight: 600; color: #f59e0b;">中 (6.5/10)</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.75rem; color: #6b7280;">満足度</span>
                            <span style="font-size: 0.75rem; font-weight: 600; color: #10b981;">高 (7.8/10)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// グローバル変数
const meetingId = '{{ meeting_id }}';
let currentStage = '{{ meeting_data.current_stage }}';
let isPlaying = false;
let currentTime = 0;
let totalDuration = 5445; // 1:30:45 in seconds
let autoSaveInterval;

// 初期化
document.addEventListener('DOMContentLoaded', function() {
    initializeEditor();
    startAutoSave();
});

function initializeEditor() {
    // 現在のステージに応じたコンテンツ表示
    showStageContent(currentStage);
    
    // キーボードショートカット
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 's':
                    e.preventDefault();
                    saveDraft();
                    break;
                case 'f':
                    e.preventDefault();
                    openSearch();
                    break;
                case ' ':
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        togglePlayback();
                    }
                    break;
            }
        }
    });
}

function startAutoSave() {
    autoSaveInterval = setInterval(function() {
        saveDraft(true); // silent save
    }, 30000); // 30秒ごと
}

// ステージ切り替え
function switchToStage(stageId) {
    // 権限チェック（実際の実装では必要）
    if (!canAccessStage(stageId)) {
        showNotification('このステージにはまだアクセスできません', 'warning');
        return;
    }
    
    currentStage = stageId;
    showStageContent(stageId);
    updateStageUI(stageId);
    showNotification(`${getStageLabel(stageId)}に切り替えました`, 'info');
}

function showStageContent(stageId) {
    // すべてのコンテンツを非表示
    document.querySelectorAll('.stage-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // 指定されたステージのコンテンツを表示
    const targetContent = document.getElementById(stageId + '-content');
    if (targetContent) {
        targetContent.classList.add('active');
    }
}

function updateStageUI(stageId) {
    // ステージインジケーターの更新
    document.querySelectorAll('.stage-item').forEach(item => {
        item.classList.remove('current');
    });
    
    const currentStageItem = document.querySelector(`[onclick="switchToStage('${stageId}')"]`);
    if (currentStageItem) {
        currentStageItem.classList.add('current');
    }
}

function canAccessStage(stageId) {
    // 実際の実装では、前のステージが完了しているかチェック
    return true;
}

function getStageLabel(stageId) {
    const labels = {
        'upload': 'ファイルアップロード',
        'transcription': '文字起こし・編集',
        'ai_summary': 'AI要約・分析',
        'faq': 'FAQ作成',
        'review': 'レビュー・承認',
        'publish': '公開・配信'
    };
    return labels[stageId] || stageId;
}

// ファイル操作
function selectFiles() {
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.accept = 'video/*,audio/*,.pdf';
    input.onchange = handleFileSelect;
    input.click();
}

function handleFileSelect(event) {
    const files = event.target.files;
    if (files.length > 0) {
        showNotification(`${files.length}個のファイルをアップロード中...`, 'info');
        // 実際のアップロード処理
        uploadFiles(files);
    }
}

function handleDrop(event) {
    event.preventDefault();
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        handleFileSelect({target: {files: files}});
    }
}

function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.classList.add('drag-over');
}

function uploadFiles(files) {
    // ファイルアップロードの実装
    Array.from(files).forEach(file => {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('meeting_id', meetingId);
        
        // 実際のアップロード処理（フェッチAPI等）
        fetch('/api/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            showNotification(`${file.name} のアップロードが完了しました`, 'success');
        })
        .catch(error => {
            showNotification(`${file.name} のアップロードに失敗しました`, 'error');
        });
    });
}

// 音声プレイヤー機能
function togglePlayback() {
    isPlaying = !isPlaying;
    const playIcon = document.getElementById('play-icon');
    if (playIcon) {
        playIcon.textContent = isPlaying ? '⏸️' : '▶️';
    }
    
    if (isPlaying) {
        startPlaybackTimer();
    } else {
        stopPlaybackTimer();
    }
    
    showNotification(isPlaying ? '再生開始' : '再生停止', 'info');
}

function startPlaybackTimer() {
    window.playbackTimer = setInterval(function() {
        currentTime += 1;
        if (currentTime >= totalDuration) {
            currentTime = totalDuration;
            togglePlayback();
        }
        updateTimeDisplay();
        updateProgressBar();
    }, 1000);
}

function stopPlaybackTimer() {
    if (window.playbackTimer) {
        clearInterval(window.playbackTimer);
    }
}

function updateTimeDisplay() {
    const currentTimeElement = document.getElementById('current-time');
    const totalTimeElement = document.getElementById('total-time');
    
    if (currentTimeElement) {
        currentTimeElement.textContent = formatTime(currentTime);
    }
    if (totalTimeElement) {
        totalTimeElement.textContent = formatTime(totalDuration);
    }
}

function updateProgressBar() {
    const progressFill = document.getElementById('progress-fill');
    if (progressFill) {
        const percentage = (currentTime / totalDuration) * 100;
        progressFill.style.width = percentage + '%';
    }
}

function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
}

function seekAudio(event) {
    const progressBar = event.currentTarget;
    const rect = progressBar.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const percentage = clickX / rect.width;
    
    currentTime = totalDuration * percentage;
    updateTimeDisplay();
    updateProgressBar();
}

function jumpToTime(timestamp) {
    // タイムスタンプ解析
    const parts = timestamp.split(':').map(Number);
    let seconds = 0;
    
    if (parts.length === 2) {
        seconds = parts[0] * 60 + parts[1];
    } else if (parts.length === 3) {
        seconds = parts[0] * 3600 + parts[1] * 60 + parts[2];
    }
    
    currentTime = seconds;
    updateTimeDisplay();
    updateProgressBar();
    showNotification(`⏭️ ${timestamp} にジャンプしました`, 'info');
}

function setPlaybackSpeed(speed) {
    // 再生速度設定
    document.querySelectorAll('.btn-secondary').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    showNotification(`再生速度を ${speed}x に変更しました`, 'info');
}

// 文字起こし編集機能
function highlightSegment(button) {
    const segment = button.closest('.transcript-segment');
    segment.classList.toggle('highlighted');
    showNotification(segment.classList.contains('highlighted') ? 'ハイライトしました' : 'ハイライトを解除しました', 'success');
}

function markImportant(button) {
    const segment = button.closest('.transcript-segment');
    segment.classList.toggle('important');
    showNotification(segment.classList.contains('important') ? '重要箇所にマークしました' : '重要マークを解除しました', 'success');
}

function addNote(button) {
    const segment = button.closest('.transcript-segment');
    const noteText = prompt('メモを入力してください:');
    if (noteText) {
        // メモ要素を追加
        let noteElement = segment.querySelector('.segment-note');
        if (!noteElement) {
            noteElement = document.createElement('div');
            noteElement.className = 'segment-note';
            noteElement.style.cssText = 'margin-top: 0.5rem; padding: 0.5rem; background: #fef3c7; border-radius: 4px; border-left: 3px solid #f59e0b;';
            segment.appendChild(noteElement);
        }
        noteElement.innerHTML = `<span style="font-weight: 600; color: #92400e; font-size: 0.75rem;">📝 メモ:</span> <span style="color: #451a03; font-size: 0.75rem;">${noteText}</span>`;
        showNotification('メモを追加しました', 'success');
    }
}

// AI機能
function regenerateSummary(type) {
    showNotification('AI要約を再生成中...', 'info');
    setTimeout(function() {
        showNotification('AI要約を更新しました', 'success');
    }, 3000);
}

function regenerateKeyPoints() {
    showNotification('重要ポイントを自動抽出中...', 'info');
    setTimeout(function() {
        showNotification('重要ポイントを更新しました', 'success');
    }, 2000);
}

// ナビゲーション機能
function proceedToNext() {
    const stages = ['upload', 'transcription', 'ai_summary', 'faq', 'review', 'publish'];
    const currentIndex = stages.indexOf(currentStage);
    if (currentIndex < stages.length - 1) {
        switchToStage(stages[currentIndex + 1]);
    } else {
        showNotification('最後のステップです', 'info');
    }
}

function saveDraft(silent = false) {
    const saveIndicator = document.querySelector('.save-indicator');
    if (saveIndicator) {
        saveIndicator.classList.add('saving');
    }
    
    // 保存処理のシミュレーション
    setTimeout(function() {
        if (saveIndicator) {
            saveIndicator.classList.remove('saving');
        }
        if (!silent) {
            showNotification('下書きを保存しました', 'success');
        }
    }, 1000);
}

function shareWithTeam() {
    showNotification('チーム共有機能を開発中...', 'info');
}

function exportData() {
    showNotification('データを書き出し中...', 'info');
    setTimeout(function() {
        showNotification('書き出しが完了しました', 'success');
    }, 2000);
}

// FAQ関連機能
function openFAQEditor() {
    window.location.href = `/dialogue/faq/${meetingId}`;
}

function createFAQ(topic) {
    showNotification('FAQ作成画面を開いています...', 'info');
    setTimeout(function() {
        window.location.href = `/dialogue/faq/${meetingId}?topic=${topic}`;
    }, 1000);
}

// AI提案機能
function dismissSuggestion(id) {
    const suggestions = document.querySelectorAll('.ai-suggestion');
    if (suggestions[id - 1]) {
        suggestions[id - 1].style.display = 'none';
        showNotification('提案を無視しました', 'info');
    }
}

function prepareDocument(type) {
    showNotification('資料準備を開始しました', 'success');
}

// 比較・履歴機能
function compareWithPast(date) {
    showNotification(`${date}の面談データと比較中...`, 'info');
    setTimeout(function() {
        // 比較結果を表示（実装例）
        showNotification('比較結果をAIパネルに表示しました', 'success');
    }, 1500);
}

function openDocument(docId) {
    window.open(`/documents/${docId}`, '_blank');
}

// 通知機能
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg z-50 transform transition-all duration-300';
    
    const colors = {
        success: 'bg-green-500 text-white',
        error: 'bg-red-500 text-white',
        warning: 'bg-yellow-500 text-white',
        info: 'bg-blue-500 text-white'
    };
    
    notification.className += ' ' + (colors[type] || colors.info);
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // アニメーション
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    // 3秒後に削除
    setTimeout(() => {
        notification.style.transform = 'translateX(400px)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// ステージ特化アクション
function startUpload() {
    selectFiles();
}

function saveTranscript() {
    showNotification('文字起こしを保存しました', 'success');
}

function approveSummary() {
    showNotification('AI要約を承認しました', 'success');
    switchToStage('faq');
}

function completeFAQs() {
    showNotification('FAQ作成を完了しました', 'success');
    switchToStage('review');
}

function approveReview() {
    showNotification('レビューを承認しました', 'success');
    switchToStage('publish');
}

function publishNow() {
    if (confirm('議事録を公開しますか？')) {
        showNotification('議事録を公開しました', 'success');
    }
}

function openPublishSettings() {
    window.location.href = `/dialogue/publish?id=${meetingId}`;
}

function schedulePublish() {
    openPublishSettings();
}

// 処理中ステージの自動更新
if (document.querySelector('.processing')) {
    setInterval(function() {
        // 実際の実装では進捗APIをチェック
        location.reload();
    }, 30000);
}
</script>
{% endblock %} 
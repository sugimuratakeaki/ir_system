{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<!-- メインヘッダー -->
<div class="mb-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">ミーティング処理ダッシュボード</h1>
            <p class="text-sm text-gray-600 mt-1">打ち合わせから投資家公開までの全プロセスを管理</p>
        </div>
        <div class="flex items-center space-x-3">
            <div class="text-right">
                <p class="text-sm text-gray-500">現在時刻</p>
                <p class="text-lg font-semibold" id="current-time">{{ current_time }}</p>
            </div>
            <button class="btn btn-primary" onclick="showUploadModal()">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                新規ミーティング登録
            </button>
        </div>
    </div>
</div>

<!-- アラートセクション -->
{% if urgent_meetings %}
<div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg mb-6">
    <div class="flex items-start">
        <svg class="w-5 h-5 text-red-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
        </svg>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-red-800">{{ urgent_meetings|length }}件の緊急対応が必要です</h3>
            <p class="text-sm text-red-700 mt-1">72時間以上処理が停滞しているミーティングがあります</p>
        </div>
    </div>
</div>
{% endif %}

<!-- ミーティング処理パイプライン -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
    <div class="bg-gradient-to-r from-kagami-blue to-kagami-blue-dark p-4">
        <h2 class="text-lg font-semibold text-white flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            処理中のミーティング（{{ active_meetings|length }}件）
        </h2>
    </div>
    
    <!-- パイプラインビュー -->
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">
                        ミーティング情報
                    </th>
                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                        📹 データ<br>アップロード
                    </th>
                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                        📝 文字起こし
                    </th>
                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                        🤖 AI要約
                    </th>
                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                        ❓ FAQ作成
                    </th>
                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                        ✅ レビュー
                    </th>
                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                        🌐 公開
                    </th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
                        アクション
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for meeting in active_meetings %}
                <tr class="hover:bg-gray-50 {% if meeting.is_urgent %}bg-red-50{% endif %}">
                    <!-- ミーティング情報 -->
                    <td class="px-4 py-4">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                {% if meeting.priority == 'high' %}
                                <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                                {% elif meeting.priority == 'medium' %}
                                <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
                                {% else %}
                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                {% endif %}
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 truncate">
                                    {{ meeting.title }}
                                </p>
                                <p class="text-xs text-gray-500">
                                    {{ meeting.investor_name }}
                                    {% if meeting.investor_type == '大口機関投資家' %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 ml-1">
                                        VIP
                                    </span>
                                    {% endif %}
                                </p>
                                <p class="text-xs text-gray-400 mt-1">
                                    {{ meeting.date }} | {{ meeting.duration }}
                                </p>
                                {% if meeting.days_elapsed > 3 %}
                                <p class="text-xs text-red-600 font-medium mt-1">
                                    ⚠️ {{ meeting.days_elapsed }}日経過
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    
                    <!-- データアップロード -->
                    <td class="px-3 py-4 text-center">
                        {% if meeting.stages.upload.status == 'completed' %}
                        <div class="inline-flex flex-col items-center">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </div>
                            <span class="text-xs text-gray-600 mt-1">完了</span>
                            <div class="flex mt-1 space-x-1">
                                {% for file_type in meeting.stages.upload.files %}
                                <span class="text-xs">{{ file_type }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% elif meeting.stages.upload.status == 'pending' %}
                        <div class="inline-flex flex-col items-center">
                            <button class="w-10 h-10 bg-blue-500 hover:bg-blue-600 text-white rounded-full flex items-center justify-center transition-colors" onclick="uploadFiles('{{ meeting.id }}')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                            </button>
                            <span class="text-xs text-gray-600 mt-1">アップロード</span>
                        </div>
                        {% else %}
                        <div class="inline-flex flex-col items-center">
                            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                                <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            </div>
                            <span class="text-xs text-gray-400 mt-1">待機中</span>
                        </div>
                        {% endif %}
                    </td>
                    
                    <!-- 文字起こし -->
                    <td class="px-3 py-4 text-center">
                        {% if meeting.stages.transcription.status == 'completed' %}
                        <div class="inline-flex flex-col items-center">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </div>
                            <span class="text-xs text-gray-600 mt-1">完了</span>
                            <span class="text-xs text-gray-400">{{ meeting.stages.transcription.duration }}</span>
                        </div>
                        {% elif meeting.stages.transcription.status == 'processing' %}
                        <div class="inline-flex flex-col items-center">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center animate-pulse">
                                <svg class="w-5 h-5 text-blue-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                            </div>
                            <span class="text-xs text-gray-600 mt-1">処理中</span>
                            <div class="w-24 bg-gray-200 rounded-full h-1 mt-1">
                                <div class="bg-blue-600 h-1 rounded-full" style="width: {{ meeting.stages.transcription.progress }}%"></div>
                            </div>
                        </div>
                        {% elif meeting.stages.transcription.status == 'ready' %}
                        <div class="inline-flex flex-col items-center">
                            <button class="w-10 h-10 bg-blue-500 hover:bg-blue-600 text-white rounded-full flex items-center justify-center transition-colors" onclick="startTranscription('{{ meeting.id }}')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </button>
                            <span class="text-xs text-gray-600 mt-1">開始</span>
                        </div>
                        {% else %}
                        <div class="inline-flex flex-col items-center">
                            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                                <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            </div>
                            <span class="text-xs text-gray-400 mt-1">待機中</span>
                        </div>
                        {% endif %}
                    </td>
                    
                    <!-- AI要約 -->
                    <td class="px-3 py-4 text-center">
                        {% if meeting.stages.ai_summary.status == 'completed' %}
                        <div class="inline-flex flex-col items-center">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </div>
                            <span class="text-xs text-gray-600 mt-1">完了</span>
                            <button class="text-xs text-blue-600 hover:text-blue-700 mt-1" onclick="viewSummary('{{ meeting.id }}')">
                                要約を見る
                            </button>
                        </div>
                        {% elif meeting.stages.ai_summary.status == 'processing' %}
                        <div class="inline-flex flex-col items-center">
                            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center animate-pulse">
                                <span class="text-lg">🤖</span>
                            </div>
                            <span class="text-xs text-gray-600 mt-1">AI処理中</span>
                        </div>
                        {% elif meeting.stages.ai_summary.status == 'ready' %}
                        <div class="inline-flex flex-col items-center">
                            <button class="w-10 h-10 bg-purple-500 hover:bg-purple-600 text-white rounded-full flex items-center justify-center transition-colors" onclick="startAISummary('{{ meeting.id }}')">
                                <span class="text-lg">🤖</span>
                            </button>
                            <span class="text-xs text-gray-600 mt-1">AI要約</span>
                        </div>
                        {% else %}
                        <div class="inline-flex flex-col items-center">
                            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                                <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            </div>
                            <span class="text-xs text-gray-400 mt-1">待機中</span>
                        </div>
                        {% endif %}
                    </td>
                    
                    <!-- FAQ作成 -->
                    <td class="px-3 py-4 text-center">
                        {% if meeting.stages.faq.status == 'completed' %}
                        <div class="inline-flex flex-col items-center">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </div>
                            <span class="text-xs text-gray-600 mt-1">{{ meeting.stages.faq.count }}件作成</span>
                        </div>
                        {% elif meeting.stages.faq.status == 'in_progress' %}
                        <div class="inline-flex flex-col items-center">
                            <button class="w-10 h-10 bg-yellow-100 hover:bg-yellow-200 text-yellow-700 rounded-full flex items-center justify-center transition-colors" onclick="editFAQ('{{ meeting.id }}')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <span class="text-xs text-gray-600 mt-1">編集中</span>
                            <span class="text-xs text-gray-400">{{ meeting.stages.faq.draft_count }}件</span>
                        </div>
                        {% elif meeting.stages.faq.status == 'ready' %}
                        <div class="inline-flex flex-col items-center">
                            <button class="w-10 h-10 bg-blue-500 hover:bg-blue-600 text-white rounded-full flex items-center justify-center transition-colors" onclick="createFAQ('{{ meeting.id }}')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                            </button>
                            <span class="text-xs text-gray-600 mt-1">作成</span>
                        </div>
                        {% else %}
                        <div class="inline-flex flex-col items-center">
                            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                                <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            </div>
                            <span class="text-xs text-gray-400 mt-1">待機中</span>
                        </div>
                        {% endif %}
                    </td>
                    
                    <!-- レビュー -->
                    <td class="px-3 py-4 text-center">
                        {% if meeting.stages.review.status == 'approved' %}
                        <div class="inline-flex flex-col items-center">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </div>
                            <span class="text-xs text-gray-600 mt-1">承認済</span>
                            <span class="text-xs text-gray-400">{{ meeting.stages.review.approver }}</span>
                        </div>
                        {% elif meeting.stages.review.status == 'pending' %}
                        <div class="inline-flex flex-col items-center">
                            <button class="w-10 h-10 bg-orange-500 hover:bg-orange-600 text-white rounded-full flex items-center justify-center transition-colors" onclick="requestReview('{{ meeting.id }}')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </button>
                            <span class="text-xs text-gray-600 mt-1">レビュー待ち</span>
                        </div>
                        {% elif meeting.stages.review.status == 'ready' %}
                        <div class="inline-flex flex-col items-center">
                            <button class="w-10 h-10 bg-blue-500 hover:bg-blue-600 text-white rounded-full flex items-center justify-center transition-colors" onclick="submitForReview('{{ meeting.id }}')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </button>
                            <span class="text-xs text-gray-600 mt-1">提出</span>
                        </div>
                        {% else %}
                        <div class="inline-flex flex-col items-center">
                            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                                <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            </div>
                            <span class="text-xs text-gray-400 mt-1">待機中</span>
                        </div>
                        {% endif %}
                    </td>
                    
                    <!-- 公開 -->
                    <td class="px-3 py-4 text-center">
                        {% if meeting.stages.publish.status == 'published' %}
                        <div class="inline-flex flex-col items-center">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </div>
                            <span class="text-xs text-gray-600 mt-1">公開済</span>
                            <span class="text-xs text-gray-400">{{ meeting.stages.publish.date }}</span>
                        </div>
                        {% elif meeting.stages.publish.status == 'ready' %}
                        <div class="inline-flex flex-col items-center">
                            <button class="w-10 h-10 bg-green-500 hover:bg-green-600 text-white rounded-full flex items-center justify-center transition-colors" onclick="publishContent('{{ meeting.id }}')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </button>
                            <span class="text-xs text-gray-600 mt-1">公開</span>
                        </div>
                        {% else %}
                        <div class="inline-flex flex-col items-center">
                            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                                <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            </div>
                            <span class="text-xs text-gray-400 mt-1">待機中</span>
                        </div>
                        {% endif %}
                    </td>
                    
                    <!-- アクション -->
                    <td class="px-4 py-4 text-center">
                        <div class="flex flex-col space-y-1">
                            <button class="text-sm text-blue-600 hover:text-blue-700" onclick="viewDetails('{{ meeting.id }}')">
                                詳細
                            </button>
                            <button class="text-sm text-gray-600 hover:text-gray-700" onclick="viewTimeline('{{ meeting.id }}')">
                                履歴
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if not active_meetings %}
    <div class="p-12 text-center">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p class="mt-2 text-gray-500">処理中のミーティングはありません</p>
        <button class="btn btn-primary mt-4" onclick="showUploadModal()">
            新規ミーティングを登録
        </button>
    </div>
    {% endif %}
</div>

<!-- IR担当者向け追加情報セクション -->
<!-- 今日のフォーカス -->
<div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg shadow-sm border border-indigo-200 p-6 mt-6 mb-6">
    <div class="flex items-start justify-between mb-4">
        <div>
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                </svg>
                今日のフォーカスエリア
            </h3>
            <p class="text-sm text-gray-600 mt-1">ミーティング処理と並行して、次のアクションを確認しましょう</p>
        </div>
        <span class="text-sm text-gray-500">{{ current_time }}</span>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- 今日のスケジュール（詳細版） -->
        <div class="bg-white rounded-lg p-4 col-span-2">
            <h4 class="font-semibold text-gray-700 mb-3 flex items-center justify-between">
                <span class="flex items-center">
                    <span class="text-lg mr-2">📅</span>
                    本日の面談予定
                </span>
                <span class="text-xs text-gray-500">{{ todays_schedule.meetings }}件</span>
            </h4>
            <div class="space-y-3">
                {% for meeting in todays_meetings_detail[:2] %}
                <div class="bg-gray-50 rounded-lg p-3 hover:bg-gray-100 cursor-pointer" onclick="viewMeetingPrep('{{ meeting.id }}')">
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <div class="flex items-center">
                                <span class="text-sm font-semibold text-gray-800">{{ meeting.time }}</span>
                                <span class="text-sm font-medium text-gray-700 ml-2">{{ meeting.investor_name }}</span>
                                {% if meeting.is_important %}
                                <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                                    重要
                                </span>
                                {% endif %}
                            </div>
                            <p class="text-xs text-gray-600 mt-1">テーマ: {{ meeting.topics|join(', ') }}</p>
                        </div>
                        <span class="text-xs text-gray-500">{{ meeting.duration }}</span>
                    </div>
                    
                    <!-- 過去のヒアリングサマリー -->
                    <div class="bg-white rounded p-2 mb-2">
                        <p class="text-xs font-medium text-gray-700 mb-1">📄 前回の主要ポイント:</p>
                        <p class="text-xs text-gray-600">{{ meeting.last_meeting_summary }}</p>
                    </div>
                    
                    <!-- 宿題事項 -->
                    {% if meeting.pending_items %}
                    <div class="bg-yellow-50 rounded p-2">
                        <p class="text-xs font-medium text-yellow-800 mb-1">⚠️ 宿題事項:</p>
                        <ul class="text-xs text-yellow-700 space-y-0.5">
                            {% for item in meeting.pending_items %}
                            <li class="flex items-start">
                                <span class="text-yellow-500 mr-1">•</span>
                                {{ item }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <a href="/schedule" class="block text-center text-blue-600 hover:text-blue-700 text-xs mt-3">全ての予定を見る →</a>
        </div>
        
        <!-- 質問事項の内訳 -->
        <div class="bg-white rounded-lg p-4">
            <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                <span class="text-lg mr-2">📊</span>
                直近の質問傾向
            </h4>
            <div class="relative h-48">
                <canvas id="questionCategoryChart"></canvas>
            </div>
            <div class="mt-3 text-xs text-gray-600 text-center">
                直近30日間の質問カテゴリ分析
            </div>
        </div>
    </div>
</div>

<!-- 処理実績の長期トレンド -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-800 flex items-center">
            <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4v16" />
            </svg>
            ミーティング処理実績（52週間）
        </h3>
        <div class="flex items-center space-x-2">
            <button onclick="changeTimeRange('quarter')" class="text-xs px-3 py-1 rounded-full bg-gray-100 hover:bg-gray-200">四半期</button>
            <button onclick="changeTimeRange('half')" class="text-xs px-3 py-1 rounded-full bg-gray-100 hover:bg-gray-200">半期</button>
            <button onclick="changeTimeRange('year')" class="text-xs px-3 py-1 rounded-full bg-blue-100 text-blue-700">年間</button>
        </div>
    </div>
    
    <!-- 棒グラフエリア -->
    <div class="h-64 relative">
        <canvas id="weeklyTrendChart"></canvas>
    </div>
    
    <!-- 凡例 -->
    <div class="flex items-center justify-center mt-4 space-x-6 text-xs">
        <div class="flex items-center">
            <div class="w-3 h-3 bg-blue-500 rounded mr-2"></div>
            <span>機関投資家</span>
        </div>
        <div class="flex items-center">
            <div class="w-3 h-3 bg-green-500 rounded mr-2"></div>
            <span>海外投資家</span>
        </div>
        <div class="flex items-center">
            <div class="w-3 h-3 bg-yellow-500 rounded mr-2"></div>
            <span>個人投資家</span>
        </div>
        <div class="flex items-center">
            <div class="w-3 h-3 bg-purple-500 rounded mr-2"></div>
            <span>アナリスト</span>
        </div>
    </div>
</div>

<!-- 今週の投資家対話サマリー -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-800 flex items-center">
            <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            今週の投資家対話サマリー
        </h3>
        <div class="flex items-center space-x-2">
            <span class="text-sm text-gray-500">期間: {{ weekly_summary.period }}</span>
            <button onclick="exportWeeklySummary()" class="text-sm text-blue-600 hover:text-blue-700">エクスポート</button>
        </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
        <div class="text-center">
            <div class="text-3xl font-bold text-gray-800">{{ weekly_summary.total_meetings }}</div>
            <div class="text-sm text-gray-600">処理完了</div>
        </div>
        <div class="text-center">
            <div class="text-3xl font-bold text-green-600">{{ weekly_summary.avg_processing_time }}</div>
            <div class="text-sm text-gray-600">平均処理時間</div>
        </div>
        <div class="text-center">
            <div class="text-3xl font-bold text-blue-600">{{ weekly_summary.ai_usage }}%</div>
            <div class="text-sm text-gray-600">AI活用率</div>
        </div>
        <div class="text-center">
            <div class="text-3xl font-bold text-purple-600">{{ weekly_summary.satisfaction_score }}/5</div>
            <div class="text-sm text-gray-600">満足度スコア</div>
        </div>
    </div>
    
    <!-- 主要トピックと懸念事項 -->
    <div class="border-t pt-4">
        <h4 class="font-semibold text-gray-700 mb-3">投資家の主要関心事項</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <h5 class="text-sm font-medium text-gray-600 mb-2">トップトピック</h5>
                <div class="space-y-2">
                    {% for topic in weekly_summary.top_topics %}
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-700">{{ topic.name }}</span>
                        <div class="flex items-center">
                            <div class="w-24 bg-gray-200 rounded-full h-2 mr-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: {{ topic.percentage }}%"></div>
                            </div>
                            <span class="text-xs text-gray-500">{{ topic.count }}件</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div>
                <h5 class="text-sm font-medium text-gray-600 mb-2">要注意事項</h5>
                <div class="space-y-2">
                    {% for concern in weekly_summary.concerns %}
                    <div class="bg-orange-50 rounded p-2">
                        <div class="flex items-start">
                            <svg class="w-4 h-4 text-orange-400 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            <div class="flex-1">
                                <p class="text-sm text-gray-700">{{ concern.issue }}</p>
                                <p class="text-xs text-gray-500 mt-1">言及: {{ concern.mentions }}回</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI分析インサイト -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <!-- パフォーマンス分析 -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
            <span class="text-xl mr-2">📈</span>
            処理パフォーマンス分析
        </h3>
        <div class="space-y-4">
            <div>
                <div class="flex items-center justify-between mb-1">
                    <span class="text-sm text-gray-600">文字起こし精度</span>
                    <span class="text-sm font-semibold">{{ performance_metrics.transcription_accuracy }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-green-500 h-2 rounded-full" style="width: {{ performance_metrics.transcription_accuracy }}%"></div>
                </div>
            </div>
            <div>
                <div class="flex items-center justify-between mb-1">
                    <span class="text-sm text-gray-600">AI要約品質</span>
                    <span class="text-sm font-semibold">{{ performance_metrics.summary_quality }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full" style="width: {{ performance_metrics.summary_quality }}%"></div>
                </div>
            </div>
            <div>
                <div class="flex items-center justify-between mb-1">
                    <span class="text-sm text-gray-600">FAQ作成効率</span>
                    <span class="text-sm font-semibold">{{ performance_metrics.faq_efficiency }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-purple-500 h-2 rounded-full" style="width: {{ performance_metrics.faq_efficiency }}%"></div>
                </div>
            </div>
        </div>
        <div class="mt-4 pt-4 border-t">
            <p class="text-xs text-gray-600">💡 AI推奨: {{ performance_metrics.ai_recommendation }}</p>
        </div>
    </div>
    
    <!-- 投資家エンゲージメント -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
            <span class="text-xl mr-2">🤝</span>
            投資家エンゲージメント状況
        </h3>
        <div class="space-y-3">
            {% for segment in investor_engagement %}
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                <div>
                    <h4 class="font-medium text-gray-800">{{ segment.type }}</h4>
                    <p class="text-xs text-gray-600">{{ segment.count }}社 / {{ segment.meetings }}回</p>
                </div>
                <div class="text-right">
                    <div class="text-lg font-semibold {% if segment.satisfaction >= 4.0 %}text-green-600{% elif segment.satisfaction >= 3.0 %}text-yellow-600{% else %}text-red-600{% endif %}">
                        {{ segment.satisfaction }}/5.0
                    </div>
                    <p class="text-xs text-gray-500">満足度</p>
                </div>
            </div>
            {% endfor %}
        </div>
        <button onclick="viewDetailedEngagement()" class="w-full mt-4 text-center text-blue-600 hover:text-blue-700 text-sm">詳細分析を見る →</button>
    </div>
</div>
<!-- サマリーカード -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-6">
    <!-- 本日の予定 -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold text-gray-700">本日の予定</h3>
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
        </div>
        <div class="text-2xl font-bold text-gray-900">{{ todays_meetings }}</div>
        <p class="text-xs text-gray-500 mt-1">ミーティング予定</p>
        <div class="mt-3 pt-3 border-t border-gray-100">
            <a href="/schedule" class="text-xs text-blue-600 hover:text-blue-700">詳細を見る →</a>
        </div>
    </div>
    
    <!-- 処理効率 -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold text-gray-700">処理効率</h3>
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
        </div>
        <div class="text-2xl font-bold text-gray-900">{{ processing_efficiency }}%</div>
        <p class="text-xs text-gray-500 mt-1">平均処理時間: {{ avg_processing_time }}</p>
        <div class="mt-3">
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-green-500 h-2 rounded-full" style="width: {{ processing_efficiency }}%"></div>
            </div>
        </div>
    </div>
    
    <!-- AI活用率 -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold text-gray-700">AI活用率</h3>
            <span class="text-2xl">🤖</span>
        </div>
        <div class="text-2xl font-bold text-gray-900">{{ ai_usage_rate }}%</div>
        <p class="text-xs text-gray-500 mt-1">自動処理: {{ ai_automated_tasks }}件</p>
        <div class="mt-3">
            <div class="flex items-center space-x-2 text-xs">
                <span class="text-green-600">↑ {{ ai_improvement }}%</span>
                <span class="text-gray-400">前月比</span>
            </div>
        </div>
    </div>
    
    <!-- 投資家満足度 -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold text-gray-700">投資家満足度</h3>
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </div>
        <div class="text-2xl font-bold text-gray-900">{{ investor_satisfaction }}%</div>
        <p class="text-xs text-gray-500 mt-1">回答評価: 4.8/5.0</p>
        <div class="mt-3">
            <div class="flex -space-x-1">
                {% for i in range(5) %}
                <div class="w-6 h-6 bg-yellow-400 rounded-full border-2 border-white flex items-center justify-center">
                    <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- 新規ミーティング登録モーダル -->
<div class="modal" id="uploadModal">
    <div class="modal-content max-w-2xl">
        <div class="modal-header">
            <h2 class="modal-title">新規ミーティング登録</h2>
            <button class="modal-close" onclick="closeModal('uploadModal')">&times;</button>
        </div>
        <form class="p-6" onsubmit="event.preventDefault(); registerMeeting();">
            <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="form-label">ミーティング日時 *</label>
                    <input type="datetime-local" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">投資家名 *</label>
                    <input type="text" class="form-control" placeholder="例: 野村アセットマネジメント" required>
                </div>
                <div class="form-group">
                    <label class="form-label">投資家タイプ *</label>
                    <select class="form-control" required>
                        <option value="">選択してください</option>
                        <option value="大口機関投資家">大口機関投資家</option>
                        <option value="海外機関投資家">海外機関投資家</option>
                        <option value="国内機関投資家">国内機関投資家</option>
                        <option value="個人投資家">個人投資家</option>
                        <option value="アナリスト">アナリスト</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ミーティング形式 *</label>
                    <select class="form-control" required>
                        <option value="">選択してください</option>
                        <option value="対面">対面</option>
                        <option value="Web会議">Web会議</option>
                        <option value="電話">電話</option>
                        <option value="メール">メール</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">タイトル *</label>
                <input type="text" class="form-control" placeholder="例: Q3決算に関する個別面談" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">参加者</label>
                <input type="text" class="form-control" placeholder="例: CFO, IR部長">
            </div>
            
            <div class="form-group">
                <label class="form-label">ファイルアップロード</label>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    <p class="mt-2 text-sm text-gray-600">
                        録画・音声ファイルをドラッグ＆ドロップ<br>
                        または<button type="button" class="text-blue-600 hover:text-blue-700">ファイルを選択</button>
                    </p>
                    <p class="text-xs text-gray-500 mt-1">対応形式: MP4, MOV, MP3, WAV, PDF</p>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" class="mr-2" checked>
                    アップロード後、自動的にAI処理を開始する
                </label>
            </div>
            
            <div class="flex gap-3 justify-end mt-6">
                <button type="button" class="btn btn-secondary" onclick="closeModal('uploadModal')">キャンセル</button>
                <button type="submit" class="btn btn-primary">登録して処理開始</button>
            </div>
        </form>
    </div>
</div>

<style>
/* パイプラインビュー用スタイル */
.animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: .5;
    }
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background-color: white;
    border-radius: 0.5rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #6b7280;
    cursor: pointer;
    padding: 0;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.375rem;
    transition: all 0.2s;
}

.modal-close:hover {
    background-color: #f3f4f6;
    color: #111827;
}

.form-group {
    margin-bottom: 1rem;
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.5rem;
}

.form-control {
    display: block;
    width: 100%;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    line-height: 1.5;
    color: #111827;
    background-color: white;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* レスポンシブ対応 */
@media (max-width: 1280px) {
    .overflow-x-auto {
        -webkit-overflow-scrolling: touch;
    }
}

@media (max-width: 768px) {
    table {
        font-size: 0.75rem;
    }
    
    th, td {
        padding: 0.5rem;
    }
    
    .w-32 {
        width: 6rem;
    }
}
</style>

{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// 時刻更新
function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
    const timeElement = document.getElementById('current-time');
    if (timeElement) {
        timeElement.textContent = timeString;
    }
}

// モーダル制御
function showUploadModal() {
    document.getElementById('uploadModal').classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

// 各種アクション（デモ用）
function uploadFiles(meetingId) {
    if (confirm('ファイルをアップロードしますか？')) {
        alert(`ミーティング ${meetingId} のファイルアップロード画面を開きます`);
    }
}

function startTranscription(meetingId) {
    if (confirm('文字起こしを開始しますか？')) {
        alert(`ミーティング ${meetingId} の文字起こしを開始しました`);
        location.reload();
    }
}

function startAISummary(meetingId) {
    if (confirm('AI要約を開始しますか？')) {
        alert(`ミーティング ${meetingId} のAI要約処理を開始しました`);
        location.reload();
    }
}

function createFAQ(meetingId) {
    alert(`ミーティング ${meetingId} のFAQ作成画面を開きます`);
}

function editFAQ(meetingId) {
    alert(`ミーティング ${meetingId} のFAQ編集画面を開きます`);
}

function submitForReview(meetingId) {
    if (confirm('レビューに提出しますか？')) {
        alert(`ミーティング ${meetingId} をレビューに提出しました`);
        location.reload();
    }
}

function requestReview(meetingId) {
    alert(`ミーティング ${meetingId} のレビュー画面を開きます`);
}

function publishContent(meetingId) {
    if (confirm('投資家向けに公開しますか？')) {
        alert(`ミーティング ${meetingId} のコンテンツを公開しました`);
        location.reload();
    }
}

function viewDetails(meetingId) {
    window.location.href = `/dialogue/edit?id=${meetingId}`;
}

function viewTimeline(meetingId) {
    alert(`ミーティング ${meetingId} の処理履歴を表示します`);
}

function viewSummary(meetingId) {
    alert(`ミーティング ${meetingId} のAI要約を表示します`);
}

function registerMeeting() {
    alert('新規ミーティングを登録しました');
    closeModal('uploadModal');
    location.reload();
}

// 追加機能: 処理完了時のアクション
function showFollowupList() {
    alert('要フォロー投資家リストを表示します');
    // 実際の実装ではモーダルや別ページへの遷移
}

function prepareExecutiveReport() {
    if (confirm('経営陣向けレポートを作成しますか？')) {
        alert('レポート作成画面へ遷移します');
        // window.location.href = '/reports/executive';
    }
}

function exportWeeklySummary() {
    if (confirm('週次サマリーをエクスポートしますか？')) {
        alert('Excelファイルとしてダウンロードを開始しました');
        // 実際の実装ではダウンロード処理
    }
}

function viewDetailedEngagement() {
    window.location.href = '/analytics?view=investor-engagement';
}

// 面談準備詳細表示
function viewMeetingPrep(meetingId) {
    window.location.href = `/meeting-prep/${meetingId}`;
}

// タイムレンジ変更
function changeTimeRange(range) {
    console.log('タイムレンジ変更:', range);
    // 実際の実装ではAPIを呼び出してグラフを更新
    updateWeeklyTrendChart(range);
}

// グラフの初期化
let weeklyTrendChart = null;
let questionCategoryChart = null;

function initializeWeeklyTrendChart() {
    const ctx = document.getElementById('weeklyTrendChart');
    if (!ctx) return;
    
    // データの準備
    const weeklyData = {{ weekly_processing_data | tojson }};
    const labels = weeklyData.map(d => d.week);
    
    weeklyTrendChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '機関投資家',
                    data: weeklyData.map(d => d.institutional),
                    backgroundColor: '#3B82F6',
                    stack: 'Stack 0'
                },
                {
                    label: '海外投資家',
                    data: weeklyData.map(d => d.overseas),
                    backgroundColor: '#10B981',
                    stack: 'Stack 0'
                },
                {
                    label: '個人投資家',
                    data: weeklyData.map(d => d.individual),
                    backgroundColor: '#F59E0B',
                    stack: 'Stack 0'
                },
                {
                    label: 'アナリスト',
                    data: weeklyData.map(d => d.analyst),
                    backgroundColor: '#8B5CF6',
                    stack: 'Stack 0'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: false
                },
                legend: {
                    display: false // 凡例はHTMLで表示するため非表示
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        afterTitle: function(context) {
                            const index = context[0].dataIndex;
                            const total = weeklyData[index].total;
                            return '合計: ' + total + '件';
                        }
                    }
                }
            },
            scales: {
                x: {
                    stacked: true,
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        autoSkip: true,
                        maxTicksLimit: 12 // 最大ラベル数を制限
                    }
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    grid: {
                        drawBorder: false
                    },
                    ticks: {
                        stepSize: 5
                    }
                }
            }
        }
    });
}

function initializeQuestionCategoryChart() {
    const ctx = document.getElementById('questionCategoryChart');
    if (!ctx) return;
    
    const questionData = {{ question_categories | tojson }};
    
    questionCategoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: questionData.map(d => d.category),
            datasets: [{
                data: questionData.map(d => d.count),
                backgroundColor: questionData.map(d => d.color),
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 10,
                        font: {
                            size: 11
                        },
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map(function(label, i) {
                                    const dataset = data.datasets[0];
                                    const value = dataset.data[i];
                                    const percentage = questionData[i].percentage;
                                    return {
                                        text: label + ' (' + percentage + '%)',
                                        fillStyle: dataset.backgroundColor[i],
                                        hidden: false,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const percentage = questionData[context.dataIndex].percentage;
                            return label + ': ' + value + '件 (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}

function updateWeeklyTrendChart(range) {
    if (!weeklyTrendChart) return;
    
    // レンジに応じたフィルタリング
    const weeklyData = {{ weekly_processing_data | tojson }};
    let filteredData = weeklyData;
    
    if (range === 'quarter') {
        filteredData = weeklyData.slice(-13); // 直近13週間
    } else if (range === 'half') {
        filteredData = weeklyData.slice(-26); // 直近26週間
    }
    
    // データ更新
    weeklyTrendChart.data.labels = filteredData.map(d => d.week);
    weeklyTrendChart.data.datasets[0].data = filteredData.map(d => d.institutional);
    weeklyTrendChart.data.datasets[1].data = filteredData.map(d => d.overseas);
    weeklyTrendChart.data.datasets[2].data = filteredData.map(d => d.individual);
    weeklyTrendChart.data.datasets[3].data = filteredData.map(d => d.analyst);
    weeklyTrendChart.update();
}

// ページ読み込み時
document.addEventListener('DOMContentLoaded', function() {
    updateCurrentTime();
    setInterval(updateCurrentTime, 60000); // 1分ごとに更新
    
    // グラフの初期化
    initializeWeeklyTrendChart();
    initializeQuestionCategoryChart();
    
    // ドラッグ&ドロップのデモ
    const dropZone = document.querySelector('.border-dashed');
    if (dropZone) {
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            alert('ファイルがドロップされました（デモ）');
        });
    }
    
    // 処理完了時のアニメーション
    const completedSection = document.querySelector('.bg-gradient-to-r.from-indigo-50');
    if (completedSection) {
        completedSection.style.opacity = '0';
        completedSection.style.transform = 'translateY(20px)';
        setTimeout(() => {
            completedSection.style.transition = 'all 0.5s ease';
            completedSection.style.opacity = '1';
            completedSection.style.transform = 'translateY(0)';
        }, 100);
    }
});
</script>
{% endblock %}
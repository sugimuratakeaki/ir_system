{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<!-- 緊急対応アラート -->
{% if urgent_items %}
<div class="mb-6">
    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">緊急対応が必要な項目があります</h3>
                </div>
            </div>
        </div>
        <div class="mt-2 space-y-2">
            {% for item in urgent_items %}
            <div class="flex items-center justify-between bg-white p-3 rounded-lg">
                <div class="flex items-center space-x-3">
                    {% if item.type == 'alert' %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">要対応</span>
                    {% else %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">注意</span>
                    {% endif %}
                    <span class="font-medium">{{ item.title }}</span>
                    <span class="text-sm text-gray-500">期限: {{ item.deadline }}</span>
                </div>
                {% if item.progress %}
                <div class="flex items-center space-x-2">
                    <div class="w-32 bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: {{ item.progress }}%"></div>
                    </div>
                    <span class="text-sm text-gray-600">{{ item.progress }}%</span>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- メインコンテンツグリッド -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- 左側：処理待ちタスク（2列分） -->
    <div class="lg:col-span-2">
        <div class="card">
            <div class="card-header bg-gradient-to-r from-kagami-blue to-kagami-blue-dark text-white">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                        </svg>
                        処理待ちタスク
                    </h2>
                    <span class="bg-white/20 px-3 py-1 rounded-full text-sm">{{ pending_tasks|length }}件</span>
                </div>
            </div>
            <div class="card-body p-0">
                {% if pending_tasks %}
                <div class="divide-y divide-gray-200">
                    {% for task in pending_tasks %}
                    <div class="p-4 hover:bg-gray-50 transition-colors">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <!-- 優先度バッジ -->
                                    {% if task.priority == 'high' %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                        </svg>
                                        優先度高
                                    </span>
                                    {% else %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                                        優先度中
                                    </span>
                                    {% endif %}
                                    
                                    <!-- タスクタイプ -->
                                    {% if task.type == 'dialogue' %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                        対話記録
                                    </span>
                                    {% else %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                        質問対応
                                    </span>
                                    {% endif %}
                                </div>
                                
                                <h3 class="text-base font-medium text-gray-900 mb-1">{{ task.title }}</h3>
                                
                                <div class="flex items-center space-x-4 text-sm text-gray-500">
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                        </svg>
                                        {{ task.investor }}
                                    </span>
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        期限: {{ task.due_date }}
                                    </span>
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                        </svg>
                                        {{ task.assignee }}
                                    </span>
                                </div>
                                
                                {% if task.urgency_reason %}
                                <div class="mt-2 p-2 bg-yellow-50 rounded text-sm text-yellow-800">
                                    <strong>対応理由:</strong> {{ task.urgency_reason }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="ml-4 flex flex-col space-y-2">
                                <button class="btn btn-sm btn-primary" onclick="location.href='/dialogue/edit?id={{ task.id }}'">
                                    詳細確認
                                </button>
                                {% if task.type == 'dialogue' %}
                                <button class="btn btn-sm btn-secondary" onclick="location.href='/dialogue/analysis?id={{ task.id }}'">
                                    AI分析
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="p-8 text-center text-gray-500">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="mt-2">処理待ちのタスクはありません</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- 右側：本日のスケジュール -->
    <div class="lg:col-span-1">
        <div class="card">
            <div class="card-header bg-gradient-to-r from-teal-600 to-teal-700 text-white">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        本日の予定
                    </h2>
                    <span class="text-sm">{{ today }}</span>
                </div>
            </div>
            <div class="card-body p-0">
                {% if todays_schedule %}
                <div class="divide-y divide-gray-200">
                    {% for event in todays_schedule %}
                    <div class="p-4 hover:bg-gray-50 transition-colors">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                <div class="w-16 text-center">
                                    <div class="text-lg font-bold text-gray-900">{{ event.time }}</div>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-sm font-medium text-gray-900">{{ event.title }}</h3>
                                <div class="mt-1 text-xs text-gray-500">
                                    <div class="flex items-center">
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        {{ event.location }}
                                    </div>
                                    {% if event.investor %}
                                    <div class="flex items-center mt-1">
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                        </svg>
                                        {{ event.investor }}
                                    </div>
                                    {% endif %}
                                </div>
                                {% if event.preparation_status %}
                                <div class="mt-2">
                                    {% if event.preparation_status == 'ready' %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                        準備完了
                                    </span>
                                    {% elif event.preparation_status == 'in_progress' %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                                        準備中
                                    </span>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="p-8 text-center text-gray-500">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p class="mt-2">本日の予定はありません</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-gray-50 p-3">
                <button class="btn btn-sm btn-secondary w-full" onclick="location.href='/schedule'">
                    スケジュール管理へ
                </button>
            </div>
        </div>
        
        <!-- クイックアクション -->
        <div class="card mt-6">
            <div class="card-header">
                <h3 class="text-lg font-semibold">クイックアクション</h3>
            </div>
            <div class="card-body">
                <div class="flex flex-col gap-3">
                    <button class="btn btn-primary" onclick="showNewFAQModal()">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        新規FAQ作成
                    </button>
                    <button class="btn btn-secondary" onclick="location.href='/upload'">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        ファイルアップロード
                    </button>
                    <button class="btn btn-secondary" onclick="generateReport()">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        レポート生成
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- KPIサマリー（コンパクト版） -->
<div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
    {% for key, kpi in kpis.items() %}
    <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs text-gray-500">{{ kpi.label }}</p>
                <p class="text-2xl font-bold text-gray-900">
                    {{ kpi.value }}{% if key == 'investor_satisfaction' or key == 'faq_accuracy' %}%{% endif %}
                </p>
            </div>
            <div class="text-right">
                <span class="text-sm font-medium {% if kpi.trend.startswith('+') %}text-green-600{% else %}text-red-600{% endif %}">
                    {{ kpi.trend }}
                </span>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- 最近のアクティビティ（コンパクト版） -->
<div class="mt-6 card">
    <div class="card-header flex items-center justify-between">
        <h3 class="text-lg font-semibold">最近のアクティビティ</h3>
        <button class="btn btn-sm btn-secondary" onclick="location.href='/audit-logs'">すべて表示</button>
    </div>
    <div class="card-body p-0">
        <div class="divide-y divide-gray-200">
            {% for activity in recent_activities[:3] %}
            <div class="p-3 flex items-center space-x-3">
                <div class="flex-shrink-0 text-2xl">{{ activity.icon }}</div>
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-900">{{ activity.type }}</p>
                    <p class="text-xs text-gray-500">{{ activity.content }}</p>
                </div>
                <div class="text-xs text-gray-400">{{ activity.time }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- モーダル（FAQ作成） -->
<div class="modal" id="newFAQModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">新規FAQ作成</h2>
            <button class="modal-close" onclick="closeModal('newFAQModal')">&times;</button>
        </div>
        <form onsubmit="event.preventDefault(); createFAQ();">
            <div class="form-group">
                <label class="form-label">質問</label>
                <input type="text" class="form-control" placeholder="例：配当政策について教えてください" required>
            </div>
            <div class="form-group">
                <label class="form-label">回答</label>
                <textarea class="form-control" rows="4" placeholder="回答を入力..." required></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">AI自動生成</label>
                <button type="button" class="btn btn-secondary" onclick="generateAIAnswer()">
                    🤖 AIで回答を生成
                </button>
            </div>
            <div class="flex gap-3 justify-end">
                <button type="button" class="btn btn-secondary" onclick="closeModal('newFAQModal')">キャンセル</button>
                <button type="submit" class="btn btn-primary">作成</button>
            </div>
        </form>
    </div>
</div>

<style>
/* カスタムスタイル */
.card-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    font-weight: 600;
}

.card-body {
    padding: 1.5rem;
}

.card-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #e5e7eb;
}

/* モーダルスタイル */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background-color: white;
    border-radius: 0.5rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #6b7280;
    cursor: pointer;
    padding: 0;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.375rem;
    transition: all 0.2s;
}

.modal-close:hover {
    background-color: #f3f4f6;
    color: #111827;
}

/* フォームスタイル */
.form-group {
    margin-bottom: 1rem;
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.5rem;
}

.form-control {
    display: block;
    width: 100%;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    line-height: 1.5;
    color: #111827;
    background-color: white;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* レスポンシブ調整 */
@media (max-width: 1024px) {
    .grid {
        grid-template-columns: 1fr;
    }
}
</style>

{% endblock %}

{% block extra_js %}
<script>
// モーダル制御
function showNewFAQModal() {
    document.getElementById('newFAQModal').classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

// FAQ作成（モック）
function createFAQ() {
    alert('FAQを作成しました（デモ）');
    closeModal('newFAQModal');
}

// AI回答生成（モック）
function generateAIAnswer() {
    const textarea = document.querySelector('textarea');
    textarea.value = 'AIが生成した回答例：当社は安定的な配当を重視し、配当性向30%を目標としています。';
}

// レポート生成（モック）
function generateReport() {
    alert('レポートを生成中...（デモ）');
}

// ページ読み込み時に時刻を更新
document.addEventListener('DOMContentLoaded', function() {
    // 現在時刻を表示（必要に応じて）
    updateCurrentTime();
    setInterval(updateCurrentTime, 60000); // 1分ごとに更新
});

function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
    // 時刻表示要素があれば更新
    const timeElement = document.getElementById('current-time');
    if (timeElement) {
        timeElement.textContent = timeString;
    }
}
</script>
{% endblock %}
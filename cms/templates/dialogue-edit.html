{% extends "base.html" %}

{% block title %}{{ meeting_data.title }} - 統合処理ワークスペース{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/ir-management.css">
<style>
/* 対話編集ワークスペース専用スタイル */
.dialogue-workspace {
    display: grid;
    grid-template-columns: 320px 1fr 400px;
    grid-template-rows: auto 1fr;
    height: calc(100vh - 140px);
    gap: 1rem;
    grid-template-areas: 
        "progress-stream workspace-header context-panel"
        "progress-stream workspace-main context-panel";
    transition: grid-template-columns 0.3s ease;
}

.dialogue-workspace.context-collapsed {
    grid-template-columns: 320px 1fr 0px;
    grid-template-areas: 
        "progress-stream workspace-header context-panel"
        "progress-stream workspace-main context-panel";
}

/* 進捗ストリーム（左サイドバー） */
.progress-stream {
    grid-area: progress-stream;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.stream-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
}

.stream-title {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.stream-subtitle {
    font-size: 0.875rem;
    opacity: 0.9;
}

/* 進捗ステージ */
.progress-stages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
}

.stage-item {
    border: 2px solid transparent;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    background: white;
    border-left: 4px solid #e5e7eb;
}

.stage-item:hover {
    border-color: #d1d5db;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.stage-item.completed {
    border-left-color: #10b981;
    background: #f0fdf4;
}

.stage-item.active {
    border-left-color: #667eea;
    background: #f3f4ff;
}

.stage-item.processing {
    border-left-color: #f59e0b;
    background: #fffbeb;
}

.stage-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.stage-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    margin-right: 0.75rem;
}

.stage-item.completed .stage-icon {
    background: #10b981;
    color: white;
}

.stage-item.active .stage-icon {
    background: #667eea;
    color: white;
}

.stage-item.processing .stage-icon {
    background: #f59e0b;
    color: white;
}

.stage-item:not(.completed):not(.active):not(.processing) .stage-icon {
    background: #e5e7eb;
    color: #6b7280;
}

.stage-title {
    font-weight: 600;
    color: #374151;
    margin: 0;
    font-size: 0.875rem;
}

.stage-progress {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.25rem;
}

.stage-progress.processing {
    color: #f59e0b;
    font-weight: 500;
}

/* ワークスペースヘッダー */
.workspace-header {
    grid-area: workspace-header;
    background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.meeting-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.125rem;
}

.meeting-info h1 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
}

.meeting-meta {
    margin-top: 0.25rem;
    font-size: 0.875rem;
    opacity: 0.9;
}

.header-actions {
    display: flex;
    gap: 0.5rem;
}

/* メインワークスペース */
.workspace-main {
    grid-area: workspace-main;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

/* ステップコンテンツ */
.step-content {
    flex: 1;
    overflow-y: auto;
    display: none;
}

.step-content.active {
    display: block;
}

.content-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    background: #f8fafc;
}

.content-body {
    padding: 1.5rem;
    flex: 1;
}

/* アップロードエリアスタイル */
.upload-area {
    border: 2px dashed #d1d5db;
    border-radius: 0.75rem;
    padding: 3rem;
    text-align: center;
    transition: all 0.3s ease;
    background: #fafafa;
}

.upload-area:hover {
    border-color: #667eea;
    background: #f8faff;
}

/* AI分析結果の改善されたスタイル */
.analysis-results {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.result-card {
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    border-radius: 1rem;
    padding: 2rem;
    border: 1px solid #e5e7eb;
    position: relative;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
}

.result-card:hover {
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.result-card.primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.result-card.primary .card-title {
    color: white;
}

.result-card.primary .card-content {
    color: rgba(255, 255, 255, 0.95);
}

.card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
}

.card-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(102, 126, 234, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.result-card.primary .card-icon {
    background: rgba(255, 255, 255, 0.2);
}

.card-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0;
}

.card-content {
    color: #4b5563;
    line-height: 1.7;
    font-size: 0.95rem;
}

.highlight-box {
    background: #eff6ff;
    border-left: 4px solid #3b82f6;
    padding: 1rem;
    border-radius: 0.5rem;
    margin: 1rem 0;
}

/* コンテキストパネル（右サイドバー） */
.context-panel {
    grid-area: context-panel;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
}

.context-panel.collapsed {
    width: 0;
    min-width: 0;
    overflow: hidden;
    opacity: 0;
    pointer-events: none;
}

.panel-header {
    background: #f8fafc;
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.panel-content {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
}

/* コンテンツ開閉ボタン */
.context-toggle {
    position: fixed;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    width: 45px;
    height: 120px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 22px 0 0 22px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 100;
    transition: all 0.3s ease;
    box-shadow: -2px 0 8px rgba(0, 0, 0, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.2);
    padding: 8px 0;
}

.context-toggle:hover {
    background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
    transform: translateY(-50%) translateX(-5px);
}

.toggle-icon {
    color: white;
    font-size: 1.25rem;
    transition: transform 0.3s ease;
}

.context-collapsed .toggle-icon {
    transform: rotate(180deg);
}

/* ボタンスタイル */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    background: #5a67d8;
}

.btn-secondary {
    background: #e5e7eb;
    color: #374151;
}

.btn-secondary:hover {
    background: #d1d5db;
}

.btn-success {
    background: #10b981;
    color: white;
}

.btn-success:hover {
    background: #059669;
}

.btn-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    padding: 0;
    border: none;
    border-radius: 0.375rem;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-icon:hover {
    background: rgba(255, 255, 255, 0.2);
}

/* ユーティリティ */
.separator {
    color: rgba(255, 255, 255, 0.5);
    margin: 0 0.5rem;
}

/* レスポンシブ対応 */
@media (max-width: 1024px) {
    .dialogue-workspace {
        grid-template-columns: 280px 1fr 0px;
        grid-template-areas: 
            "progress-stream workspace-header context-panel"
            "progress-stream workspace-main context-panel";
    }
    
    .context-panel {
        display: none;
    }
}

@media (max-width: 768px) {
    .dialogue-workspace {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr;
        grid-template-areas: 
            "workspace-header"
            "progress-stream"
            "workspace-main";
    }
    
    .progress-stream {
        max-height: 200px;
    }
    
    .progress-stages {
        display: flex;
        overflow-x: auto;
        flex-direction: row;
        padding: 1rem;
        gap: 1rem;
        -webkit-overflow-scrolling: touch;
    }
    
    .stage-item {
        min-width: 200px;
        margin-bottom: 0;
    }
    
    .header-left {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .meeting-info h1 {
        font-size: 1.125rem;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- 対話編集ワークスペース -->
<div class="dialogue-workspace" data-meeting-id="{{ meeting_id }}">
    <!-- 進捗ストリーム（左サイドバー） -->
    <div class="progress-stream">
        <div class="stream-header">
            <h2 class="stream-title">処理進捗</h2>
            <p class="stream-subtitle">{{ meeting_data.progress_percentage|default(65) }}% 完了</p>
        </div>
        
        <div class="progress-stages">
            {% set stages = [
                {'id': 'upload', 'icon': '☁️', 'title': 'ファイルアップロード', 'status': meeting_data.stages.upload.status|default('completed')},
                {'id': 'transcription', 'icon': '🎤', 'title': '文字起こし', 'status': meeting_data.stages.transcription.status|default('completed')},
                {'id': 'ai_summary', 'icon': '🧠', 'title': 'AI分析', 'status': meeting_data.stages.ai_summary.status|default('active')},
                {'id': 'faq', 'icon': '❓', 'title': 'FAQ作成', 'status': meeting_data.stages.faq.status|default('pending')},
                {'id': 'review', 'icon': '✅', 'title': 'レビュー', 'status': meeting_data.stages.review.status|default('pending')},
                {'id': 'publish', 'icon': '🌐', 'title': '公開', 'status': meeting_data.stages.publish.status|default('pending')}
            ] %}
            
            {% for stage in stages %}
            <div class="stage-item {{ stage.status }}" data-stage="{{ stage.id }}" onclick="switchToStage('{{ stage.id }}')">
                <div class="stage-header">
                    <div class="stage-icon">
                        {{ stage.icon }}
                    </div>
                </div>
                <h3 class="stage-title">{{ stage.title }}</h3>
                <div class="stage-progress {{ stage.status }}">
                    {% if stage.status == 'completed' %}
                    完了
                    {% elif stage.status == 'active' %}
                    処理中...
                    {% elif stage.status == 'processing' %}
                    {{ meeting_data.stages[stage.id].progress|default(45) }}%
                    {% else %}
                    待機中
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ワークスペースヘッダー -->
    <div class="workspace-header">
        <div class="header-left">
            <div class="meeting-avatar">
                {{ meeting_data.investor_name[:2]|default('IR') }}
            </div>
            <div class="meeting-info">
                <h1>{{ meeting_data.title|default('投資家面談議事録処理') }}</h1>
                <div class="meeting-meta">
                    {{ meeting_data.formatted_date|default('2024年1月15日') }}
                    <span class="separator">•</span>
                    {{ meeting_data.duration|default('60分') }}
                    <span class="separator">•</span>
                    参加者 {{ meeting_data.participants|default(3) }}名
                </div>
            </div>
        </div>
        
        <div class="header-actions">
            <button class="btn-icon" onclick="showTimeline()" title="処理履歴">
                📈
            </button>
            <button class="btn-icon" onclick="shareProgress()" title="進捗共有">
                📤
            </button>
            <button class="btn-icon" onclick="toggleAIAssistant()" title="AIアシスタント">
                🤖
            </button>
        </div>
    </div>

    <!-- メインワークスペース -->
    <div class="workspace-main">
        <!-- アップロードステップ -->
        <div id="step-upload" class="step-content active">
            <div class="content-header">
                <h2>☁️ ファイルアップロード</h2>
            </div>
            <div class="content-body">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-prompt">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">☁️</div>
                        <p>録音・録画ファイルをドラッグ＆ドロップ</p>
                        <p style="color: #6b7280; font-size: 0.875rem;">または</p>
                        <button class="btn btn-primary" onclick="selectFiles()">
                            ファイルを選択
                        </button>
                    </div>
                    <input type="file" id="fileInput" multiple accept="video/*,audio/*,.pdf" style="display: none;">
                </div>
                
                <div style="background: #f3f4ff; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; display: flex; gap: 1rem;">
                    <div style="color: #667eea; font-size: 1.25rem;">
                        💡
                    </div>
                    <div style="flex: 1; font-size: 0.875rem; color: #4c51bf;">
                        <p>{{ meeting_data.investor_name|default('投資家') }}との過去の面談では、音声ファイルと資料PDFの組み合わせで最良の結果が得られています。</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 文字起こしステップ -->
        <div id="step-transcription" class="step-content">
            <div class="content-header">
                <h2>🎤 文字起こし</h2>
            </div>
            <div class="content-body">
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🎤</div>
                    <h3>文字起こし処理完了</h3>
                    <p style="color: #6b7280;">音声の解析が完了し、高精度なテキストが生成されました。</p>
                    <button class="btn btn-primary" onclick="switchToStage('ai_summary')">
                        ➡️ AI分析に進む
                    </button>
                </div>
            </div>
        </div>

        <!-- AI分析ステップ -->
        <div id="step-ai_summary" class="step-content">
            <div class="content-header">
                <h2>🧠 AI分析・要約</h2>
            </div>
            <div class="content-body">
                <div class="ai-analysis-section">
                    <!-- カスタムプロンプト入力 -->
                    <div style="margin-bottom: 2rem;">
                        <h3>分析の視点を追加</h3>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <textarea id="customPrompt" 
                                     placeholder="特に注目したい点や、追加の分析視点があれば入力してください..."
                                     style="flex: 1; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; resize: none; min-height: 80px;"></textarea>
                            <button class="btn btn-primary" onclick="reanalyzeWithPrompt()">
                                🔄 再分析
                            </button>
                        </div>
                        
                        <!-- プロンプトテンプレート -->
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <span style="font-size: 0.875rem; color: #6b7280;">テンプレート:</span>
                            <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.75rem;" onclick="usePromptTemplate('competition')">
                                競合比較
                            </button>
                            <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.75rem;" onclick="usePromptTemplate('risk')">
                                リスク分析
                            </button>
                            <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.75rem;" onclick="usePromptTemplate('opportunity')">
                                機会発見
                            </button>
                        </div>
                    </div>
                    
                    <!-- AI分析結果（改善版） -->
                    <div class="analysis-results">
                        <div class="result-card primary">
                            <div class="card-header">
                                <div class="card-icon">📋</div>
                                <h3 class="card-title">面談サマリー</h3>
                            </div>
                            <div class="card-content">
                                {{ meeting_data.ai_summary.executive_summary|default('今回の面談では、AI事業の成長戦略について詳細な議論が行われました。投資家からは特に競合優位性と収益性について関心が示され、技術的な差別化要因についても深く検討されました。') }}
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <div class="card-header">
                                <div class="card-icon">⚡</div>
                                <h3 class="card-title">重要ポイント</h3>
                            </div>
                            <div class="highlight-box">
                                <ul style="margin: 0; padding-left: 1.5rem;">
                                    <li>AI技術の競合優位性について詳細な説明を要求</li>
                                    <li>収益性の向上タイムラインに強い関心</li>
                                    <li>ESG観点での企業価値創造について質問</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <div class="card-header">
                                <div class="card-icon">💼</div>
                                <h3 class="card-title">投資家の関心領域</h3>
                            </div>
                            <div class="card-content">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                    <div style="background: #f0f9ff; padding: 1rem; border-radius: 0.5rem; border-left: 3px solid #0ea5e9;">
                                        <strong>技術競争力</strong>
                                        <p style="margin: 0.25rem 0 0; font-size: 0.875rem;">独自アルゴリズムの優位性</p>
                                    </div>
                                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; border-left: 3px solid #22c55e;">
                                        <strong>市場拡大性</strong>
                                        <p style="margin: 0.25rem 0 0; font-size: 0.875rem;">TAM（市場規模）の成長性</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; text-align: center;">
                        <button class="btn btn-success" onclick="switchToStage('faq')">
                            ➡️ FAQ作成に進む
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- FAQ作成ステップ -->
        <div id="step-faq" class="step-content">
            <div class="content-header">
                <h2>❓ FAQ作成・管理</h2>
            </div>
            <div class="content-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="generateMoreFAQs()">
                            ✨ AIで追加生成
                        </button>
                        <button class="btn btn-secondary" onclick="createManualFAQ()">
                            ➕ 手動で追加
                        </button>
                    </div>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                        AI生成: 3件 • 手動作成: 1件
                    </div>
                </div>
                
                <!-- FAQ一覧プレビュー -->
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    {% for i in range(3) %}
                    <div style="background: #f8fafc; border-left: 3px solid #667eea; border-radius: 0.5rem; padding: 1rem;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="background: #e0e7ff; color: #4338ca; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 500;">
                                🤖 AI生成
                            </span>
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Q:</strong> AI事業の競合優位性はどのような点にありますか？
                        </div>
                        <div>
                            <strong>A:</strong> 当社のAI事業は、独自のデータセットと機械学習アルゴリズムにより、業界トップクラスの精度を実現しています...
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div style="margin-top: 1.5rem; text-align: center;">
                    <button class="btn btn-success" onclick="switchToStage('review')">
                        ➡️ レビューに進む
                    </button>
                </div>
            </div>
        </div>

        <!-- レビューステップ -->
        <div id="step-review" class="step-content">
            <div class="content-header">
                <h2>✅ レビュー・承認</h2>
            </div>
            <div class="content-body">
                <div style="background: #f8fafc; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                    <h3>公開前チェックリスト</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" checked>
                            <span>文字起こしの精度確認</span>
                            <span style="background: #d1fae5; color: #065f46; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin-left: auto;">OK</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" checked>
                            <span>機密情報の除外確認</span>
                            <span style="background: #d1fae5; color: #065f46; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin-left: auto;">OK</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox">
                            <span>FAQ内容の正確性確認</span>
                            <span style="background: #fef3c7; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin-left: auto;">要確認</span>
                        </label>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn btn-success" onclick="switchToStage('publish')">
                        ➡️ 公開設定に進む
                    </button>
                </div>
            </div>
        </div>

        <!-- 公開ステップ -->
        <div id="step-publish" class="step-content">
            <div class="content-header">
                <h2>🌐 公開設定</h2>
            </div>
            <div class="content-body">
                <div style="background: #f8fafc; padding: 1.5rem; border-radius: 0.5rem;">
                    <h3>公開範囲設定</h3>
                    <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer;">
                            <input type="radio" name="publish_scope" value="internal" checked>
                            <div>
                                🏢 <strong>社内のみ</strong>
                                <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">IR部門・経営陣のみ閲覧可能</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer;">
                            <input type="radio" name="publish_scope" value="investors">
                            <div>
                                👥 <strong>投資家向け</strong>
                                <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">FAQのみ投資家サイトで公開</div>
                            </div>
                        </label>
                    </div>
                    
                    <div style="margin-top: 2rem; text-align: center;">
                        <button class="btn btn-success btn-lg" onclick="publishContent()">
                            🚀 公開実行
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- コンテキストパネル（右サイドバー） -->
    <div class="context-panel">
        <div class="panel-header">
            <h3>👤 投資家プロファイル</h3>
            <button class="btn-icon" onclick="toggleContextPanel()" style="color: #6b7280;">
                ❌
            </button>
        </div>
        <div class="panel-content">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.5rem; margin: 0 auto 0.75rem;">
                    {{ meeting_data.investor_name[:2]|default('IR') }}
                </div>
                <h4 style="margin: 0;">{{ meeting_data.investor_name|default('投資家名') }}</h4>
                <p style="color: #6b7280; font-size: 0.875rem;">{{ meeting_data.investor_type|default('機関投資家') }}</p>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <span style="font-size: 0.875rem; color: #6b7280;">投資スタイル</span>
                    <div style="font-weight: 500;">{{ meeting_data.investor_profile.investment_style|default('長期成長') }}</div>
                </div>
                <div>
                    <span style="font-size: 0.875rem; color: #6b7280;">ESG重視度</span>
                    <div style="font-weight: 500;">{{ meeting_data.investor_profile.esg_focus|default('高') }}</div>
                </div>
            </div>
            
            <div style="margin-top: 2rem;">
                <h4>🧠 AIインサイト</h4>
                <div style="background: #f3f4ff; padding: 1rem; border-radius: 0.5rem; margin-top: 0.5rem;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.875rem; color: #6b7280;">満足度</span>
                        <span style="font-weight: 600; color: #667eea;">{{ meeting_data.ai_analysis.sentiment_score|default(85) }}%</span>
                    </div>
                    <div style="font-size: 0.875rem; color: #4c51bf;">
                        投資家の関心度が前回より15%上昇しています
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- コンテキスト開閉ボタン -->
    <div class="context-toggle" onclick="toggleContextPanel()">
        <span class="toggle-icon">‹</span>
    </div>
</div>

<!-- JavaScript -->
<script>
// グローバル変数
const meetingId = '{{ meeting_id }}';
let currentStep = 'upload';
let contextPanelCollapsed = false;

// ページ初期化
document.addEventListener('DOMContentLoaded', function() {
    initializeWorkspace();
    setupEventListeners();
    
    // 現在のステージに基づいて表示を更新
    const activeStage = '{{ meeting_data.current_stage|default("ai_summary") }}';
    switchToStage(activeStage);
});

// ワークスペース初期化
function initializeWorkspace() {
    setupDragAndDrop();
    
    // デスクトップでは右パネルを表示（重要：1024px以下の自動非表示を削除）
    // モバイルのみCSSで非表示になるように修正
}

// イベントリスナー設定
function setupEventListeners() {
    document.getElementById('fileInput')?.addEventListener('change', handleFileSelect);
    
    // リサイズ対応（右パネル強制非表示を削除）
    window.addEventListener('resize', function() {
        // モバイル時の処理は CSS media queries に委譲
    });
}

// ステージ切り替え
function switchToStage(stageId) {
    // 全てのステップコンテンツを非表示
    document.querySelectorAll('.step-content').forEach(step => {
        step.classList.remove('active');
    });
    
    // 指定されたステップを表示
    const targetStep = document.getElementById(`step-${stageId}`);
    if (targetStep) {
        targetStep.classList.add('active');
        currentStep = stageId;
    }
    
    // 進捗ストリームの状態更新
    document.querySelectorAll('.stage-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const activeStageItem = document.querySelector(`[data-stage="${stageId}"]`);
    if (activeStageItem) {
        activeStageItem.classList.add('active');
    }
}

// コンテキストパネル切り替え
function toggleContextPanel() {
    const workspace = document.querySelector('.dialogue-workspace');
    const panel = document.querySelector('.context-panel');
    const toggle = document.querySelector('.context-toggle');
    
    contextPanelCollapsed = !contextPanelCollapsed;
    
    if (contextPanelCollapsed) {
        workspace.classList.add('context-collapsed');
        panel.classList.add('collapsed');
    } else {
        workspace.classList.remove('context-collapsed');
        panel.classList.remove('collapsed');
    }
}

// ドラッグ&ドロップ設定
function setupDragAndDrop() {
    const uploadArea = document.getElementById('uploadArea');
    if (!uploadArea) return;
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => {
            uploadArea.style.borderColor = '#667eea';
            uploadArea.style.background = '#f8faff';
        });
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => {
            uploadArea.style.borderColor = '#d1d5db';
            uploadArea.style.background = '#fafafa';
        });
    });
    
    uploadArea.addEventListener('drop', handleDrop);
}

// ファイル処理
function selectFiles() {
    document.getElementById('fileInput').click();
}

function handleFileSelect(e) {
    const files = e.target.files;
    handleFiles(files);
}

function handleDrop(e) {
    const files = e.dataTransfer.files;
    handleFiles(files);
}

function handleFiles(files) {
    console.log('Files selected:', files.length);
    showNotification('ファイルアップロードを開始しました', 'info');
    
    // モック：アップロード処理
    setTimeout(() => {
        showNotification('ファイルアップロードが完了しました', 'success');
        switchToStage('transcription');
    }, 2000);
}

// プロンプトテンプレート
function usePromptTemplate(type) {
    const templates = {
        competition: '競合他社との比較観点で分析してください。特に技術的優位性、市場シェア、成長性の観点から。',
        risk: 'リスク要因を特定し、その影響度と発生可能性を評価してください。',
        opportunity: '新たなビジネス機会や成長可能性について分析してください。'
    };
    
    document.getElementById('customPrompt').value = templates[type];
}

// 再分析
function reanalyzeWithPrompt() {
    const prompt = document.getElementById('customPrompt').value;
    if (!prompt.trim()) {
        showNotification('プロンプトを入力してください', 'warning');
        return;
    }
    
    showNotification('AIが再分析を実行中...', 'info');
    
    setTimeout(() => {
        showNotification('再分析が完了しました', 'success');
    }, 2000);
}

// FAQ生成
function generateMoreFAQs() {
    showNotification('AIがFAQを生成中...', 'info');
    
    setTimeout(() => {
        showNotification('3件の新しいFAQを生成しました', 'success');
    }, 1500);
}

function createManualFAQ() {
    showNotification('手動FAQ作成機能を開発中です', 'info');
}

// 公開処理
function publishContent() {
    showNotification('公開処理を開始しました', 'info');
    
    setTimeout(() => {
        showNotification('コンテンツが正常に公開されました', 'success');
    }, 2000);
}

// ユーティリティ関数
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        padding: 1rem 1.5rem;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        transform: translateX(400px);
        transition: transform 0.3s ease;
        z-index: 3000;
        border-left: 4px solid ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
        color: ${type === 'success' ? '#065f46' : type === 'warning' ? '#92400e' : '#1e40af'};
    `;
    
    const icon = type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
    notification.innerHTML = `${icon} <span>${message}</span>`;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(400px)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function showTimeline() {
    showNotification('処理履歴機能を開発中です', 'info');
}

function shareProgress() {
    showNotification('進捗共有機能を開発中です', 'info');
}

function toggleAIAssistant() {
    showNotification('AIアシスタント機能を開発中です', 'info');
}
</script>
{% endblock %}
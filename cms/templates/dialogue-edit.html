{% extends "base.html" %}

{% block title %}{{ meeting_data.title }} - 統合処理ワークスペース{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/ir-management.css">
<link rel="stylesheet" href="/static/css/dialogue-edit.css">
<style>
/* インラインスタイル（最小限に留める） */
/* 動的プログレス表示 */
.processing-animation {
    position: relative;
    overflow: hidden;
}

.processing-animation::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: slide 1.5s infinite;
}

@keyframes slide {
    to {
        left: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- 対話編集ワークスペース -->
<div class="dialogue-workspace" data-meeting-id="{{ meeting_id }}">
    <!-- 進捗ストリーム（左サイドバー） -->
    <div class="progress-stream">
        <div class="stream-header">
            <h2 class="stream-title">処理進捗</h2>
            <p class="stream-subtitle">{{ meeting_data.progress_percentage|default(65) }}% 完了</p>
            <div class="stream-progress">
                <div class="stream-progress-bar">
                    <div class="stream-progress-fill" data-progress="{{ meeting_data.progress_percentage|default(65) }}"></div>
                </div>
            </div>
        </div>
        
        <div class="progress-stages">
            {% set stages = [
                {'id': 'upload', 'icon': '☁️', 'title': 'ファイルアップロード', 'status': meeting_data.stages.upload.status|default('completed')},
                {'id': 'transcription', 'icon': '🎤', 'title': '文字起こし', 'status': meeting_data.stages.transcription.status|default('completed')},
                {'id': 'ai_summary', 'icon': '🧠', 'title': 'AI分析', 'status': meeting_data.stages.ai_summary.status|default('active')},
                {'id': 'faq', 'icon': '❓', 'title': 'FAQ作成', 'status': meeting_data.stages.faq.status|default('pending')},
                {'id': 'review', 'icon': '✅', 'title': 'レビュー', 'status': meeting_data.stages.review.status|default('pending')},
                {'id': 'publish', 'icon': '🌐', 'title': '公開', 'status': meeting_data.stages.publish.status|default('pending')}
            ] %}
            
            {% for stage in stages %}
            <div class="stage-item {{ stage.status }}" data-stage="{{ stage.id }}" onclick="switchToStage('{{ stage.id }}')">
                <div class="stage-icon">
                    {{ stage.icon }}
                </div>
                <div class="stage-info">
                    <h3 class="stage-title">{{ stage.title }}</h3>
                    <div class="stage-progress {{ stage.status }}">
                        {% if stage.status == 'completed' %}
                        <span class="text-success">✓ 完了</span>
                        {% elif stage.status == 'active' %}
                        <span>処理中...</span>
                        <span class="processing-indicator"></span>
                        {% elif stage.status == 'processing' %}
                        <span>{{ meeting_data.stages[stage.id].progress|default(45) }}%</span>
                        {% else %}
                        <span>待機中</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ワークスペースヘッダー -->
    <div class="workspace-header">
        <div class="header-left">
            <div class="meeting-avatar">
                {{ meeting_data.investor_name[:2]|default('IR') }}
            </div>
            <div class="meeting-info">
                <h1>{{ meeting_data.title|default('投資家面談議事録処理') }}</h1>
                <div class="meeting-meta">
                    {{ meeting_data.formatted_date|default('2024年1月15日') }}
                    <span class="separator">•</span>
                    {{ meeting_data.duration|default('60分') }}
                    <span class="separator">•</span>
                    参加者 {{ meeting_data.participants|default(3) }}名
                </div>
            </div>
        </div>
        
        <div class="header-actions">
            <button class="btn-icon" onclick="showTimeline()" title="処理履歴">
                📈
            </button>
            <button class="btn-icon" onclick="shareProgress()" title="進捗共有">
                📤
            </button>
            <button class="btn-icon" onclick="toggleAIAssistant()" title="AIアシスタント">
                🤖
            </button>
        </div>
    </div>

    <!-- メインワークスペース -->
    <div class="workspace-main">
        <!-- アップロードステップ -->
        <div id="step-upload" class="step-content active">
            <div class="content-header">
                <h2>☁️ ファイルアップロード - 音声・資料の取り込み</h2>
            </div>
            <div class="content-body">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-prompt">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">☁️</div>
                        <h3 style="margin-bottom: 0.5rem; color: #1f2937;">録音・録画ファイルをアップロード</h3>
                        <p style="color: #6b7280; margin-bottom: 1.5rem;">ドラッグ＆ドロップまたはクリックして選択</p>
                        <button class="btn btn-primary btn-lg" onclick="selectFiles()">
                            <span>📎</span>
                            <span>ファイルを選択</span>
                        </button>
                        <div style="margin-top: 1rem; font-size: 0.75rem; color: #9ca3af;">
                            対応ファイル: MP4, MP3, WAV, PDF
                        </div>
                    </div>
                    <input type="file" id="fileInput" multiple accept="video/*,audio/*,.pdf" style="display: none;">
                </div>
                
                <!-- ファイルリスト -->
                <div id="fileList" class="file-list-container" style="display: none;">
                    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">アップロードファイル</h3>
                    <div id="fileItems" style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <!-- 動的にファイルアイテムが追加される -->
                    </div>
                </div>
                
                <!-- ヒント -->
                <div class="hint-panel">
                    <div class="hint-icon">💡</div>
                    <div class="hint-content">
                        <h4 class="hint-title">アップロードのヒント</h4>
                        <ul class="hint-list">
                            <li>音声ファイルと資料PDFを同時にアップロードすると精度が向上します</li>
                            <li>ファイルサイズは1ファイル500MBまで対応しています</li>
                            <li>複数ファイルを同時にアップロード可能です</li>
                        </ul>
                    </div>
                </div>
                
                <!-- アクションボタン -->
                <div class="action-button-area" style="display: none;" id="uploadActions">
                    <button class="btn btn-success btn-lg" onclick="proceedToTranscription()">
                        <span>➡️</span>
                        <span>文字起こしを開始</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 文字起こしステップ -->
        <div id="step-transcription" class="step-content">
            <div class="content-header">
                <h2>🎤 文字起こし - 音声のテキスト化と編集</h2>
            </div>
            <div class="content-body">
                <!-- 処理中表示 -->
                <div id="transcriptionProcessing" class="transcription-processing">
                    <div class="processing-icon">🎤</div>
                    <h3 class="processing-title">文字起こし処理中...</h3>
                    <div class="processing-animation" style="height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; max-width: 400px; margin: 0 auto 1rem;">
                        <div style="height: 100%; background: #667eea; width: 75%; border-radius: 4px;"></div>
                    </div>
                    <p class="processing-subtitle">音声ファイルを解析しています... 75%</p>
                    <p class="processing-time">推定残り時間: 2分</p>
                </div>
                
                <!-- 完了表示 -->
                <div id="transcriptionComplete" style="display: none;">
                    <!-- 統計情報 -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value primary">15,680</div>
                            <div class="stat-label">文字数</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value success">96%</div>
                            <div class="stat-label">認識精度</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value warning">45分</div>
                            <div class="stat-label">録音時間</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value purple">3名</div>
                            <div class="stat-label">話者数</div>
                        </div>
                    </div>
                    
                    <!-- 文字起こしプレビュー -->
                    <div class="transcript-preview">
                        <h3>📄 文字起こしプレビュー</h3>
                        <div class="transcript-content">
                            <p><strong>[投資家A]</strong> 本日はお忙しい中、お時間をいただきありがとうございます。今回の決算説明会では、特にAI事業の成長性についてお伺いしたいと思っています...</p>
                            <p><strong>[CEO]</strong> はい、それでは弊社のAI事業の現状と今後の成長戦略についてご説明させていただきます...</p>
                        </div>
                        
                        <!-- 編集ボタン -->
                        <div class="transcript-actions">
                            <button class="btn btn-secondary" onclick="editTranscription()">
                                <span>✏️</span>
                                <span>文字起こしを編集</span>
                            </button>
                            <button class="btn btn-secondary" onclick="downloadTranscription()">
                                <span>📥</span>
                                <span>ダウンロード</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- アクションボタン -->
                    <div class="action-button-area">
                        <button class="btn btn-success btn-lg" onclick="switchToStage('ai_summary')">
                            <span>➡️</span>
                            <span>AI分析に進む</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI分析ステップ -->
        <div id="step-ai_summary" class="step-content">
            <div class="content-header">
                <h2>🧠 AI分析 - 自動要約と洞察抽出</h2>
            </div>
            <div class="content-body">
                <div class="ai-analysis-section">
                    <!-- カスタムプロンプト入力 -->
                    <div class="custom-prompt-area">
                        <h3>🎯 分析の視点をカスタマイズ</h3>
                        <div class="prompt-input-group">
                            <textarea id="customPrompt" 
                                     class="prompt-textarea"
                                     placeholder="特に注目したい点や、追加の分析視点があれば入力してください..."></textarea>
                            <button class="btn btn-primary" onclick="reanalyzeWithPrompt()">
                                <span>🔄</span>
                                <span>再分析</span>
                            </button>
                        </div>
                        
                        <!-- プロンプトテンプレート -->
                        <div class="prompt-templates">
                            <span class="template-label">テンプレート:</span>
                            <button class="template-btn" onclick="usePromptTemplate('competition')">
                                🏁 競合比較
                            </button>
                            <button class="template-btn" onclick="usePromptTemplate('risk')">
                                ⚠️ リスク分析
                            </button>
                            <button class="template-btn" onclick="usePromptTemplate('opportunity')">
                                💡 機会発見
                            </button>
                            <button class="template-btn" onclick="usePromptTemplate('esg')">
                                🌱 ESG評価
                            </button>
                        </div>
                    </div>
                    
                    <!-- AI分析結果（改善版） -->
                    <div class="analysis-results">
                        <!-- メインサマリー -->
                        <div class="result-card primary">
                            <div class="card-header">
                                <div class="card-icon">📋</div>
                                <h3 class="card-title">エグゼクティブサマリー</h3>
                            </div>
                            <div class="card-content">
                                {{ meeting_data.ai_summary.executive_summary|default('今回の面談では、AI事業の成長戦略について詳細な議論が行われました。投資家からは特に競合優位性と収益性について関心が示され、技術的な差別化要因についても深く検討されました。全体的にポジティブな反応を得られ、今後の成長ポテンシャルに対する期待を確認できました。') }}
                            </div>
                        </div>
                        
                        <!-- 重要ポイント -->
                        <div class="result-card">
                            <div class="card-header">
                                <div class="card-icon">⚡</div>
                                <h3 class="card-title">重要ポイント</h3>
                            </div>
                            <div class="highlight-box">
                                <ul style="margin: 0; padding-left: 1.5rem;">
                                    <li><strong>AI技術の競合優位性</strong> - 独自アルゴリズムの詳細な説明を要求</li>
                                    <li><strong>収益性の向上</strong> - タイムラインと具体的施策に強い関心</li>
                                    <li><strong>ESGファクター</strong> - サステナビリティ戦略について詳細質問</li>
                                    <li><strong>人材確保</strong> - AIエンジニアの採用・保持戦略</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- 投資家の関心領域 -->
                        <div class="result-card">
                            <div class="card-header">
                                <div class="card-icon">💼</div>
                                <h3 class="card-title">投資家の関心領域分析</h3>
                            </div>
                            <div class="card-content">
                                <div class="analysis-insight-grid">
                                    <div class="insight-card tech">
                                        <div class="insight-title">🏆 技術競争力</div>
                                        <p class="insight-description">独自アルゴリズムの優位性</p>
                                        <div class="insight-rating">関心度: ★★★★★</div>
                                    </div>
                                    <div class="insight-card market">
                                        <div class="insight-title">📈 市場拡大性</div>
                                        <p class="insight-description">TAM（市場規模）の成長性</p>
                                        <div class="insight-rating">関心度: ★★★★☆</div>
                                    </div>
                                    <div class="insight-card revenue">
                                        <div class="insight-title">💰 収益性</div>
                                        <p class="insight-description">マネタイズ時期と方法</p>
                                        <div class="insight-rating">関心度: ★★★★★</div>
                                    </div>
                                    <div class="insight-card esg">
                                        <div class="insight-title">🌱 ESG要素</div>
                                        <p class="insight-description">持続可能性への取り組み</p>
                                        <div class="insight-rating">関心度: ★★★★☆</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AIインサイト -->
                        <div class="result-card">
                            <div class="card-header">
                                <div class="card-icon">🤖</div>
                                <h3 class="card-title">AIが検出した重要インサイト</h3>
                            </div>
                            <div class="card-content">
                                <div class="ai-insight-items">
                                    <div class="ai-insight-item">
                                        <span class="insight-icon">🔴</span>
                                        <div class="insight-content">
                                            <strong>緊急対応が必要</strong>
                                            <p>競合会社A社の新製品発表について詳細な分析を求められています</p>
                                        </div>
                                    </div>
                                    <div class="ai-insight-item">
                                        <span class="insight-icon">🔶</span>
                                        <div class="insight-content">
                                            <strong>さらなる説明が望まれる項目</strong>
                                            <p>R&D投資のROIと技術ロードマップの詳細</p>
                                        </div>
                                    </div>
                                    <div class="ai-insight-item">
                                        <span class="insight-icon">🟢</span>
                                        <div class="insight-content">
                                            <strong>ポジティブな反応</strong>
                                            <p>パートナーシップ戦略について高い評価を得ました</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- アクションボタン -->
                    <div class="action-button-area">
                        <button class="btn btn-success btn-lg" onclick="switchToStage('faq')">
                            <span>➡️</span>
                            <span>FAQ作成に進む</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- FAQ作成ステップ -->
        <div id="step-faq" class="step-content">
            <div class="content-header">
                <h2>❓ FAQ作成 - 質疑応答の整理</h2>
            </div>
            <div class="content-body">
                <div class="faq-creation-section">
                    <!-- FAQコントロール -->
                    <div class="faq-controls">
                        <div class="faq-actions">
                            <button class="btn btn-primary" onclick="generateMoreFAQs()">
                                <span>✨</span>
                                <span>AIで追加生成</span>
                            </button>
                            <button class="btn btn-secondary" onclick="createManualFAQ()">
                                <span>➕</span>
                                <span>手動で追加</span>
                            </button>
                            <button class="btn btn-secondary" onclick="importFAQs()">
                                <span>📥</span>
                                <span>インポート</span>
                            </button>
                        </div>
                        <div class="faq-stats">
                            🤖 AI生成: 5件 • 🖐️ 手動作成: 2件 • 📋 合計: 7件
                        </div>
                    </div>
                    
                    <!-- FAQフィルター -->
                    <div class="faq-filters">
                        <button class="filter-btn active" onclick="filterFAQs('all')">すべて</button>
                        <button class="filter-btn" onclick="filterFAQs('ai')">🤖 AI生成</button>
                        <button class="filter-btn" onclick="filterFAQs('manual')">🖐️ 手動作成</button>
                        <button class="filter-btn" onclick="filterFAQs('important')">⭐ 重要</button>
                    </div>
                    
                    <!-- FAQリスト -->
                    <div class="faq-list">
                        <!-- AI生成FAQ 1 -->
                        <div class="faq-item">
                            <div class="faq-item-header">
                                <span class="faq-source-badge">🤖 AI生成</span>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn-icon" style="width: 28px; height: 28px; background: #fef3c7; color: #d97706;" onclick="markImportant(this)">⭐</button>
                                    <button class="btn-icon" style="width: 28px; height: 28px; background: #e0e7ff; color: #4338ca;" onclick="editFAQ(1)">✏️</button>
                                    <button class="btn-icon" style="width: 28px; height: 28px; background: #fee2e2; color: #dc2626;" onclick="deleteFAQ(1)">🗑️</button>
                                </div>
                            </div>
                            <div class="faq-question">
                                <strong>Q:</strong> AI事業の競合優位性はどのような点にありますか？
                            </div>
                            <div class="faq-answer">
                                <strong>A:</strong> 当社のAI事業は、以下の3つの点で競合優位性を確立しています。
                                （1）独自の大規模データセットと高精度アルゴリズム
                                （2）業界特化型モデルの開発と実装経験
                                （3）強固なパートナーエコシステム
                            </div>
                        </div>
                        
                        <!-- AI生成FAQ 2 -->
                        <div class="faq-item">
                            <div class="faq-item-header">
                                <span class="faq-source-badge">🤖 AI生成</span>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn-icon" style="width: 28px; height: 28px; background: #fef3c7; color: #d97706;" onclick="markImportant(this)">⭐</button>
                                    <button class="btn-icon" style="width: 28px; height: 28px; background: #e0e7ff; color: #4338ca;" onclick="editFAQ(2)">✏️</button>
                                    <button class="btn-icon" style="width: 28px; height: 28px; background: #fee2e2; color: #dc2626;" onclick="deleteFAQ(2)">🗑️</button>
                                </div>
                            </div>
                            <div class="faq-question">
                                <strong>Q:</strong> AI事業の収益性向上に向けた具体的なタイムラインは？
                            </div>
                            <div class="faq-answer">
                                <strong>A:</strong> 2025年度にブレークイーブン、その後2年以内に営業利益率20%を目指しています。
                                具体的には、コスト効率化と高付加価値サービスへのシフトを進めています。
                            </div>
                        </div>
                        
                        <!-- 手動作成FAQ -->
                        <div class="faq-item">
                            <div class="faq-item-header">
                                <span class="faq-source-badge" style="background: #d1fae5; color: #059669;">🖐️ 手動作成</span>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn-icon" style="width: 28px; height: 28px; background: #fef3c7; color: #d97706;" onclick="markImportant(this)">⭐</button>
                                    <button class="btn-icon" style="width: 28px; height: 28px; background: #e0e7ff; color: #4338ca;" onclick="editFAQ(3)">✏️</button>
                                    <button class="btn-icon" style="width: 28px; height: 28px; background: #fee2e2; color: #dc2626;" onclick="deleteFAQ(3)">🗑️</button>
                                </div>
                            </div>
                            <div class="faq-question">
                                <strong>Q:</strong> ESGの取り組みと企業価値向上の関係性は？
                            </div>
                            <div class="faq-answer">
                                <strong>A:</strong> ESGへの取り組みを成長戦略の中核に位置づけ、長期的な企業価値向上を図っています。
                                特に环境負荷の低減AI技術の開発により、新たなビジネス機会を創出しています。
                            </div>
                        </div>
                    </div>
                    
                    <!-- FAQ統計 -->
                    <div class="faq-stats-panel">
                        <h4 class="faq-stats-title">📊 FAQ分析</h4>
                        <div class="faq-stats-grid">
                            <div>🏆 最も関心の高いテーマ: 競合優位性</div>
                            <div>📈 カバー率: 85%</div>
                            <div>✅ 承認済み: 4件</div>
                            <div>🔄 レビュー待ち: 3件</div>
                        </div>
                    </div>
                    
                    <!-- アクションボタン -->
                    <div class="action-button-area">
                        <button class="btn btn-success btn-lg" onclick="switchToStage('review')">
                            <span>➡️</span>
                            <span>レビューに進む</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- レビューステップ -->
        <div id="step-review" class="step-content">
            <div class="content-header">
                <h2>✅ レビュー・承認 - 内容確認と承認</h2>
            </div>
            <div class="content-body">
                <div class="review-section">
                    <!-- 承認状況サマリー -->
                    <div class="approval-summary">
                        <div class="approval-card approved">
                            <div class="approval-icon">✓</div>
                            <div class="approval-count">4/6</div>
                            <div class="approval-label">承認済み項目</div>
                        </div>
                        <div class="approval-card pending">
                            <div class="approval-icon">⚠</div>
                            <div class="approval-count">2件</div>
                            <div class="approval-label">要確認事項</div>
                        </div>
                        <div class="approval-card info">
                            <div class="approval-icon">👤</div>
                            <div class="approval-count">山田太郎</div>
                            <div class="approval-label">承認者</div>
                        </div>
                    </div>
                    
                    <!-- 公開前チェックリスト -->
                    <div class="checklist-container">
                        <h3>📋 公開前チェックリスト</h3>
                        <div class="checklist">
                            <label class="checklist-item">
                                <input type="checkbox" checked>
                                <span>文字起こしの精度確認</span>
                                <span class="checklist-status">OK</span>
                            </label>
                            <label class="checklist-item">
                                <input type="checkbox" checked>
                                <span>発言者名の確認と匿名化</span>
                                <span class="checklist-status">OK</span>
                            </label>
                            <label class="checklist-item">
                                <input type="checkbox" checked>
                                <span>機密情報の除外確認</span>
                                <span class="checklist-status">OK</span>
                            </label>
                            <label class="checklist-item">
                                <input type="checkbox" checked>
                                <span>数値・データの正確性確認</span>
                                <span class="checklist-status">OK</span>
                            </label>
                            <label class="checklist-item">
                                <input type="checkbox">
                                <span>FAQ内容の正確性確認</span>
                                <span class="checklist-status warning">要確認</span>
                            </label>
                            <label class="checklist-item">
                                <input type="checkbox">
                                <span>法務・コンプライアンスチェック</span>
                                <span class="checklist-status warning">要確認</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- コメント・フィードバック -->
                    <div style="background: #f8fafc; padding: 1.5rem; border-radius: 0.5rem; margin-top: 1.5rem;">
                        <h3 style="font-size: 1.125rem; font-weight: 600; margin: 0 0 1rem 0;">💬 レビューコメント</h3>
                        
                        <!-- コメント履歴 -->
                        <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1rem;">
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem; border-left: 3px solid #667eea;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <strong style="color: #4338ca;">法務部 - 田中花子</strong>
                                    <span style="font-size: 0.75rem; color: #6b7280;">10分前</span>
                                </div>
                                <p style="margin: 0; font-size: 0.875rem;">競合他社に関する発言の一部を修正する必要があります。具体的な企業名は伏せた方が良いでしょう。</p>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem; border-left: 3px solid #10b981;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <strong style="color: #059669;">IR部 - 佐藤次郎</strong>
                                    <span style="font-size: 0.75rem; color: #6b7280;">30分前</span>
                                </div>
                                <p style="margin: 0; font-size: 0.875rem;">数値データの確認が完了しました。全て正確です。</p>
                            </div>
                        </div>
                        
                        <!-- コメント入力 -->
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" placeholder="コメントを入力..." style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                            <button class="btn btn-primary" onclick="addComment()">
                                <span>📤</span>
                                <span>送信</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 承認アクション -->
                    <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 0.5rem; margin-top: 1.5rem; text-align: center;">
                        <h3 style="font-size: 1.125rem; font-weight: 600; margin: 0 0 1rem 0; color: #0369a1;">承認アクション</h3>
                        <p style="font-size: 0.875rem; color: #0c4a6e; margin-bottom: 1rem;">すべてのチェック項目を確認してから承認してください</p>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button class="btn btn-secondary" onclick="requestChanges()">
                                <span>🔄</span>
                                <span>修正を依頼</span>
                            </button>
                            <button class="btn btn-success btn-lg" onclick="approveAndProceed()">
                                <span>✅</span>
                                <span>承認して公開設定へ</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 公開ステップ -->
        <div id="step-publish" class="step-content">
            <div class="content-header">
                <h2>🌐 公開設定 - 公開・配信</h2>
            </div>
            <div class="content-body">
                <div class="publish-section">
                    <!-- 公開サマリー -->
                    <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 2rem;">
                        <h3 style="font-size: 1.125rem; font-weight: 600; margin: 0 0 1rem 0; color: #0369a1;">📦 公開コンテンツサマリー</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; font-size: 0.875rem;">
                            <div>
                                <strong style="color: #0c4a6e;">ミーティング:</strong> {{ meeting_data.title|default('野村AM決算説明会') }}
                            </div>
                            <div>
                                <strong style="color: #0c4a6e;">日時:</strong> {{ meeting_data.formatted_date|default('2024年1月15日') }}
                            </div>
                            <div>
                                <strong style="color: #0c4a6e;">FAQ数:</strong> 7件
                            </div>
                            <div>
                                <strong style="color: #0c4a6e;">ステータス:</strong> <span style="color: #059669;">公開準備完了</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 公開範囲設定 -->
                    <div class="publish-options">
                        <h3>🎯 公開範囲設定</h3>
                        <div class="publish-option-list">
                            <label class="publish-option" onclick="selectPublishOption('internal')">
                                <input type="radio" name="publish_scope" value="internal" checked>
                                <span class="option-icon">🏢</span>
                                <div class="option-details">
                                    <div class="option-title">社内のみ</div>
                                    <div class="option-description">IR部門・経営陣のみ閲覧可能</div>
                                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                                        アクセス可能: CEO, CFO, IR部門（10名）
                                    </div>
                                </div>
                            </label>
                            
                            <label class="publish-option" onclick="selectPublishOption('investors')">
                                <input type="radio" name="publish_scope" value="investors">
                                <span class="option-icon">👥</span>
                                <div class="option-details">
                                    <div class="option-title">投資家向け</div>
                                    <div class="option-description">FAQのみ投資家サイトで公開</div>
                                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                                        公開内容: FAQ 7件 • 限定公開
                                    </div>
                                </div>
                            </label>
                            
                            <label class="publish-option" onclick="selectPublishOption('full')">
                                <input type="radio" name="publish_scope" value="full">
                                <span class="option-icon">🌍</span>
                                <div class="option-details">
                                    <div class="option-title">全体公開</div>
                                    <div class="option-description">投資家サイトで完全公開</div>
                                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                                        公開内容: サマリー + FAQ + 関連資料
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 詳細設定 -->
                    <div style="background: #f8fafc; padding: 1.5rem; border-radius: 0.5rem; margin-top: 1.5rem;">
                        <h3 style="font-size: 1.125rem; font-weight: 600; margin: 0 0 1rem 0;">⚙️ 詳細設定</h3>
                        
                        <!-- 公開日時 -->
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">公開日時</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary active" onclick="setPublishTime('now')">今すぐ</button>
                                <button class="btn btn-secondary" onclick="setPublishTime('scheduled')">スケジュール</button>
                                <input type="datetime-local" id="scheduleDateTime" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; display: none;">
                            </div>
                        </div>
                        
                        <!-- 通知設定 -->
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">通知設定</label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" checked>
                                <span style="font-size: 0.875rem;">関係者にメール通知を送信</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox">
                                <span style="font-size: 0.875rem;">投資家サイトに新着情報として掲載</span>
                            </label>
                        </div>
                        
                        <!-- アーカイブ設定 -->
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">アーカイブ設定</label>
                            <select style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                <option>期限なし</option>
                                <option>1年後に自動アーカイブ</option>
                                <option>2年後に自動アーカイブ</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 公開前最終確認 -->
                    <div style="background: #fef2f2; padding: 1.5rem; border-radius: 0.5rem; margin-top: 1.5rem; border-left: 4px solid #ef4444;">
                        <h3 style="font-size: 1.125rem; font-weight: 600; margin: 0 0 0.5rem 0; color: #dc2626;">⚠️ 公開前最終確認</h3>
                        <p style="font-size: 0.875rem; color: #7f1d1d; margin-bottom: 1rem;">公開後の取り消しはできません。内容を再度確認してください。</p>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="finalConfirm">
                            <span style="font-size: 0.875rem; color: #7f1d1d;">すべての内容を確認し、公開に同意します</span>
                        </label>
                    </div>
                    
                    <!-- アクションボタン -->
                    <div class="action-button-area">
                        <button class="btn btn-secondary btn-lg" onclick="saveDraft()">
                            <span>💾</span>
                            <span>下書きとして保存</span>
                        </button>
                        <button class="btn btn-success btn-lg" onclick="publishContent()" disabled id="publishButton">
                            <span>🚀</span>
                            <span>公開実行</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- コンテキストパネル（右サイドバー） -->
    <div class="context-panel">
        <div class="panel-header">
            <h3>👤 投資家プロファイル</h3>
            <button class="btn-icon" onclick="toggleContextPanel()" style="color: #6b7280;">
                ❌
            </button>
        </div>
        <div class="panel-content">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.5rem; margin: 0 auto 0.75rem;">
                    {{ meeting_data.investor_name[:2]|default('IR') }}
                </div>
                <h4 style="margin: 0;">{{ meeting_data.investor_name|default('投資家名') }}</h4>
                <p style="color: #6b7280; font-size: 0.875rem;">{{ meeting_data.investor_type|default('機関投資家') }}</p>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <span style="font-size: 0.875rem; color: #6b7280;">投資スタイル</span>
                    <div style="font-weight: 500;">{{ meeting_data.investor_profile.investment_style|default('長期成長') }}</div>
                </div>
                <div>
                    <span style="font-size: 0.875rem; color: #6b7280;">ESG重視度</span>
                    <div style="font-weight: 500;">{{ meeting_data.investor_profile.esg_focus|default('高') }}</div>
                </div>
            </div>
            
            <div style="margin-top: 2rem;">
                <h4>🧠 AIインサイト</h4>
                <div style="background: #f3f4ff; padding: 1rem; border-radius: 0.5rem; margin-top: 0.5rem;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.875rem; color: #6b7280;">満足度</span>
                        <span style="font-weight: 600; color: #667eea;">{{ meeting_data.ai_analysis.sentiment_score|default(85) }}%</span>
                    </div>
                    <div style="font-size: 0.875rem; color: #4c51bf;">
                        投資家の関心度が前回より15%上昇しています
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- コンテキスト開閉ボタン -->
    <div class="context-toggle" onclick="toggleContextPanel()">
        <span class="toggle-icon">‹</span>
    </div>
</div>

<!-- JavaScript -->
<script>
// グローバル変数
const meetingId = '{{ meeting_id }}';
let currentStep = 'upload';
let contextPanelCollapsed = false;
let uploadedFiles = [];
let publishOption = 'internal';

// ページ初期化
document.addEventListener('DOMContentLoaded', function() {
    initializeWorkspace();
    setupEventListeners();
    
    // プログレスバーの動的設定
    setProgressBar();
    
    // 現在のステージに基づいて表示を更新
    const activeStage = '{{ meeting_data.current_stage|default("ai_summary") }}';
    switchToStage(activeStage);
    
    // デモ用: 処理のシミュレーション
    simulateProcessing();
});

// プログレスバーの動的設定
function setProgressBar() {
    const progressFill = document.querySelector('.stream-progress-fill[data-progress]');
    if (progressFill) {
        const progress = progressFill.getAttribute('data-progress');
        progressFill.style.width = progress + '%';
    }
}

// ワークスペース初期化
function initializeWorkspace() {
    setupDragAndDrop();
    setupCheckboxHandlers();
    
    // コンテキストパネルの初期状態を設定
    const savedState = localStorage.getItem('contextPanelCollapsed');
    if (savedState === 'true') {
        toggleContextPanel();
    }
}

// イベントリスナー設定
function setupEventListeners() {
    // ファイル選択
    document.getElementById('fileInput')?.addEventListener('change', handleFileSelect);
    
    // 最終確認チェックボックス
    document.getElementById('finalConfirm')?.addEventListener('change', function(e) {
        const publishBtn = document.getElementById('publishButton');
        if (publishBtn) {
            publishBtn.disabled = !e.target.checked;
        }
    });
    
    // リサイズ対応
    window.addEventListener('resize', handleResize);
}

// ステージ切り替え
function switchToStage(stageId) {
    // 全てのステップコンテンツを非表示
    document.querySelectorAll('.step-content').forEach(step => {
        step.classList.remove('active');
    });
    
    // 指定されたステップを表示
    const targetStep = document.getElementById(`step-${stageId}`);
    if (targetStep) {
        targetStep.classList.add('active');
        currentStep = stageId;
    }
    
    // 進捗ストリームの状態更新
    updateProgressStream(stageId);
    
    // ステージ固有の初期化処理
    initializeStage(stageId);
}

// 進捗ストリーム更新
function updateProgressStream(activeStageId) {
    document.querySelectorAll('.stage-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const activeStageItem = document.querySelector(`[data-stage="${activeStageId}"]`);
    if (activeStageItem) {
        activeStageItem.classList.add('active');
        
        // スクロールしてアクティブなステージを表示
        activeStageItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// ステージ固有の初期化
function initializeStage(stageId) {
    switch(stageId) {
        case 'transcription':
            // デモ: 文字起こし処理をシミュレート
            setTimeout(() => {
                document.getElementById('transcriptionProcessing').style.display = 'none';
                document.getElementById('transcriptionComplete').style.display = 'block';
            }, 3000);
            break;
        case 'ai_summary':
            // AI分析プログレスのアニメーション
            animateAnalysisProgress();
            break;
    }
}

// コンテキストパネル切り替え
function toggleContextPanel() {
    const workspace = document.querySelector('.dialogue-workspace');
    const panel = document.querySelector('.context-panel');
    
    contextPanelCollapsed = !contextPanelCollapsed;
    
    if (contextPanelCollapsed) {
        workspace.classList.add('context-collapsed');
        panel.classList.add('collapsed');
    } else {
        workspace.classList.remove('context-collapsed');
        panel.classList.remove('collapsed');
    }
    
    // 状態を保存
    localStorage.setItem('contextPanelCollapsed', contextPanelCollapsed);
}

// ドラッグ&ドロップ設定
function setupDragAndDrop() {
    const uploadArea = document.getElementById('uploadArea');
    if (!uploadArea) return;
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => {
            uploadArea.classList.add('drag-over');
        });
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => {
            uploadArea.classList.remove('drag-over');
        });
    });
    
    uploadArea.addEventListener('drop', handleDrop);
}

// ファイル処理
function selectFiles() {
    document.getElementById('fileInput').click();
}

function handleFileSelect(e) {
    const files = e.target.files;
    handleFiles(files);
}

function handleDrop(e) {
    const files = e.dataTransfer.files;
    handleFiles(files);
}

function handleFiles(files) {
    uploadedFiles = Array.from(files);
    displayFileList();
    
    // アップロードアクションを表示
    document.getElementById('uploadActions').style.display = 'block';
    
    showNotification(`${files.length}個のファイルが選択されました`, 'info');
}

function displayFileList() {
    const fileList = document.getElementById('fileList');
    const fileItems = document.getElementById('fileItems');
    
    if (!fileList || !fileItems) return;
    
    fileList.style.display = 'block';
    fileItems.innerHTML = '';
    
    uploadedFiles.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        
        const fileInfo = document.createElement('div');
        fileInfo.className = 'file-info';
        fileInfo.innerHTML = `
            <div class="file-name">${file.name}</div>
            <div class="file-size">${formatFileSize(file.size)}</div>
        `;
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn-icon';
        removeBtn.style.cssText = 'width: 28px; height: 28px; background: #fee2e2; color: #dc2626;';
        removeBtn.innerHTML = '×';
        removeBtn.onclick = () => removeFile(index);
        
        fileItem.appendChild(fileInfo);
        fileItem.appendChild(removeBtn);
        fileItems.appendChild(fileItem);
    });
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function removeFile(index) {
    uploadedFiles.splice(index, 1);
    displayFileList();
    
    if (uploadedFiles.length === 0) {
        document.getElementById('fileList').style.display = 'none';
        document.getElementById('uploadActions').style.display = 'none';
    }
}

function proceedToTranscription() {
    if (uploadedFiles.length === 0) {
        showNotification('ファイルを選択してください', 'warning');
        return;
    }
    
    showNotification('文字起こしを開始します', 'info');
    switchToStage('transcription');
}

// プロンプトテンプレート
function usePromptTemplate(type) {
    const templates = {
        competition: '競合他社との比較観点で分析してください。特に技術的優位性、市場シェア、成長性の観点から。',
        risk: 'リスク要因を特定し、その影響度と発生可能性を評価してください。',
        opportunity: '新たなビジネス機会や成長可能性について分析してください。',
        esg: 'ESGの観点から企業価値向上の可能性を分析してください。'
    };
    
    document.getElementById('customPrompt').value = templates[type];
    showNotification('テンプレートが適用されました', 'success');
}

// 再分析
function reanalyzeWithPrompt() {
    const prompt = document.getElementById('customPrompt').value;
    if (!prompt.trim()) {
        showNotification('プロンプトを入力してください', 'warning');
        return;
    }
    
    showNotification('AIが再分析を実行中...', 'info');
    
    // プログレス表示
    animateAnalysisProgress();
    
    setTimeout(() => {
        showNotification('再分析が完了しました', 'success');
    }, 2000);
}

// FAQ関連機能
function generateMoreFAQs() {
    showNotification('AIがFAQを生成中...', 'info');
    
    setTimeout(() => {
        showNotification('3件の新しいFAQを生成しました', 'success');
    }, 1500);
}

function createManualFAQ() {
    showNotification('FAQ作成ダイアログを表示', 'info');
}

function importFAQs() {
    showNotification('インポート機能を開発中です', 'info');
}

function filterFAQs(filter) {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    showNotification(`${filter}のFAQを表示中`, 'info');
}

function editFAQ(id) {
    showNotification(`FAQ #${id} の編集ダイアログを表示`, 'info');
}

function deleteFAQ(id) {
    if (confirm('FAQを削除しますか？')) {
        showNotification('FAQを削除しました', 'success');
    }
}

function markImportant(btn) {
    btn.style.background = btn.style.background === 'rgb(251, 191, 36)' ? '#fef3c7' : '#fbbf24';
    showNotification('重要マークを切り替えました', 'info');
}

// レビュー関連機能
function addComment() {
    const commentInput = event.target.previousElementSibling;
    const comment = commentInput.value.trim();
    
    if (!comment) {
        showNotification('コメントを入力してください', 'warning');
        return;
    }
    
    showNotification('コメントを追加しました', 'success');
    commentInput.value = '';
}

function requestChanges() {
    showNotification('修正依頼を送信しました', 'info');
}

function approveAndProceed() {
    const uncheckedItems = document.querySelectorAll('.checklist-item input[type="checkbox"]:not(:checked)');
    
    if (uncheckedItems.length > 0) {
        showNotification('すべてのチェック項目を確認してください', 'warning');
        return;
    }
    
    showNotification('承認しました', 'success');
    switchToStage('publish');
}

// 公開関連機能
function selectPublishOption(option) {
    publishOption = option;
    
    document.querySelectorAll('.publish-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    
    event.target.closest('.publish-option').classList.add('selected');
}

function setPublishTime(type) {
    document.querySelectorAll('.btn-secondary').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    const dateTimeInput = document.getElementById('scheduleDateTime');
    dateTimeInput.style.display = type === 'scheduled' ? 'block' : 'none';
}

function saveDraft() {
    showNotification('下書きを保存しました', 'success');
}

function publishContent() {
    if (!document.getElementById('finalConfirm').checked) {
        showNotification('最終確認が必要です', 'warning');
        return;
    }
    
    showNotification('公開処理を開始しました', 'info');
    
    setTimeout(() => {
        showNotification('コンテンツが正常に公開されました', 'success');
        window.location.href = '/dialogue-center';
    }, 2000);
}

// その他のヘルパー関数
function editTranscription() {
    showNotification('文字起こし編集モードを開きます', 'info');
}

function downloadTranscription() {
    showNotification('ダウンロードを準備中...', 'info');
}

function showTimeline() {
    showNotification('処理履歴を表示', 'info');
}

function shareProgress() {
    showNotification('進捗共有リンクをコピーしました', 'success');
}

function toggleAIAssistant() {
    showNotification('AIアシスタントを起動', 'info');
}

// チェックボックスハンドラー
function setupCheckboxHandlers() {
    document.querySelectorAll('.checklist-item input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const status = this.parentElement.querySelector('.checklist-status');
            if (this.checked && status) {
                status.textContent = 'OK';
                status.classList.remove('warning');
            }
        });
    });
}

// アニメーション
function animateAnalysisProgress() {
    const progressBars = document.querySelectorAll('.processing-animation > div');
    progressBars.forEach(bar => {
        let width = 65;
        const interval = setInterval(() => {
            width += Math.random() * 5;
            if (width >= 100) {
                width = 100;
                clearInterval(interval);
            }
            bar.style.width = width + '%';
        }, 500);
    });
}

// 処理シミュレーション
function simulateProcessing() {
    // 5秒後にAI分析を完了に
    setTimeout(() => {
        const processingStage = document.querySelector('[data-stage="ai_summary"]');
        if (processingStage) {
            processingStage.classList.remove('active');
            processingStage.classList.remove('processing');
            processingStage.classList.add('completed');
            
            const icon = processingStage.querySelector('.stage-icon');
            if (icon) icon.innerHTML = '✓';
            
            const progress = processingStage.querySelector('.stage-progress');
            if (progress) {
                progress.innerHTML = '<span class="text-success">✓ 完了</span>';
                progress.classList.remove('processing');
            }
        }
    }, 5000);
}

// レスポンシブ対応
function handleResize() {
    if (window.innerWidth <= 1024) {
        const panel = document.querySelector('.context-panel');
        if (panel && !contextPanelCollapsed) {
            toggleContextPanel();
        }
    }
}

// 通知システム
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    const icons = {
        success: '✅',
        warning: '⚠️',
        error: '❌',
        info: 'ℹ️'
    };
    
    notification.innerHTML = `
        <span style="font-size: 1.25rem;">${icons[type]}</span>
        <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    // アニメーション
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);
    
    // 自動的に非表示
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}
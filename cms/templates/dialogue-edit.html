{% extends "base.html" %}

{% block title %}å¯¾è©±è¨˜éŒ²ç·¨é›†{% endblock %}

{% block content %}
<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<div class="flex justify-between items-center mb-lg">
    <div>
        <h2 class="text-2xl font-bold mb-sm">å¯¾è©±è¨˜éŒ²ç·¨é›†</h2>
        <p class="text-muted">å¯¾è©±è¨˜éŒ²ã®ãƒ¡ã‚¿æƒ…å ±ã‚’ç·¨é›†ã—ã¾ã™</p>
    </div>
    <div class="flex gap-md">
        <button class="btn btn-secondary" onclick="cancelEdit()">
            âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
    </div>
</div>

<!-- ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰ -->
<div class="card mb-lg">
    <div class="card-header bg-blue-50">
        <h3 class="text-lg font-semibold flex items-center gap-sm">
            ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±
            <span class="badge badge-info">è¨˜éŒ²ID: {{ record_id }}</span>
        </h3>
    </div>
    <div class="card-body">
        <div class="flex items-start gap-md">
            <div class="file-icon text-4xl">
                {% if dialogue_data.file_name.endswith('.mp4') or dialogue_data.file_name.endswith('.mp3') %}
                    ğŸ™ï¸
                {% elif dialogue_data.file_name.endswith('.pdf') %}
                    ğŸ“„
                {% else %}
                    ğŸ“Š
                {% endif %}
            </div>
            <div class="flex-1">
                <h4 class="font-semibold text-lg mb-sm">{{ dialogue_data.file_name }}</h4>
                <div class="file-meta flex gap-lg text-sm text-muted">
                    <span>ğŸ“Š {{ dialogue_data.file_size }}</span>
                    <span>â±ï¸ {{ dialogue_data.duration }}</span>
                    <span>ğŸ“… {{ dialogue_data.date[:10] }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ãƒ¡ã‚¿æƒ…å ±ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
<form id="editForm">
<div class="grid grid-cols-2 gap-lg">
    <!-- å·¦ã‚«ãƒ©ãƒ ï¼šåŸºæœ¬æƒ…å ± -->
    <div>
        <!-- ä¼šè­°åŸºæœ¬æƒ…å ± -->
        <div class="card mb-lg">
            <div class="card-header">
                <h3 class="text-lg font-semibold">ğŸ“‹ ä¼šè­°åŸºæœ¬æƒ…å ±</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label required">ä¼šè­°ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" class="form-control" name="title" value="{{ dialogue_data.title }}" placeholder="ä¾‹ï¼šâ—‹â—‹ç¤¾ã¨ã®æ±ºç®—èª¬æ˜ä¼š">
                    <small class="text-muted">æŠ•è³‡å®¶åã‚„ä¼šè­°ã®ç¨®é¡ã‚’å«ã‚ã¦ãã ã•ã„</small>
                </div>

                <div class="grid grid-cols-2 gap-md">
                    <div class="form-group">
                        <label class="form-label required">ä¼šè­°ç¨®åˆ¥</label>
                        <select class="form-control" name="type">
                            <option {% if dialogue_data.type == "å€‹åˆ¥é¢è«‡" %}selected{% endif %}>å€‹åˆ¥é¢è«‡</option>
                            <option {% if dialogue_data.type == "æ±ºç®—èª¬æ˜ä¼š" %}selected{% endif %}>æ±ºç®—èª¬æ˜ä¼š</option>
                            <option {% if dialogue_data.type == "ã‚¹ãƒ¢ãƒ¼ãƒ«ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°" %}selected{% endif %}>ã‚¹ãƒ¢ãƒ¼ãƒ«ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°</option>
                            <option {% if dialogue_data.type == "ã‚«ãƒ³ãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹" %}selected{% endif %}>ã‚«ãƒ³ãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹</option>
                            <option {% if dialogue_data.type == "é›»è©±ä¼šè­°" %}selected{% endif %}>é›»è©±ä¼šè­°</option>
                            <option {% if dialogue_data.type == "ãã®ä»–" %}selected{% endif %}>ãã®ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">é–‹å‚¬æ—¥æ™‚</label>
                        <input type="datetime-local" class="form-control" name="date" value="{{ dialogue_data.date }}">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">å‚åŠ è€…æ•°</label>
                    <input type="number" class="form-control" name="participants" value="{{ dialogue_data.participants }}">
                </div>
            </div>
        </div>

        <!-- æŠ•è³‡å®¶æƒ…å ± -->
        <div class="card mb-lg">
            <div class="card-header">
                <h3 class="text-lg font-semibold">ğŸ¢ æŠ•è³‡å®¶æƒ…å ±</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label required">æŠ•è³‡å®¶å</label>
                    <input type="text" class="form-control" name="investor_name" value="{{ dialogue_data.investor_name }}" placeholder="æŠ•è³‡å®¶åã‚’å…¥åŠ›">
                </div>

                <div class="grid grid-cols-2 gap-md">
                    <div class="form-group">
                        <label class="form-label">æŠ•è³‡å®¶ã‚¿ã‚¤ãƒ—</label>
                        <select class="form-control" name="investor_type">
                            <option {% if dialogue_data.investor_type == "å›½å†…æ©Ÿé–¢æŠ•è³‡å®¶" %}selected{% endif %}>å›½å†…æ©Ÿé–¢æŠ•è³‡å®¶</option>
                            <option {% if dialogue_data.investor_type == "æµ·å¤–æ©Ÿé–¢æŠ•è³‡å®¶" %}selected{% endif %}>æµ·å¤–æ©Ÿé–¢æŠ•è³‡å®¶</option>
                            <option {% if dialogue_data.investor_type == "å€‹äººæŠ•è³‡å®¶" %}selected{% endif %}>å€‹äººæŠ•è³‡å®¶</option>
                            <option {% if dialogue_data.investor_type == "ã‚¢ãƒŠãƒªã‚¹ãƒˆ" %}selected{% endif %}>ã‚¢ãƒŠãƒªã‚¹ãƒˆ</option>
                            <option {% if dialogue_data.investor_type == "ãã®ä»–" %}selected{% endif %}>ãã®ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ä¿æœ‰çŠ¶æ³</label>
                        <select class="form-control" name="holding_status">
                            <option {% if dialogue_data.holding_status == "å¤§æ ªä¸»ï¼ˆ5%ä»¥ä¸Šï¼‰" %}selected{% endif %}>å¤§æ ªä¸»ï¼ˆ5%ä»¥ä¸Šï¼‰</option>
                            <option {% if dialogue_data.holding_status == "ä¸»è¦æ ªä¸»ï¼ˆ1-5%ï¼‰" %}selected{% endif %}>ä¸»è¦æ ªä¸»ï¼ˆ1-5%ï¼‰</option>
                            <option {% if dialogue_data.holding_status == "ä¸€èˆ¬æ ªä¸»ï¼ˆ1%æœªæº€ï¼‰" %}selected{% endif %}>ä¸€èˆ¬æ ªä¸»ï¼ˆ1%æœªæº€ï¼‰</option>
                            <option {% if dialogue_data.holding_status == "éä¿æœ‰ï¼ˆé–¢å¿ƒã‚ã‚Šï¼‰" %}selected{% endif %}>éä¿æœ‰ï¼ˆé–¢å¿ƒã‚ã‚Šï¼‰</option>
                            <option {% if dialogue_data.holding_status == "è¤‡æ•°" %}selected{% endif %}>è¤‡æ•°</option>
                            <option {% if dialogue_data.holding_status == "ä¸æ˜" %}selected{% endif %}>ä¸æ˜</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å³ã‚«ãƒ©ãƒ ï¼šå¯¾è©±æƒ…å ± -->
    <div>
        <!-- è‡ªç¤¾å‚åŠ è€… -->
        <div class="card mb-lg">
            <div class="card-header">
                <h3 class="text-lg font-semibold">ğŸ‘¥ è‡ªç¤¾å‚åŠ è€…</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">ä¸»è¦èª¬æ˜è€…</label>
                    <div class="participant-list">
                        {% for participant in dialogue_data.company_participants %}
                        <div class="participant-tag">
                            <span>{{ participant }}</span>
                            <button type="button" class="btn-remove" onclick="removeParticipant(this)">Ã—</button>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-sm btn-secondary mt-sm" onclick="addParticipant()">+ å‚åŠ è€…è¿½åŠ </button>
                </div>
            </div>
        </div>

        <!-- é‡è¦åº¦ãƒ»æ©Ÿå¯†åº¦è¨­å®š -->
        <div class="card mb-lg">
            <div class="card-header">
                <h3 class="text-lg font-semibold">âš¡ é‡è¦åº¦ãƒ»æ©Ÿå¯†åº¦è¨­å®š</h3>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-2 gap-md">
                    <div class="form-group">
                        <label class="form-label">é‡è¦åº¦</label>
                        <select class="form-control" name="importance">
                            <option {% if dialogue_data.importance == "ä½" %}selected{% endif %}>ä½</option>
                            <option {% if dialogue_data.importance == "ä¸­" %}selected{% endif %}>ä¸­</option>
                            <option {% if dialogue_data.importance == "é«˜" %}selected{% endif %}>é«˜</option>
                            <option {% if dialogue_data.importance == "æœ€é‡è¦" %}selected{% endif %}>æœ€é‡è¦</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ©Ÿå¯†åº¦</label>
                        <select class="form-control" name="confidentiality">
                            <option {% if dialogue_data.confidentiality == "ä¸€èˆ¬" %}selected{% endif %}>ä¸€èˆ¬</option>
                            <option {% if dialogue_data.confidentiality == "ç¤¾å†…é™å®š" %}selected{% endif %}>ç¤¾å†…é™å®š</option>
                            <option {% if dialogue_data.confidentiality == "å½¹å“¡é™å®š" %}selected{% endif %}>å½¹å“¡é™å®š</option>
                            <option {% if dialogue_data.confidentiality == "æ¥µç§˜" %}selected{% endif %}>æ¥µç§˜</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ã‚¿ã‚°ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
                    <div class="tag-input">
                        {% for tag in dialogue_data.tags %}
                        <span class="tag">{{ tag }}</span>
                        {% endfor %}
                        <input type="text" placeholder="ã‚¿ã‚°ã‚’è¿½åŠ ..." class="tag-input-field" onkeypress="handleTagInput(event)">
                    </div>
                </div>
            </div>
        </div>

        <!-- å…¬é–‹è¨­å®š -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold">ğŸ”’ å…¬é–‹è¨­å®š</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">å…¬é–‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                    <select class="form-control" name="public_status">
                        <option>éå…¬é–‹ï¼ˆIRéƒ¨é–€ã®ã¿ï¼‰</option>
                        <option>ç¤¾å†…å…¬é–‹</option>
                        <option selected>æŠ•è³‡å®¶é™å®šå…¬é–‹</option>
                        <option>ä¸€èˆ¬å…¬é–‹</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">å…¬é–‹äºˆå®šæ—¥æ™‚</label>
                    <input type="datetime-local" class="form-control" name="public_date">
                    <small class="text-muted">ç©ºæ¬„ã®å ´åˆã¯å³æ™‚å…¬é–‹</small>
                </div>
            </div>
        </div>
    </div>
</div>
</form>

<!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
<div class="action-bar">
    <div class="flex justify-between items-center">
        <div class="text-muted">
            <span>ğŸ’¡ æœ€çµ‚æ›´æ–°: {{ current_time }}</span>
        </div>
        <div class="flex gap-md">
            <button class="btn btn-secondary" onclick="cancelEdit()">
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button class="btn btn-primary" onclick="saveChanges()">
                å¤‰æ›´ã‚’ä¿å­˜
            </button>
        </div>
    </div>
</div>

<style>
/* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã«è¿½åŠ  */
.participant-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
}

.participant-tag {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background-color: var(--kagami-blue);
    color: white;
    border-radius: var(--border-radius-full);
    font-size: var(--text-sm);
}

.btn-remove {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 1.2rem;
    line-height: 1;
    padding: 0;
    margin-left: var(--space-xs);
}

.btn-remove:hover {
    opacity: 0.8;
}

/* ã‚¿ã‚°å…¥åŠ› */
.tag-input {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    padding: var(--space-sm);
    border: 1px solid var(--gray-300);
    border-radius: var(--border-radius-md);
    background-color: white;
    min-height: 44px;
}

.tag {
    display: inline-flex;
    align-items: center;
    padding: var(--space-xs) var(--space-sm);
    background-color: var(--kagami-blue);
    color: white;
    border-radius: var(--border-radius-full);
    font-size: var(--text-sm);
}

.tag-input-field {
    flex: 1;
    min-width: 120px;
    border: none;
    outline: none;
    font-size: var(--text-sm);
}

/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ */
.action-bar {
    position: sticky;
    bottom: 0;
    background-color: white;
    border-top: 1px solid var(--gray-200);
    padding: var(--space-lg);
    margin: var(--space-lg) calc(-1 * var(--space-lg)) calc(-1 * var(--space-lg));
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
}

/* å¿…é ˆé …ç›® */
.form-label.required::after {
    content: ' *';
    color: var(--error-red);
}

/* ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ± */
.file-icon {
    font-size: 3rem;
}

.file-meta {
    display: flex;
    gap: var(--space-lg);
    color: var(--gray-600);
}

/* ãƒãƒƒã‚¸ */
.badge-info {
    background-color: rgba(59, 130, 246, 0.1);
    color: var(--kagami-blue);
}
</style>

{% endblock %}

{% block extra_js %}
<script>
// ã‚­ãƒ£ãƒ³ã‚»ãƒ«
function cancelEdit() {
    if (confirm('å¤‰æ›´ã‚’ç ´æ£„ã—ã¦æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
        window.location.href = '/dialogue';
    }
}

// å¤‰æ›´ã‚’ä¿å­˜
function saveChanges() {
    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
    const formData = new FormData(document.getElementById('editForm'));
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    console.log('ä¿å­˜ãƒ‡ãƒ¼ã‚¿:', data);
    
    // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ã“ã“ã§APIã‚’å‘¼ã³å‡ºã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    showNotification('å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
    
    // 2ç§’å¾Œã«ä¸€è¦§ç”»é¢ã¸æˆ»ã‚‹
    setTimeout(() => {
        window.location.href = '/dialogue';
    }, 2000);
}

// å‚åŠ è€…ã‚’å‰Šé™¤
function removeParticipant(button) {
    button.parentElement.remove();
}

// å‚åŠ è€…ã‚’è¿½åŠ 
function addParticipant() {
    const name = prompt('å‚åŠ è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šCEO - å±±ç”°å¤ªéƒï¼‰');
    if (name) {
        const list = document.querySelector('.participant-list');
        const tag = document.createElement('div');
        tag.className = 'participant-tag';
        tag.innerHTML = `
            <span>${name}</span>
            <button type="button" class="btn-remove" onclick="removeParticipant(this)">Ã—</button>
        `;
        list.insertBefore(tag, list.lastElementChild);
    }
}

// ã‚¿ã‚°å…¥åŠ›å‡¦ç†
function handleTagInput(event) {
    if (event.key === 'Enter' && event.target.value.trim()) {
        event.preventDefault();
        const tag = document.createElement('span');
        tag.className = 'tag';
        tag.textContent = event.target.value.trim();
        event.target.parentElement.insertBefore(tag, event.target);
        event.target.value = '';
    }
}

// é€šçŸ¥è¡¨ç¤º
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);
    
    // 3ç§’å¾Œã«å‰Šé™¤
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

// é€šçŸ¥ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ 
const notificationStyle = document.createElement('style');
notificationStyle.textContent = `
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: var(--space-md) var(--space-lg);
    background-color: white;
    border-radius: var(--border-radius-md);
    box-shadow: var(--shadow-lg);
    transform: translateX(400px);
    transition: transform 0.3s ease;
    z-index: 1000;
}

.notification.show {
    transform: translateX(0);
}

.notification-success {
    border-left: 4px solid var(--success-green);
}

.notification-error {
    border-left: 4px solid var(--error-red);
}

.notification-info {
    border-left: 4px solid var(--kagami-blue);
}
`;
document.head.appendChild(notificationStyle);
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}{{ meeting_data.title }} - çµ±åˆå‡¦ç†ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/ir-management.css">
<style>
/* å¯¾è©±ç·¨é›†ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.dialogue-workspace {
    display: grid;
    grid-template-columns: 320px 1fr 400px;
    grid-template-rows: auto 1fr;
    height: calc(100vh - 140px);
    gap: 1rem;
    grid-template-areas: 
        "progress-stream workspace-header context-panel"
        "progress-stream workspace-main context-panel";
    transition: grid-template-columns 0.3s ease;
}

.dialogue-workspace.context-collapsed {
    grid-template-columns: 320px 1fr 0px;
    grid-template-areas: 
        "progress-stream workspace-header context-panel"
        "progress-stream workspace-main context-panel";
}

/* é€²æ—ã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼ˆå·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼‰ */
.progress-stream {
    grid-area: progress-stream;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.stream-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
}

.stream-title {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.stream-subtitle {
    font-size: 0.875rem;
    opacity: 0.9;
}

/* é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¸ */
.progress-stages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
}

.stage-item {
    border: 2px solid transparent;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    background: white;
    border-left: 4px solid #e5e7eb;
}

.stage-item:hover {
    border-color: #d1d5db;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.stage-item.completed {
    border-left-color: #10b981;
    background: #f0fdf4;
}

.stage-item.active {
    border-left-color: #667eea;
    background: #f3f4ff;
}

.stage-item.processing {
    border-left-color: #f59e0b;
    background: #fffbeb;
}

.stage-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.stage-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    margin-right: 0.75rem;
}

.stage-item.completed .stage-icon {
    background: #10b981;
    color: white;
}

.stage-item.active .stage-icon {
    background: #667eea;
    color: white;
}

.stage-item.processing .stage-icon {
    background: #f59e0b;
    color: white;
}

.stage-item:not(.completed):not(.active):not(.processing) .stage-icon {
    background: #e5e7eb;
    color: #6b7280;
}

.stage-title {
    font-weight: 600;
    color: #374151;
    margin: 0;
    font-size: 0.875rem;
}

.stage-progress {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.25rem;
}

.stage-progress.processing {
    color: #f59e0b;
    font-weight: 500;
}

/* ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ */
.workspace-header {
    grid-area: workspace-header;
    background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.meeting-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.125rem;
}

.meeting-info h1 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
}

.meeting-meta {
    margin-top: 0.25rem;
    font-size: 0.875rem;
    opacity: 0.9;
}

.header-actions {
    display: flex;
    gap: 0.5rem;
}

/* ãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ */
.workspace-main {
    grid-area: workspace-main;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

/* ã‚¹ãƒ†ãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
.step-content {
    flex: 1;
    overflow-y: auto;
    display: none;
}

.step-content.active {
    display: block;
}

.content-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    background: #f8fafc;
}

.content-body {
    padding: 1.5rem;
    flex: 1;
}

/* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã‚¹ã‚¿ã‚¤ãƒ« */
.upload-area {
    border: 2px dashed #d1d5db;
    border-radius: 0.75rem;
    padding: 3rem;
    text-align: center;
    transition: all 0.3s ease;
    background: #fafafa;
}

.upload-area:hover {
    border-color: #667eea;
    background: #f8faff;
}

/* AIåˆ†æçµæœã®æ”¹å–„ã•ã‚ŒãŸã‚¹ã‚¿ã‚¤ãƒ« */
.analysis-results {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.result-card {
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    border-radius: 1rem;
    padding: 2rem;
    border: 1px solid #e5e7eb;
    position: relative;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
}

.result-card:hover {
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.result-card.primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.result-card.primary .card-title {
    color: white;
}

.result-card.primary .card-content {
    color: rgba(255, 255, 255, 0.95);
}

.card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
}

.card-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(102, 126, 234, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.result-card.primary .card-icon {
    background: rgba(255, 255, 255, 0.2);
}

.card-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0;
}

.card-content {
    color: #4b5563;
    line-height: 1.7;
    font-size: 0.95rem;
}

.highlight-box {
    background: #eff6ff;
    border-left: 4px solid #3b82f6;
    padding: 1rem;
    border-radius: 0.5rem;
    margin: 1rem 0;
}

/* ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ãƒãƒ«ï¼ˆå³ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼‰ */
.context-panel {
    grid-area: context-panel;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
}

.context-panel.collapsed {
    width: 0;
    min-width: 0;
    overflow: hidden;
    opacity: 0;
    pointer-events: none;
}

.panel-header {
    background: #f8fafc;
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.panel-content {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
}

/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é–‹é–‰ãƒœã‚¿ãƒ³ */
.context-toggle {
    position: fixed;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    width: 45px;
    height: 120px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 22px 0 0 22px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 100;
    transition: all 0.3s ease;
    box-shadow: -2px 0 8px rgba(0, 0, 0, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.2);
    padding: 8px 0;
}

.context-toggle:hover {
    background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
    transform: translateY(-50%) translateX(-5px);
}

.toggle-icon {
    color: white;
    font-size: 1.25rem;
    transition: transform 0.3s ease;
}

.context-collapsed .toggle-icon {
    transform: rotate(180deg);
}

/* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    background: #5a67d8;
}

.btn-secondary {
    background: #e5e7eb;
    color: #374151;
}

.btn-secondary:hover {
    background: #d1d5db;
}

.btn-success {
    background: #10b981;
    color: white;
}

.btn-success:hover {
    background: #059669;
}

.btn-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    padding: 0;
    border: none;
    border-radius: 0.375rem;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-icon:hover {
    background: rgba(255, 255, 255, 0.2);
}

/* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
.separator {
    color: rgba(255, 255, 255, 0.5);
    margin: 0 0.5rem;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 1024px) {
    .dialogue-workspace {
        grid-template-columns: 280px 1fr 0px;
        grid-template-areas: 
            "progress-stream workspace-header context-panel"
            "progress-stream workspace-main context-panel";
    }
    
    .context-panel {
        display: none;
    }
}

@media (max-width: 768px) {
    .dialogue-workspace {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr;
        grid-template-areas: 
            "workspace-header"
            "progress-stream"
            "workspace-main";
    }
    
    .progress-stream {
        max-height: 200px;
    }
    
    .progress-stages {
        display: flex;
        overflow-x: auto;
        flex-direction: row;
        padding: 1rem;
        gap: 1rem;
        -webkit-overflow-scrolling: touch;
    }
    
    .stage-item {
        min-width: 200px;
        margin-bottom: 0;
    }
    
    .header-left {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .meeting-info h1 {
        font-size: 1.125rem;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- å¯¾è©±ç·¨é›†ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ -->
<div class="dialogue-workspace" data-meeting-id="{{ meeting_id }}">
    <!-- é€²æ—ã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼ˆå·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼‰ -->
    <div class="progress-stream">
        <div class="stream-header">
            <h2 class="stream-title">å‡¦ç†é€²æ—</h2>
            <p class="stream-subtitle">{{ meeting_data.progress_percentage|default(65) }}% å®Œäº†</p>
        </div>
        
        <div class="progress-stages">
            {% set stages = [
                {'id': 'upload', 'icon': 'â˜ï¸', 'title': 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰', 'status': meeting_data.stages.upload.status|default('completed')},
                {'id': 'transcription', 'icon': 'ğŸ¤', 'title': 'æ–‡å­—èµ·ã“ã—', 'status': meeting_data.stages.transcription.status|default('completed')},
                {'id': 'ai_summary', 'icon': 'ğŸ§ ', 'title': 'AIåˆ†æ', 'status': meeting_data.stages.ai_summary.status|default('active')},
                {'id': 'faq', 'icon': 'â“', 'title': 'FAQä½œæˆ', 'status': meeting_data.stages.faq.status|default('pending')},
                {'id': 'review', 'icon': 'âœ…', 'title': 'ãƒ¬ãƒ“ãƒ¥ãƒ¼', 'status': meeting_data.stages.review.status|default('pending')},
                {'id': 'publish', 'icon': 'ğŸŒ', 'title': 'å…¬é–‹', 'status': meeting_data.stages.publish.status|default('pending')}
            ] %}
            
            {% for stage in stages %}
            <div class="stage-item {{ stage.status }}" data-stage="{{ stage.id }}" onclick="switchToStage('{{ stage.id }}')">
                <div class="stage-header">
                    <div class="stage-icon">
                        {{ stage.icon }}
                    </div>
                </div>
                <h3 class="stage-title">{{ stage.title }}</h3>
                <div class="stage-progress {{ stage.status }}">
                    {% if stage.status == 'completed' %}
                    å®Œäº†
                    {% elif stage.status == 'active' %}
                    å‡¦ç†ä¸­...
                    {% elif stage.status == 'processing' %}
                    {{ meeting_data.stages[stage.id].progress|default(45) }}%
                    {% else %}
                    å¾…æ©Ÿä¸­
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="workspace-header">
        <div class="header-left">
            <div class="meeting-avatar">
                {{ meeting_data.investor_name[:2]|default('IR') }}
            </div>
            <div class="meeting-info">
                <h1>{{ meeting_data.title|default('æŠ•è³‡å®¶é¢è«‡è­°äº‹éŒ²å‡¦ç†') }}</h1>
                <div class="meeting-meta">
                    {{ meeting_data.formatted_date|default('2024å¹´1æœˆ15æ—¥') }}
                    <span class="separator">â€¢</span>
                    {{ meeting_data.duration|default('60åˆ†') }}
                    <span class="separator">â€¢</span>
                    å‚åŠ è€… {{ meeting_data.participants|default(3) }}å
                </div>
            </div>
        </div>
        
        <div class="header-actions">
            <button class="btn-icon" onclick="showTimeline()" title="å‡¦ç†å±¥æ­´">
                ğŸ“ˆ
            </button>
            <button class="btn-icon" onclick="shareProgress()" title="é€²æ—å…±æœ‰">
                ğŸ“¤
            </button>
            <button class="btn-icon" onclick="toggleAIAssistant()" title="AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ">
                ğŸ¤–
            </button>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ -->
    <div class="workspace-main">
        <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¹ãƒ†ãƒƒãƒ— -->
        <div id="step-upload" class="step-content active">
            <div class="content-header">
                <h2>â˜ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
            </div>
            <div class="content-body">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-prompt">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">â˜ï¸</div>
                        <p>éŒ²éŸ³ãƒ»éŒ²ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
                        <p style="color: #6b7280; font-size: 0.875rem;">ã¾ãŸã¯</p>
                        <button class="btn btn-primary" onclick="selectFiles()">
                            ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                        </button>
                    </div>
                    <input type="file" id="fileInput" multiple accept="video/*,audio/*,.pdf" style="display: none;">
                </div>
                
                <div style="background: #f3f4ff; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; display: flex; gap: 1rem;">
                    <div style="color: #667eea; font-size: 1.25rem;">
                        ğŸ’¡
                    </div>
                    <div style="flex: 1; font-size: 0.875rem; color: #4c51bf;">
                        <p>{{ meeting_data.investor_name|default('æŠ•è³‡å®¶') }}ã¨ã®éå»ã®é¢è«‡ã§ã¯ã€éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã¨è³‡æ–™PDFã®çµ„ã¿åˆã‚ã›ã§æœ€è‰¯ã®çµæœãŒå¾—ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–‡å­—èµ·ã“ã—ã‚¹ãƒ†ãƒƒãƒ— -->
        <div id="step-transcription" class="step-content">
            <div class="content-header">
                <h2>ğŸ¤ æ–‡å­—èµ·ã“ã—</h2>
            </div>
            <div class="content-body">
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ¤</div>
                    <h3>æ–‡å­—èµ·ã“ã—å‡¦ç†å®Œäº†</h3>
                    <p style="color: #6b7280;">éŸ³å£°ã®è§£æãŒå®Œäº†ã—ã€é«˜ç²¾åº¦ãªãƒ†ã‚­ã‚¹ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚</p>
                    <button class="btn btn-primary" onclick="switchToStage('ai_summary')">
                        â¡ï¸ AIåˆ†æã«é€²ã‚€
                    </button>
                </div>
            </div>
        </div>

        <!-- AIåˆ†æã‚¹ãƒ†ãƒƒãƒ— -->
        <div id="step-ai_summary" class="step-content">
            <div class="content-header">
                <h2>ğŸ§  AIåˆ†æãƒ»è¦ç´„</h2>
            </div>
            <div class="content-body">
                <div class="ai-analysis-section">
                    <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ› -->
                    <div style="margin-bottom: 2rem;">
                        <h3>åˆ†æã®è¦–ç‚¹ã‚’è¿½åŠ </h3>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <textarea id="customPrompt" 
                                     placeholder="ç‰¹ã«æ³¨ç›®ã—ãŸã„ç‚¹ã‚„ã€è¿½åŠ ã®åˆ†æè¦–ç‚¹ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„..."
                                     style="flex: 1; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; resize: none; min-height: 80px;"></textarea>
                            <button class="btn btn-primary" onclick="reanalyzeWithPrompt()">
                                ğŸ”„ å†åˆ†æ
                            </button>
                        </div>
                        
                        <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ -->
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <span style="font-size: 0.875rem; color: #6b7280;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ:</span>
                            <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.75rem;" onclick="usePromptTemplate('competition')">
                                ç«¶åˆæ¯”è¼ƒ
                            </button>
                            <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.75rem;" onclick="usePromptTemplate('risk')">
                                ãƒªã‚¹ã‚¯åˆ†æ
                            </button>
                            <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.75rem;" onclick="usePromptTemplate('opportunity')">
                                æ©Ÿä¼šç™ºè¦‹
                            </button>
                        </div>
                    </div>
                    
                    <!-- AIåˆ†æçµæœï¼ˆæ”¹å–„ç‰ˆï¼‰ -->
                    <div class="analysis-results">
                        <div class="result-card primary">
                            <div class="card-header">
                                <div class="card-icon">ğŸ“‹</div>
                                <h3 class="card-title">é¢è«‡ã‚µãƒãƒªãƒ¼</h3>
                            </div>
                            <div class="card-content">
                                {{ meeting_data.ai_summary.executive_summary|default('ä»Šå›ã®é¢è«‡ã§ã¯ã€AIäº‹æ¥­ã®æˆé•·æˆ¦ç•¥ã«ã¤ã„ã¦è©³ç´°ãªè­°è«–ãŒè¡Œã‚ã‚Œã¾ã—ãŸã€‚æŠ•è³‡å®¶ã‹ã‚‰ã¯ç‰¹ã«ç«¶åˆå„ªä½æ€§ã¨åç›Šæ€§ã«ã¤ã„ã¦é–¢å¿ƒãŒç¤ºã•ã‚Œã€æŠ€è¡“çš„ãªå·®åˆ¥åŒ–è¦å› ã«ã¤ã„ã¦ã‚‚æ·±ãæ¤œè¨ã•ã‚Œã¾ã—ãŸã€‚') }}
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <div class="card-header">
                                <div class="card-icon">âš¡</div>
                                <h3 class="card-title">é‡è¦ãƒã‚¤ãƒ³ãƒˆ</h3>
                            </div>
                            <div class="highlight-box">
                                <ul style="margin: 0; padding-left: 1.5rem;">
                                    <li>AIæŠ€è¡“ã®ç«¶åˆå„ªä½æ€§ã«ã¤ã„ã¦è©³ç´°ãªèª¬æ˜ã‚’è¦æ±‚</li>
                                    <li>åç›Šæ€§ã®å‘ä¸Šã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã«å¼·ã„é–¢å¿ƒ</li>
                                    <li>ESGè¦³ç‚¹ã§ã®ä¼æ¥­ä¾¡å€¤å‰µé€ ã«ã¤ã„ã¦è³ªå•</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <div class="card-header">
                                <div class="card-icon">ğŸ’¼</div>
                                <h3 class="card-title">æŠ•è³‡å®¶ã®é–¢å¿ƒé ˜åŸŸ</h3>
                            </div>
                            <div class="card-content">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                    <div style="background: #f0f9ff; padding: 1rem; border-radius: 0.5rem; border-left: 3px solid #0ea5e9;">
                                        <strong>æŠ€è¡“ç«¶äº‰åŠ›</strong>
                                        <p style="margin: 0.25rem 0 0; font-size: 0.875rem;">ç‹¬è‡ªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®å„ªä½æ€§</p>
                                    </div>
                                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; border-left: 3px solid #22c55e;">
                                        <strong>å¸‚å ´æ‹¡å¤§æ€§</strong>
                                        <p style="margin: 0.25rem 0 0; font-size: 0.875rem;">TAMï¼ˆå¸‚å ´è¦æ¨¡ï¼‰ã®æˆé•·æ€§</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; text-align: center;">
                        <button class="btn btn-success" onclick="switchToStage('faq')">
                            â¡ï¸ FAQä½œæˆã«é€²ã‚€
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- FAQä½œæˆã‚¹ãƒ†ãƒƒãƒ— -->
        <div id="step-faq" class="step-content">
            <div class="content-header">
                <h2>â“ FAQä½œæˆãƒ»ç®¡ç†</h2>
            </div>
            <div class="content-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="generateMoreFAQs()">
                            âœ¨ AIã§è¿½åŠ ç”Ÿæˆ
                        </button>
                        <button class="btn btn-secondary" onclick="createManualFAQ()">
                            â• æ‰‹å‹•ã§è¿½åŠ 
                        </button>
                    </div>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                        AIç”Ÿæˆ: 3ä»¶ â€¢ æ‰‹å‹•ä½œæˆ: 1ä»¶
                    </div>
                </div>
                
                <!-- FAQä¸€è¦§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    {% for i in range(3) %}
                    <div style="background: #f8fafc; border-left: 3px solid #667eea; border-radius: 0.5rem; padding: 1rem;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="background: #e0e7ff; color: #4338ca; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 500;">
                                ğŸ¤– AIç”Ÿæˆ
                            </span>
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Q:</strong> AIäº‹æ¥­ã®ç«¶åˆå„ªä½æ€§ã¯ã©ã®ã‚ˆã†ãªç‚¹ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
                        </div>
                        <div>
                            <strong>A:</strong> å½“ç¤¾ã®AIäº‹æ¥­ã¯ã€ç‹¬è‡ªã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¨æ©Ÿæ¢°å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«ã‚ˆã‚Šã€æ¥­ç•Œãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã®ç²¾åº¦ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™...
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div style="margin-top: 1.5rem; text-align: center;">
                    <button class="btn btn-success" onclick="switchToStage('review')">
                        â¡ï¸ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«é€²ã‚€
                    </button>
                </div>
            </div>
        </div>

        <!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¹ãƒ†ãƒƒãƒ— -->
        <div id="step-review" class="step-content">
            <div class="content-header">
                <h2>âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æ‰¿èª</h2>
            </div>
            <div class="content-body">
                <div style="background: #f8fafc; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                    <h3>å…¬é–‹å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" checked>
                            <span>æ–‡å­—èµ·ã“ã—ã®ç²¾åº¦ç¢ºèª</span>
                            <span style="background: #d1fae5; color: #065f46; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin-left: auto;">OK</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" checked>
                            <span>æ©Ÿå¯†æƒ…å ±ã®é™¤å¤–ç¢ºèª</span>
                            <span style="background: #d1fae5; color: #065f46; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin-left: auto;">OK</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox">
                            <span>FAQå†…å®¹ã®æ­£ç¢ºæ€§ç¢ºèª</span>
                            <span style="background: #fef3c7; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin-left: auto;">è¦ç¢ºèª</span>
                        </label>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn btn-success" onclick="switchToStage('publish')">
                        â¡ï¸ å…¬é–‹è¨­å®šã«é€²ã‚€
                    </button>
                </div>
            </div>
        </div>

        <!-- å…¬é–‹ã‚¹ãƒ†ãƒƒãƒ— -->
        <div id="step-publish" class="step-content">
            <div class="content-header">
                <h2>ğŸŒ å…¬é–‹è¨­å®š</h2>
            </div>
            <div class="content-body">
                <div style="background: #f8fafc; padding: 1.5rem; border-radius: 0.5rem;">
                    <h3>å…¬é–‹ç¯„å›²è¨­å®š</h3>
                    <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer;">
                            <input type="radio" name="publish_scope" value="internal" checked>
                            <div>
                                ğŸ¢ <strong>ç¤¾å†…ã®ã¿</strong>
                                <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">IRéƒ¨é–€ãƒ»çµŒå–¶é™£ã®ã¿é–²è¦§å¯èƒ½</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer;">
                            <input type="radio" name="publish_scope" value="investors">
                            <div>
                                ğŸ‘¥ <strong>æŠ•è³‡å®¶å‘ã‘</strong>
                                <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">FAQã®ã¿æŠ•è³‡å®¶ã‚µã‚¤ãƒˆã§å…¬é–‹</div>
                            </div>
                        </label>
                    </div>
                    
                    <div style="margin-top: 2rem; text-align: center;">
                        <button class="btn btn-success btn-lg" onclick="publishContent()">
                            ğŸš€ å…¬é–‹å®Ÿè¡Œ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ãƒãƒ«ï¼ˆå³ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼‰ -->
    <div class="context-panel">
        <div class="panel-header">
            <h3>ğŸ‘¤ æŠ•è³‡å®¶ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</h3>
            <button class="btn-icon" onclick="toggleContextPanel()" style="color: #6b7280;">
                âŒ
            </button>
        </div>
        <div class="panel-content">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.5rem; margin: 0 auto 0.75rem;">
                    {{ meeting_data.investor_name[:2]|default('IR') }}
                </div>
                <h4 style="margin: 0;">{{ meeting_data.investor_name|default('æŠ•è³‡å®¶å') }}</h4>
                <p style="color: #6b7280; font-size: 0.875rem;">{{ meeting_data.investor_type|default('æ©Ÿé–¢æŠ•è³‡å®¶') }}</p>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <span style="font-size: 0.875rem; color: #6b7280;">æŠ•è³‡ã‚¹ã‚¿ã‚¤ãƒ«</span>
                    <div style="font-weight: 500;">{{ meeting_data.investor_profile.investment_style|default('é•·æœŸæˆé•·') }}</div>
                </div>
                <div>
                    <span style="font-size: 0.875rem; color: #6b7280;">ESGé‡è¦–åº¦</span>
                    <div style="font-weight: 500;">{{ meeting_data.investor_profile.esg_focus|default('é«˜') }}</div>
                </div>
            </div>
            
            <div style="margin-top: 2rem;">
                <h4>ğŸ§  AIã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h4>
                <div style="background: #f3f4ff; padding: 1rem; border-radius: 0.5rem; margin-top: 0.5rem;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.875rem; color: #6b7280;">æº€è¶³åº¦</span>
                        <span style="font-weight: 600; color: #667eea;">{{ meeting_data.ai_analysis.sentiment_score|default(85) }}%</span>
                    </div>
                    <div style="font-size: 0.875rem; color: #4c51bf;">
                        æŠ•è³‡å®¶ã®é–¢å¿ƒåº¦ãŒå‰å›ã‚ˆã‚Š15%ä¸Šæ˜‡ã—ã¦ã„ã¾ã™
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé–‹é–‰ãƒœã‚¿ãƒ³ -->
    <div class="context-toggle" onclick="toggleContextPanel()">
        <span class="toggle-icon">â€¹</span>
    </div>
</div>

<!-- JavaScript -->
<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
const meetingId = '{{ meeting_id }}';
let currentStep = 'upload';
let contextPanelCollapsed = false;

// ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    initializeWorkspace();
    setupEventListeners();
    
    // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã«åŸºã¥ã„ã¦è¡¨ç¤ºã‚’æ›´æ–°
    const activeStage = '{{ meeting_data.current_stage|default("ai_summary") }}';
    switchToStage(activeStage);
});

// ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹åˆæœŸåŒ–
function initializeWorkspace() {
    setupDragAndDrop();
    
    // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯å³ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤ºï¼ˆé‡è¦ï¼š1024pxä»¥ä¸‹ã®è‡ªå‹•éè¡¨ç¤ºã‚’å‰Šé™¤ï¼‰
    // ãƒ¢ãƒã‚¤ãƒ«ã®ã¿CSSã§éè¡¨ç¤ºã«ãªã‚‹ã‚ˆã†ã«ä¿®æ­£
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
function setupEventListeners() {
    document.getElementById('fileInput')?.addEventListener('change', handleFileSelect);
    
    // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œï¼ˆå³ãƒ‘ãƒãƒ«å¼·åˆ¶éè¡¨ç¤ºã‚’å‰Šé™¤ï¼‰
    window.addEventListener('resize', function() {
        // ãƒ¢ãƒã‚¤ãƒ«æ™‚ã®å‡¦ç†ã¯ CSS media queries ã«å§”è­²
    });
}

// ã‚¹ãƒ†ãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
function switchToStage(stageId) {
    // å…¨ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
    document.querySelectorAll('.step-content').forEach(step => {
        step.classList.remove('active');
    });
    
    // æŒ‡å®šã•ã‚ŒãŸã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
    const targetStep = document.getElementById(`step-${stageId}`);
    if (targetStep) {
        targetStep.classList.add('active');
        currentStep = stageId;
    }
    
    // é€²æ—ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®çŠ¶æ…‹æ›´æ–°
    document.querySelectorAll('.stage-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const activeStageItem = document.querySelector(`[data-stage="${stageId}"]`);
    if (activeStageItem) {
        activeStageItem.classList.add('active');
    }
}

// ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ãƒãƒ«åˆ‡ã‚Šæ›¿ãˆ
function toggleContextPanel() {
    const workspace = document.querySelector('.dialogue-workspace');
    const panel = document.querySelector('.context-panel');
    const toggle = document.querySelector('.context-toggle');
    
    contextPanelCollapsed = !contextPanelCollapsed;
    
    if (contextPanelCollapsed) {
        workspace.classList.add('context-collapsed');
        panel.classList.add('collapsed');
    } else {
        workspace.classList.remove('context-collapsed');
        panel.classList.remove('collapsed');
    }
}

// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
function setupDragAndDrop() {
    const uploadArea = document.getElementById('uploadArea');
    if (!uploadArea) return;
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => {
            uploadArea.style.borderColor = '#667eea';
            uploadArea.style.background = '#f8faff';
        });
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => {
            uploadArea.style.borderColor = '#d1d5db';
            uploadArea.style.background = '#fafafa';
        });
    });
    
    uploadArea.addEventListener('drop', handleDrop);
}

// ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
function selectFiles() {
    document.getElementById('fileInput').click();
}

function handleFileSelect(e) {
    const files = e.target.files;
    handleFiles(files);
}

function handleDrop(e) {
    const files = e.dataTransfer.files;
    handleFiles(files);
}

function handleFiles(files) {
    console.log('Files selected:', files.length);
    showNotification('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'info');
    
    // ãƒ¢ãƒƒã‚¯ï¼šã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
    setTimeout(() => {
        showNotification('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
        switchToStage('transcription');
    }, 2000);
}

// ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
function usePromptTemplate(type) {
    const templates = {
        competition: 'ç«¶åˆä»–ç¤¾ã¨ã®æ¯”è¼ƒè¦³ç‚¹ã§åˆ†æã—ã¦ãã ã•ã„ã€‚ç‰¹ã«æŠ€è¡“çš„å„ªä½æ€§ã€å¸‚å ´ã‚·ã‚§ã‚¢ã€æˆé•·æ€§ã®è¦³ç‚¹ã‹ã‚‰ã€‚',
        risk: 'ãƒªã‚¹ã‚¯è¦å› ã‚’ç‰¹å®šã—ã€ãã®å½±éŸ¿åº¦ã¨ç™ºç”Ÿå¯èƒ½æ€§ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚',
        opportunity: 'æ–°ãŸãªãƒ“ã‚¸ãƒã‚¹æ©Ÿä¼šã‚„æˆé•·å¯èƒ½æ€§ã«ã¤ã„ã¦åˆ†æã—ã¦ãã ã•ã„ã€‚'
    };
    
    document.getElementById('customPrompt').value = templates[type];
}

// å†åˆ†æ
function reanalyzeWithPrompt() {
    const prompt = document.getElementById('customPrompt').value;
    if (!prompt.trim()) {
        showNotification('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
    }
    
    showNotification('AIãŒå†åˆ†æã‚’å®Ÿè¡Œä¸­...', 'info');
    
    setTimeout(() => {
        showNotification('å†åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
    }, 2000);
}

// FAQç”Ÿæˆ
function generateMoreFAQs() {
    showNotification('AIãŒFAQã‚’ç”Ÿæˆä¸­...', 'info');
    
    setTimeout(() => {
        showNotification('3ä»¶ã®æ–°ã—ã„FAQã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
    }, 1500);
}

function createManualFAQ() {
    showNotification('æ‰‹å‹•FAQä½œæˆæ©Ÿèƒ½ã‚’é–‹ç™ºä¸­ã§ã™', 'info');
}

// å…¬é–‹å‡¦ç†
function publishContent() {
    showNotification('å…¬é–‹å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'info');
    
    setTimeout(() => {
        showNotification('ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒæ­£å¸¸ã«å…¬é–‹ã•ã‚Œã¾ã—ãŸ', 'success');
    }, 2000);
}

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        padding: 1rem 1.5rem;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        transform: translateX(400px);
        transition: transform 0.3s ease;
        z-index: 3000;
        border-left: 4px solid ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
        color: ${type === 'success' ? '#065f46' : type === 'warning' ? '#92400e' : '#1e40af'};
    `;
    
    const icon = type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
    notification.innerHTML = `${icon} <span>${message}</span>`;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(400px)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function showTimeline() {
    showNotification('å‡¦ç†å±¥æ­´æ©Ÿèƒ½ã‚’é–‹ç™ºä¸­ã§ã™', 'info');
}

function shareProgress() {
    showNotification('é€²æ—å…±æœ‰æ©Ÿèƒ½ã‚’é–‹ç™ºä¸­ã§ã™', 'info');
}

function toggleAIAssistant() {
    showNotification('AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆæ©Ÿèƒ½ã‚’é–‹ç™ºä¸­ã§ã™', 'info');
}
</script>
{% endblock %}
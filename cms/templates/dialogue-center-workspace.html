{% extends 'base.html' %}

{% block title %}対話記録センター{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/ir-management.css') }}">
<style>
/* 次世代対話記録管理ワークスペース */
.dialogue-center {
    display: grid;
    grid-template-columns: 320px 1fr 400px;
    grid-template-rows: auto 1fr;
    height: calc(100vh - 140px);
    gap: 1rem;
    grid-template-areas: 
        "activity-stream main-header intelligence-panel"
        "activity-stream main-content intelligence-panel";
    transition: grid-template-columns 0.3s ease;
}

.dialogue-center.intelligence-collapsed {
    grid-template-columns: 320px 1fr 0px;
    grid-template-areas: 
        "activity-stream main-header intelligence-panel"
        "activity-stream main-content intelligence-panel";
}

/* アクティビティストリーム（左サイドバー） */
.activity-stream {
    grid-area: activity-stream;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.stream-header {
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
    color: white;
    padding: 1.5rem;
}

.stream-filters {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

.filter-chip {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: rgba(255, 255, 255, 0.9);
}

.filter-chip.active {
    background: rgba(255, 255, 255, 0.2);
    color: white;
}

.stream-content {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
}

/* アクティビティカード */
.activity-card {
    border: 2px solid transparent;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    background: white;
    border-left: 4px solid #e5e7eb;
}

.activity-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.activity-card.selected {
    border-color: #3b82f6;
    background: #eff6ff;
    border-left-color: #3b82f6;
}

.activity-card.urgent {
    border-left-color: #ef4444;
    background: #fef2f2;
}

.activity-card.processing {
    border-left-color: #f59e0b;
    background: #fffbeb;
}

.activity-card.completed {
    border-left-color: #10b981;
    background: #f0fdfa;
}

.activity-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.activity-title {
    font-weight: 600;
    color: #1f2937;
    font-size: 0.875rem;
    line-height: 1.25rem;
}

.activity-time {
    font-size: 0.75rem;
    color: #6b7280;
}

.activity-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.75rem;
    color: #6b7280;
}

.investor-badge {
    background: #f3f4f6;
    color: #374151;
    padding: 0.125rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
}

.activity-progress {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.progress-dots {
    display: flex;
    gap: 0.25rem;
}

.progress-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #d1d5db;
}

.progress-dot.completed {
    background: #10b981;
}

.progress-dot.active {
    background: #3b82f6;
    animation: pulse 2s infinite;
}

.progress-label {
    font-size: 0.75rem;
    color: #6b7280;
}

/* メインワークスペース */
.workspace-header {
    grid-area: main-header;
    background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.workspace-main {
    grid-area: main-content;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

/* インテリジェンスパネル（右サイドバー） */
.intelligence-panel {
    grid-area: intelligence-panel;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
    position: relative;
}

.intelligence-panel.collapsed {
    width: 0;
    min-width: 0;
    overflow: hidden;
    opacity: 0;
    pointer-events: none;
}

.intelligence-header {
    background: #f8fafc;
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.intelligence-content {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
}

/* インテリジェンス開閉ボタン（固定位置） */
.intelligence-toggle {
    position: fixed;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    width: 45px;
    height: 120px;
    background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%);
    border-radius: 22px 0 0 22px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 100;
    transition: all 0.3s ease;
    box-shadow: -2px 0 8px rgba(0, 0, 0, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.2);
    padding: 8px 0;
}

.intelligence-toggle:hover {
    background: linear-gradient(135deg, #047857 0%, #0f766e 100%);
    transform: translateY(-50%) translateX(-3px);
    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.25);
}

.dialogue-center.intelligence-collapsed .intelligence-toggle {
    right: 0px;
    border-radius: 0 22px 22px 0;
    box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
}

.dialogue-center.intelligence-collapsed .intelligence-toggle:hover {
    transform: translateY(-50%) translateX(3px);
    box-shadow: 4px 0 12px rgba(0, 0, 0, 0.25);
}

.intelligence-toggle-icon {
    color: white;
    font-size: 1.6rem;
    font-weight: bold;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.25rem;
}

.intelligence-toggle-text {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    font-size: 0.85rem;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.95);
    margin-top: 0.75rem;
    text-align: center;
    letter-spacing: 0.1em;
    line-height: 1.2;
}

.dialogue-center.intelligence-collapsed .intelligence-toggle-icon {
    transform: rotate(180deg);
}

.dialogue-center.intelligence-collapsed .intelligence-toggle-text {
    writing-mode: vertical-lr;
    text-orientation: mixed;
}

/* 処理パイプライン表示 */
.pipeline-viewer {
    background: #f8fafc;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.pipeline-stages {
    display: flex;
    justify-content: space-between;
    position: relative;
    margin-bottom: 0.5rem;
}

.pipeline-stages::before {
    content: '';
    position: absolute;
    top: 12px;
    left: 0;
    right: 0;
    height: 2px;
    background: #e5e7eb;
    z-index: 1;
}

.pipeline-stage {
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 2;
    background: white;
    padding: 0 0.5rem;
    position: relative;
}

.stage-circle {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
    transition: all 0.2s;
}

.stage-circle.completed {
    background: #10b981;
    color: white;
}

.stage-circle.active {
    background: #3b82f6;
    color: white;
    animation: pulse 2s infinite;
}

.stage-circle.processing {
    background: #f59e0b;
    color: white;
    position: relative;
}

.stage-label {
    font-size: 0.625rem;
    color: #6b7280;
    text-align: center;
    line-height: 1.2;
}

/* ビューシステム */
.view-content {
    flex: 1;
    padding: 1.5rem;
    overflow-y: auto;
    display: none;
}

.view-content.active {
    display: block;
}

/* タブビューシステム */
.workspace-tabs {
    display: flex;
    background: #f8fafc;
    border-bottom: 1px solid #e5e7eb;
}

.workspace-tab {
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #6b7280;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
}

.workspace-tab.active {
    color: #3b82f6;
    border-bottom-color: #3b82f6;
    background: white;
}

.workspace-tab:hover:not(.active) {
    color: #374151;
    background: #f3f4f6;
}

.tab-content {
    flex: 1;
    padding: 1.5rem;
    overflow-y: auto;
    display: none;
}

.tab-content.active {
    display: block;
}

/* かんばんボード */
.kanban-board {
    display: flex;
    gap: 1rem;
    min-height: 600px;
    overflow-x: auto;
    padding-bottom: 1rem;
}

.kanban-column {
    min-width: 280px;
    background: #f8fafc;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
}

.kanban-header {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.kanban-content {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
}

.kanban-card {
    background: white;
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    border: 1px solid #e5e7eb;
    cursor: pointer;
    transition: all 0.2s;
}

.kanban-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.kanban-card.urgent {
    border-left: 4px solid #ef4444;
    background: #fef2f2;
}

.kanban-card.processing {
    border-left: 4px solid #f59e0b;
}

.kanban-card.completed {
    border-left: 4px solid #10b981;
    background: #f0fdfa;
}

.kanban-card-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.5rem;
}

.kanban-card-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.kanban-card-assignee, .kanban-card-stats {
    font-size: 0.75rem;
    color: #6b7280;
}

.progress-bar-mini {
    height: 4px;
    background: #e5e7eb;
    border-radius: 2px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: #3b82f6;
    transition: width 0.3s ease;
}

.progress-fill.stalled {
    background: #ef4444;
    animation: pulse 1s infinite;
}

.progress-fill.processing {
    background: #f59e0b;
}

.progress-fill.completed {
    background: #10b981;
}

/* データテーブル */
.table-container {
    background: white;
    border-radius: 8px;
}

.table-controls {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
}

.data-table-wrapper {
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
}

.data-table th {
    background: #f8fafc;
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    color: #374151;
    border-bottom: 2px solid #e5e7eb;
    white-space: nowrap;
}

.data-table th.sortable {
    cursor: pointer;
    position: relative;
}

.data-table th.sortable:hover {
    background: #f1f5f9;
}

.sort-icon {
    margin-left: 0.25rem;
    color: #9ca3af;
    font-size: 0.75rem;
}

.data-table td {
    padding: 0.75rem;
    border-bottom: 1px solid #f3f4f6;
    vertical-align: middle;
}

.table-row {
    cursor: pointer;
    transition: background-color 0.2s;
}

.table-row:hover {
    background: #f8fafc;
}

.table-row.urgent {
    background: #fef2f2;
}

.table-row.processing {
    background: #fffbeb;
}

.table-row.completed {
    background: #f0fdfa;
}

.table-row.selected {
    background: #eff6ff;
    border-left: 4px solid #3b82f6;
}

.status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-badge.urgent {
    background: #fee2e2;
    color: #dc2626;
}

.status-badge.processing {
    background: #fef3c7;
    color: #d97706;
}

.status-badge.completed {
    background: #d1fae5;
    color: #059669;
}

.progress-bar-table {
    width: 60px;
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    overflow: hidden;
    margin: 0 auto;
}

.ai-score-container {
    text-align: center;
}

.ai-score {
    font-weight: 600;
    font-size: 0.875rem;
}

.ai-score.high {
    color: #059669;
}

.ai-score.medium {
    color: #d97706;
}

.ai-score.low {
    color: #dc2626;
}

.action-buttons {
    display: flex;
    gap: 0.25rem;
}

.btn-action {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    border: 1px solid #d1d5db;
    background: white;
    color: #374151;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-action:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
}

.bulk-action-bar {
    padding: 1rem;
    background: #f8fafc;
    border-top: 1px solid #e5e7eb;
    border-radius: 0 0 8px 8px;
}

.pagination-mini {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-pagination {
    padding: 0.25rem 0.5rem;
    border: 1px solid #d1d5db;
    background: white;
    color: #374151;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.875rem;
}

.btn-pagination:hover {
    background: #f3f4f6;
}

.pagination-info {
    font-size: 0.875rem;
    color: #6b7280;
}

/* バッジ */
.badge {
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
}

.badge-blue {
    background: #dbeafe;
    color: #1d4ed8;
}

.badge-green {
    background: #d1fae5;
    color: #059669;
}

.badge-red {
    background: #fee2e2;
    color: #dc2626;
}

.badge-purple {
    background: #e9d5ff;
    color: #7c3aed;
}

.badge-gray {
    background: #f3f4f6;
    color: #374151;
}

/* モーダル用スタイル */
.export-format-option {
    position: relative;
    cursor: pointer;
}

.export-format-option input[type="radio"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

.format-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    background: white;
    transition: all 0.2s;
}

.export-format-option input[type="radio"]:checked + .format-card {
    border-color: #3b82f6;
    background: #eff6ff;
}

.format-card:hover {
    border-color: #9ca3af;
}

.form-control-sm {
    padding: 0.375rem 0.5rem;
    font-size: 0.875rem;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    background: white;
    transition: border-color 0.2s;
}

.form-control-sm:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    border-radius: 4px;
    border: 1px solid transparent;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.btn-sm.btn-primary {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.btn-sm.btn-primary:hover {
    background: #2563eb;
    border-color: #2563eb;
}

.btn-sm.btn-secondary {
    background: #f3f4f6;
    color: #374151;
    border-color: #d1d5db;
}

.btn-sm.btn-secondary:hover {
    background: #e5e7eb;
    border-color: #9ca3af;
}

/* AI分析表示 */
.ai-insights {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 1px solid #0284c7;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.insight-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: #0c4a6e;
    margin-bottom: 0.5rem;
}

.insight-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.insight-item {
    display: flex;
    align-items: start;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    color: #0c4a6e;
}

.insight-icon {
    flex-shrink: 0;
    margin-top: 0.125rem;
}

/* アクションパネル */
.action-panel {
    background: #fefce8;
    border: 1px solid #eab308;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.action-header {
    display: flex;
    align-items: center;
    justify-content: between;
    margin-bottom: 0.75rem;
}

.action-title {
    font-weight: 600;
    color: #a16207;
}

.action-count {
    background: #eab308;
    color: white;
    font-size: 0.75rem;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
}

.action-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.action-item {
    display: flex;
    align-items: center;
    justify-content: between;
    padding: 0.5rem;
    background: white;
    border-radius: 4px;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.action-priority {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 0.5rem;
}

.action-priority.high {
    background: #ef4444;
}

.action-priority.medium {
    background: #f59e0b;
}

.action-priority.low {
    background: #10b981;
}

/* 統計ウィジェット */
.stats-widget {
    background: #f8fafc;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
}

.stat-label {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.25rem;
}

.stat-trend {
    font-size: 0.75rem;
    margin-top: 0.25rem;
}

.stat-trend.positive {
    color: #10b981;
}

.stat-trend.negative {
    color: #ef4444;
}

/* ツールバー */
.toolbar {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem;
    background: #f8fafc;
    border-bottom: 1px solid #e5e7eb;
}

.toolbar-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.toolbar-separator {
    width: 1px;
    height: 1.5rem;
    background: #d1d5db;
    margin: 0 0.5rem;
}

.btn-toolbar {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background: white;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.btn-toolbar:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
}

.btn-toolbar.active {
    background: #3b82f6;
    border-color: #3b82f6;
    color: white;
}

/* レスポンシブ対応 */
@media (max-width: 1200px) {
    .dialogue-center {
        grid-template-columns: 280px 1fr 350px;
    }
    
    .dialogue-center.intelligence-collapsed {
        grid-template-columns: 280px 1fr 0px;
    }
}

@media (max-width: 992px) {
    .dialogue-center {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr;
        grid-template-areas: 
            "main-header"
            "activity-stream"
            "main-content";
    }
    
    .dialogue-center.intelligence-collapsed {
        grid-template-columns: 1fr;
        grid-template-areas: 
            "main-header"
            "activity-stream"
            "main-content";
    }
    
    .intelligence-panel {
        display: none;
    }
    
    .activity-stream {
        max-height: 200px;
    }
    
    .intelligence-toggle {
        width: 40px;
        height: 100px;
        right: 10px;
        padding: 6px 0;
    }
    
    .dialogue-center.intelligence-collapsed .intelligence-toggle {
        right: -5px;
    }
    
    .intelligence-toggle-icon {
        font-size: 1.2rem;
    }
    
    .intelligence-toggle-text {
        font-size: 0.75rem;
        margin-top: 0.5rem;
    }
}

@media (max-width: 768px) {
    .dialogue-center {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr;
        height: calc(100vh - 120px);
    }
    
    .activity-stream {
        max-height: 150px;
    }
    
    .intelligence-toggle {
        display: none;
    }
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

/* カスタムスクロールバー */
.stream-content::-webkit-scrollbar,
.intelligence-content::-webkit-scrollbar,
.tab-content::-webkit-scrollbar {
    width: 4px;
}

.stream-content::-webkit-scrollbar-track,
.intelligence-content::-webkit-scrollbar-track,
.tab-content::-webkit-scrollbar-track {
    background: #f1f5f9;
}

.stream-content::-webkit-scrollbar-thumb,
.intelligence-content::-webkit-scrollbar-thumb,
.tab-content::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 2px;
}

.stream-content::-webkit-scrollbar-thumb:hover,
.intelligence-content::-webkit-scrollbar-thumb:hover,
.tab-content::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}
</style>
{% endblock %}

{% block content %}
<div class="dialogue-center">
    <!-- アクティビティストリーム（左サイドバー） -->
    <div class="activity-stream">
        <div class="stream-header">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-bold">対話記録ストリーム</h3>
                <span class="text-sm opacity-75">156件</span>
            </div>
            <div class="stream-filters">
                <div class="filter-chip active" onclick="filterStream('all')">全て</div>
                <div class="filter-chip" onclick="filterStream('urgent')">緊急 (3)</div>
                <div class="filter-chip" onclick="filterStream('processing')">処理中 (12)</div>
                <div class="filter-chip" onclick="filterStream('today')">今日 (5)</div>
            </div>
        </div>
        
        <div class="stream-content">
            <!-- 緊急対応が必要な記録 -->
            <div class="activity-card urgent selected" onclick="selectActivity('activity-001')">
                <div class="activity-header">
                    <div class="activity-title">野村AM決算説明会</div>
                    <div class="activity-time">2時間前</div>
                </div>
                <div class="activity-meta">
                    <span class="investor-badge">機関投資家</span>
                    <span>•</span>
                    <span>90分</span>
                    <span>•</span>
                    <span class="text-red-600 font-medium">処理停滞</span>
                </div>
                <div class="activity-progress">
                    <div class="progress-dots">
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot active"></div>
                        <div class="progress-dot"></div>
                        <div class="progress-dot"></div>
                        <div class="progress-dot"></div>
                    </div>
                    <div class="progress-label">AI要約中</div>
                </div>
            </div>
            
            <!-- 処理中の記録 -->
            <div class="activity-card processing" onclick="selectActivity('activity-002')">
                <div class="activity-header">
                    <div class="activity-title">BlackRock個別面談</div>
                    <div class="activity-time">5時間前</div>
                </div>
                <div class="activity-meta">
                    <span class="investor-badge">海外投資家</span>
                    <span>•</span>
                    <span>45分</span>
                    <span>•</span>
                    <span class="text-yellow-600 font-medium">FAQ作成中</span>
                </div>
                <div class="activity-progress">
                    <div class="progress-dots">
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot active"></div>
                        <div class="progress-dot"></div>
                        <div class="progress-dot"></div>
                    </div>
                    <div class="progress-label">FAQ生成中</div>
                </div>
            </div>
            
            <!-- 完了済みの記録 -->
            <div class="activity-card completed" onclick="selectActivity('activity-003')">
                <div class="activity-header">
                    <div class="activity-title">個人投資家説明会</div>
                    <div class="activity-time">1日前</div>
                </div>
                <div class="activity-meta">
                    <span class="investor-badge">個人投資家</span>
                    <span>•</span>
                    <span>2時間</span>
                    <span>•</span>
                    <span class="text-green-600 font-medium">公開済み</span>
                </div>
                <div class="activity-progress">
                    <div class="progress-dots">
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot completed"></div>
                    </div>
                    <div class="progress-label">完了</div>
                </div>
            </div>
            
            <!-- 今日予定の記録 -->
            <div class="activity-card" onclick="selectActivity('activity-004')">
                <div class="activity-header">
                    <div class="activity-title">Vanguard定期面談</div>
                    <div class="activity-time">14:00予定</div>
                </div>
                <div class="activity-meta">
                    <span class="investor-badge">海外投資家</span>
                    <span>•</span>
                    <span>60分</span>
                    <span>•</span>
                    <span class="text-blue-600 font-medium">準備完了</span>
                </div>
                <div class="activity-progress">
                    <div class="progress-dots">
                        <div class="progress-dot"></div>
                        <div class="progress-dot"></div>
                        <div class="progress-dot"></div>
                        <div class="progress-dot"></div>
                        <div class="progress-dot"></div>
                        <div class="progress-dot"></div>
                    </div>
                    <div class="progress-label">実施待ち</div>
                </div>
            </div>
            
            <!-- 追加の記録... -->
            <div class="activity-card" onclick="selectActivity('activity-005')">
                <div class="activity-header">
                    <div class="activity-title">アナリスト向け説明会</div>
                    <div class="activity-time">2日前</div>
                </div>
                <div class="activity-meta">
                    <span class="investor-badge">アナリスト</span>
                    <span>•</span>
                    <span>75分</span>
                    <span>•</span>
                    <span class="text-yellow-600 font-medium">レビュー待ち</span>
                </div>
                <div class="activity-progress">
                    <div class="progress-dots">
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot active"></div>
                        <div class="progress-dot"></div>
                    </div>
                    <div class="progress-label">承認待ち</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ワークスペースヘッダー -->
    <div class="workspace-header">
        <div>
            <h1 class="text-2xl font-bold mb-1">対話記録センター</h1>
            <p class="text-blue-100">統合されたアクティビティストリーム管理</p>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right">
                <p class="text-sm text-blue-200">処理中</p>
                <p class="text-2xl font-bold">12件</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-blue-200">緊急対応</p>
                <p class="text-2xl font-bold text-yellow-300">3件</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-blue-200">今日完了</p>
                <p class="text-2xl font-bold text-green-300">8件</p>
            </div>
        </div>
    </div>
    
    <!-- メインワークスペース -->
    <div class="workspace-main">
        <!-- ツールバー -->
        <div class="toolbar">
            <div class="toolbar-group">
                <button class="btn-toolbar" onclick="bulkProcess()">
                    <span>⚡</span>
                    <span>一括処理</span>
                </button>
                <button class="btn-toolbar" onclick="exportData()">
                    <span>📥</span>
                    <span>エクスポート</span>
                </button>
            </div>
            <div class="toolbar-separator"></div>
            <div class="toolbar-group">
                <button class="btn-toolbar active" onclick="setViewMode('stream')">
                    <span>📊</span>
                    <span>ストリーム</span>
                </button>
                <button class="btn-toolbar" onclick="setViewMode('kanban')">
                    <span>📋</span>
                    <span>かんばん</span>
                </button>
                <button class="btn-toolbar" onclick="setViewMode('table')">
                    <span>📑</span>
                    <span>テーブル</span>
                </button>
            </div>
            <div class="toolbar-separator"></div>
            <div class="toolbar-group">
                <button class="btn-toolbar" onclick="showFilters()">
                    <span>🔍</span>
                    <span>詳細フィルタ</span>
                </button>
            </div>
        </div>
        
        <!-- タブシステム（ビューモード時は非表示、選択記録の詳細時に表示） -->
        <div class="workspace-tabs" id="detailTabs" style="display: none;">
            <div class="workspace-tab active" onclick="switchDetailTab('overview')">
                <span>📊 概要</span>
            </div>
            <div class="workspace-tab" onclick="switchDetailTab('transcript')">
                <span>📝 文字起こし</span>
            </div>
            <div class="workspace-tab" onclick="switchDetailTab('analysis')">
                <span>🤖 AI分析</span>
            </div>
            <div class="workspace-tab" onclick="switchDetailTab('timeline')">
                <span>⏰ タイムライン</span>
            </div>
        </div>
        
        <!-- ストリームビュー -->
        <div id="view-stream" class="view-content active">
            <!-- 選択された記録の処理パイプライン -->
            <div class="pipeline-viewer">
                <h3 class="font-semibold text-gray-800 mb-3">処理パイプライン - 野村AM決算説明会</h3>
                <div class="pipeline-stages">
                    <div class="pipeline-stage">
                        <div class="stage-circle completed">✓</div>
                        <div class="stage-label">アップロード</div>
                    </div>
                    <div class="pipeline-stage">
                        <div class="stage-circle completed">✓</div>
                        <div class="stage-label">文字起こし</div>
                    </div>
                    <div class="pipeline-stage">
                        <div class="stage-circle processing">⏳</div>
                        <div class="stage-label">AI要約</div>
                    </div>
                    <div class="pipeline-stage">
                        <div class="stage-circle">4</div>
                        <div class="stage-label">FAQ作成</div>
                    </div>
                    <div class="pipeline-stage">
                        <div class="stage-circle">5</div>
                        <div class="stage-label">レビュー</div>
                    </div>
                    <div class="pipeline-stage">
                        <div class="stage-circle">6</div>
                        <div class="stage-label">公開</div>
                    </div>
                </div>
                <div class="bg-blue-50 rounded-lg p-3 mt-3">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                        <span class="text-sm text-blue-800 font-medium">AI要約処理中...</span>
                        <span class="text-sm text-blue-600">推定残り時間: 3分</span>
                    </div>
                    <div class="w-full bg-blue-200 rounded-full h-2 mt-2">
                        <div class="bg-blue-600 h-2 rounded-full animate-pulse" style="width: 65%"></div>
                    </div>
                </div>
            </div>
            
            <!-- 基本情報カード -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-800 mb-3">📋 基本情報</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">投資家</span>
                            <span class="font-medium">野村アセットマネジメント</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">種別</span>
                            <span class="font-medium">決算説明会</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">日時</span>
                            <span class="font-medium">2024/12/26 15:00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">時間</span>
                            <span class="font-medium">90分</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">参加者</span>
                            <span class="font-medium">CEO, CFO, IR部長</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-800 mb-3">📊 処理統計</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">文字数</span>
                            <span class="font-medium">15,680文字</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">文字起こし精度</span>
                            <span class="font-medium text-green-600">96%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">処理開始</span>
                            <span class="font-medium">2時間前</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">進捗</span>
                            <span class="font-medium text-blue-600">65%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">担当者</span>
                            <span class="font-medium">IR担当者A</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 次のアクション -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-xl">⚡</span>
                    <h4 class="font-semibold text-yellow-800">次のアクション</h4>
                </div>
                <p class="text-sm text-yellow-700 mb-3">AI要約が完了次第、FAQ生成に進みます。手動で介入する場合は下記ボタンをクリックしてください。</p>
                <div class="flex gap-2">
                    <button class="px-3 py-1.5 bg-yellow-500 text-white rounded text-sm font-medium hover:bg-yellow-600" onclick="forceNextStage()">
                        強制的に次へ進む
                    </button>
                    <button class="px-3 py-1.5 bg-white text-yellow-700 border border-yellow-300 rounded text-sm font-medium hover:bg-yellow-50" onclick="cancelProcessing()">
                        処理を中断
                    </button>
                </div>
            </div>
        </div>
        
        <!-- かんばんビュー -->
        <div id="view-kanban" class="view-content hidden">
            <div class="kanban-board">
                <div class="kanban-column">
                    <div class="kanban-header">
                        <h3 class="font-semibold text-gray-700">📤 アップロード待ち</h3>
                        <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs">2件</span>
                    </div>
                    <div class="kanban-content">
                        <div class="kanban-card">
                            <div class="kanban-card-header">
                                <h4 class="font-medium text-sm">Vanguard定期面談</h4>
                                <span class="text-xs text-gray-500">14:00予定</span>
                            </div>
                            <div class="kanban-card-meta">
                                <span class="badge badge-blue">海外投資家</span>
                                <span class="text-xs text-gray-500">60分</span>
                            </div>
                            <div class="kanban-card-assignee">
                                <span class="text-xs text-gray-600">担当: IR担当者A</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="kanban-column">
                    <div class="kanban-header">
                        <h3 class="font-semibold text-gray-700">📝 文字起こし中</h3>
                        <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded-full text-xs">1件</span>
                    </div>
                    <div class="kanban-content">
                        <div class="kanban-card processing">
                            <div class="kanban-card-header">
                                <h4 class="font-medium text-sm">個別ファンドミーティング</h4>
                                <span class="text-xs text-blue-600">処理中 (85%)</span>
                            </div>
                            <div class="kanban-card-meta">
                                <span class="badge badge-green">機関投資家</span>
                                <span class="text-xs text-gray-500">30分</span>
                            </div>
                            <div class="progress-bar-mini">
                                <div class="progress-fill" style="width: 85%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="kanban-column">
                    <div class="kanban-header">
                        <h3 class="font-semibold text-gray-700">🤖 AI分析中</h3>
                        <span class="bg-yellow-100 text-yellow-600 px-2 py-1 rounded-full text-xs">3件</span>
                    </div>
                    <div class="kanban-content">
                        <div class="kanban-card urgent processing">
                            <div class="kanban-card-header">
                                <h4 class="font-medium text-sm">野村AM決算説明会</h4>
                                <span class="text-xs text-red-600">処理停滞</span>
                            </div>
                            <div class="kanban-card-meta">
                                <span class="badge badge-red">緊急</span>
                                <span class="text-xs text-gray-500">90分</span>
                            </div>
                            <div class="progress-bar-mini">
                                <div class="progress-fill stalled" style="width: 65%"></div>
                            </div>
                        </div>
                        
                        <div class="kanban-card processing">
                            <div class="kanban-card-header">
                                <h4 class="font-medium text-sm">ESG投資家懇談会</h4>
                                <span class="text-xs text-blue-600">要約生成中</span>
                            </div>
                            <div class="kanban-card-meta">
                                <span class="badge badge-purple">ESG特化</span>
                                <span class="text-xs text-gray-500">2時間</span>
                            </div>
                            <div class="progress-bar-mini">
                                <div class="progress-fill" style="width: 45%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="kanban-column">
                    <div class="kanban-header">
                        <h3 class="font-semibold text-gray-700">❓ FAQ作成中</h3>
                        <span class="bg-orange-100 text-orange-600 px-2 py-1 rounded-full text-xs">2件</span>
                    </div>
                    <div class="kanban-content">
                        <div class="kanban-card processing">
                            <div class="kanban-card-header">
                                <h4 class="font-medium text-sm">BlackRock個別面談</h4>
                                <span class="text-xs text-blue-600">FAQ生成中 (75%)</span>
                            </div>
                            <div class="kanban-card-meta">
                                <span class="badge badge-blue">海外投資家</span>
                                <span class="text-xs text-gray-500">45分</span>
                            </div>
                            <div class="progress-bar-mini">
                                <div class="progress-fill" style="width: 75%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="kanban-column">
                    <div class="kanban-header">
                        <h3 class="font-semibold text-gray-700">✅ レビュー待ち</h3>
                        <span class="bg-purple-100 text-purple-600 px-2 py-1 rounded-full text-xs">5件</span>
                    </div>
                    <div class="kanban-content">
                        <div class="kanban-card">
                            <div class="kanban-card-header">
                                <h4 class="font-medium text-sm">アナリスト向け説明会</h4>
                                <span class="text-xs text-gray-500">2日前</span>
                            </div>
                            <div class="kanban-card-meta">
                                <span class="badge badge-gray">アナリスト</span>
                                <span class="text-xs text-gray-500">75分</span>
                            </div>
                            <div class="kanban-card-assignee">
                                <span class="text-xs text-purple-600">承認待ち: IR部長</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="kanban-column">
                    <div class="kanban-header">
                        <h3 class="font-semibold text-gray-700">🌐 公開済み</h3>
                        <span class="bg-green-100 text-green-600 px-2 py-1 rounded-full text-xs">8件</span>
                    </div>
                    <div class="kanban-content">
                        <div class="kanban-card completed">
                            <div class="kanban-card-header">
                                <h4 class="font-medium text-sm">個人投資家説明会</h4>
                                <span class="text-xs text-green-600">公開済み</span>
                            </div>
                            <div class="kanban-card-meta">
                                <span class="badge badge-green">個人投資家</span>
                                <span class="text-xs text-gray-500">2時間</span>
                            </div>
                            <div class="kanban-card-stats">
                                <span class="text-xs text-gray-600">FAQ: 15件作成</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- テーブルビュー -->
        <div id="view-table" class="view-content hidden">
            <div class="table-container">
                <div class="table-controls mb-4">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <button class="btn-sm btn-secondary" onclick="selectAllRecords()">
                                <input type="checkbox" id="selectAllTable" class="mr-1"> 全選択
                            </button>
                            <span class="text-sm text-gray-600">156件中 20件表示</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <select class="form-control-sm" onchange="changeTablePageSize(this.value)">
                                <option value="20">20件/ページ</option>
                                <option value="50">50件/ページ</option>
                                <option value="100">100件/ページ</option>
                            </select>
                            <div class="pagination-mini">
                                <button class="btn-pagination" onclick="previousTablePage()">‹</button>
                                <span class="pagination-info">1/8</span>
                                <button class="btn-pagination" onclick="nextTablePage()">›</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="data-table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th width="40px">
                                    <input type="checkbox" onclick="toggleAllTableRows(this)">
                                </th>
                                <th width="120px" class="sortable" onclick="sortTable('date')">
                                    日時 <span class="sort-icon">↕</span>
                                </th>
                                <th width="200px" class="sortable" onclick="sortTable('title')">
                                    タイトル <span class="sort-icon">↕</span>
                                </th>
                                <th width="150px" class="sortable" onclick="sortTable('investor')">
                                    投資家 <span class="sort-icon">↕</span>
                                </th>
                                <th width="100px" class="sortable" onclick="sortTable('duration')">
                                    時間 <span class="sort-icon">↕</span>
                                </th>
                                <th width="120px" class="sortable" onclick="sortTable('status')">
                                    ステータス <span class="sort-icon">↕</span>
                                </th>
                                <th width="100px" class="sortable" onclick="sortTable('progress')">
                                    進捗 <span class="sort-icon">↕</span>
                                </th>
                                <th width="120px" class="sortable" onclick="sortTable('assignee')">
                                    担当者 <span class="sort-icon">↕</span>
                                </th>
                                <th width="150px" class="sortable" onclick="sortTable('ai_score')">
                                    AI分析スコア <span class="sort-icon">↕</span>
                                </th>
                                <th width="100px">アクション</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="table-row urgent" onclick="selectTableRow(this)">
                                <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                <td>
                                    <div class="text-sm font-medium">2024/12/26</div>
                                    <div class="text-xs text-gray-500">15:00</div>
                                </td>
                                <td>
                                    <div class="font-medium">野村AM決算説明会</div>
                                    <div class="text-xs text-gray-500">決算説明会</div>
                                </td>
                                <td>
                                    <div class="text-sm">野村アセット</div>
                                    <div class="badge badge-blue">機関投資家</div>
                                </td>
                                <td class="text-sm">90分</td>
                                <td>
                                    <span class="status-badge urgent">処理停滞</span>
                                </td>
                                <td>
                                    <div class="progress-bar-table">
                                        <div class="progress-fill urgent" style="width: 65%"></div>
                                    </div>
                                    <div class="text-xs text-center">65%</div>
                                </td>
                                <td class="text-sm">IR担当者A</td>
                                <td>
                                    <div class="ai-score-container">
                                        <div class="ai-score high">96%</div>
                                        <div class="text-xs text-gray-500">精度</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-action" onclick="editRecord('activity-001')">編集</button>
                                        <button class="btn-action" onclick="viewRecord('activity-001')">詳細</button>
                                    </div>
                                </td>
                            </tr>
                            
                            <tr class="table-row processing" onclick="selectTableRow(this)">
                                <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                <td>
                                    <div class="text-sm font-medium">2024/12/26</div>
                                    <div class="text-xs text-gray-500">10:00</div>
                                </td>
                                <td>
                                    <div class="font-medium">BlackRock個別面談</div>
                                    <div class="text-xs text-gray-500">個別面談</div>
                                </td>
                                <td>
                                    <div class="text-sm">BlackRock Inc.</div>
                                    <div class="badge badge-blue">海外投資家</div>
                                </td>
                                <td class="text-sm">45分</td>
                                <td>
                                    <span class="status-badge processing">FAQ作成中</span>
                                </td>
                                <td>
                                    <div class="progress-bar-table">
                                        <div class="progress-fill processing" style="width: 75%"></div>
                                    </div>
                                    <div class="text-xs text-center">75%</div>
                                </td>
                                <td class="text-sm">IR担当者B</td>
                                <td>
                                    <div class="ai-score-container">
                                        <div class="ai-score high">98%</div>
                                        <div class="text-xs text-gray-500">精度</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-action" onclick="editRecord('activity-002')">編集</button>
                                        <button class="btn-action" onclick="viewRecord('activity-002')">詳細</button>
                                    </div>
                                </td>
                            </tr>
                            
                            <tr class="table-row completed" onclick="selectTableRow(this)">
                                <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                <td>
                                    <div class="text-sm font-medium">2024/12/25</div>
                                    <div class="text-xs text-gray-500">13:00</div>
                                </td>
                                <td>
                                    <div class="font-medium">個人投資家説明会</div>
                                    <div class="text-xs text-gray-500">説明会</div>
                                </td>
                                <td>
                                    <div class="text-sm">個人投資家</div>
                                    <div class="badge badge-green">個人投資家</div>
                                </td>
                                <td class="text-sm">2時間</td>
                                <td>
                                    <span class="status-badge completed">公開済み</span>
                                </td>
                                <td>
                                    <div class="progress-bar-table">
                                        <div class="progress-fill completed" style="width: 100%"></div>
                                    </div>
                                    <div class="text-xs text-center">100%</div>
                                </td>
                                <td class="text-sm">IR担当者C</td>
                                <td>
                                    <div class="ai-score-container">
                                        <div class="ai-score medium">94%</div>
                                        <div class="text-xs text-gray-500">精度</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-action" onclick="editRecord('activity-003')">編集</button>
                                        <button class="btn-action" onclick="viewRecord('activity-003')">詳細</button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 選択時の一括操作バー -->
                <div id="bulkActionBar" class="bulk-action-bar hidden">
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-700">
                            <span id="selectedCount">0</span>件を選択中
                        </div>
                        <div class="flex gap-2">
                            <select class="form-control-sm" id="bulkActionSelect">
                                <option value="">一括操作を選択</option>
                                <option value="assign">担当者変更</option>
                                <option value="status">ステータス変更</option>
                                <option value="priority">優先度変更</option>
                                <option value="export">エクスポート</option>
                                <option value="delete">削除</option>
                            </select>
                            <button class="btn-sm btn-primary" onclick="executeBulkTableAction()">実行</button>
                            <button class="btn-sm btn-secondary" onclick="clearTableSelection()">選択解除</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 詳細タブ -->
        <div id="tab-details" class="tab-content">
            <div class="space-y-4">
                <h3 class="font-semibold text-gray-800">📝 文字起こし結果</h3>
                <div class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                    <div class="prose prose-sm max-w-none">
                        <p><strong>[00:00:15] CEO:</strong> 皆様、本日はお忙しい中お時間をいただき、ありがとうございます。第3四半期決算について説明させていただきます。</p>
                        
                        <p><strong>[00:01:30] 投資家A:</strong> 業績は好調ですが、AI事業の具体的な収益貢献度を教えてください。</p>
                        
                        <p><strong>[00:02:15] CEO:</strong> AI事業は前年同期比で150%の成長を示しており、全社売上の約8%を占めるまでになりました。特に金融機関向けソリューションが好調です。</p>
                        
                        <p><strong>[00:03:45] CFO:</strong> 数値面で補足いたします。AI事業の営業利益率は25%と高収益を維持しており、投資回収も順調に進んでいます。</p>
                        
                        <p class="text-gray-500 text-center">...残り約14,000文字...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI分析タブ -->
        <div id="tab-analysis" class="tab-content">
            <div class="space-y-4">
                <h3 class="font-semibold text-gray-800">🤖 AI分析結果</h3>
                <div class="bg-blue-50 rounded-lg p-4 text-center">
                    <div class="animate-pulse">
                        <div class="w-12 h-12 bg-blue-300 rounded-full mx-auto mb-4"></div>
                        <p class="text-blue-800 font-medium">AI分析を実行中...</p>
                        <p class="text-blue-600 text-sm">感情分析、重要ポイント抽出、懸念事項の特定を行っています</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- タイムラインタブ -->
        <div id="tab-timeline" class="tab-content">
            <div class="space-y-4">
                <h3 class="font-semibold text-gray-800">⏰ 処理タイムライン</h3>
                <div class="space-y-3">
                    <div class="flex items-start gap-3">
                        <div class="w-2 h-2 bg-green-500 rounded-full mt-2"></div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-green-700">ファイルアップロード完了</span>
                                <span class="text-sm text-gray-500">2時間前</span>
                            </div>
                            <p class="text-sm text-gray-600">音声ファイル（234MB）のアップロードが正常に完了</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start gap-3">
                        <div class="w-2 h-2 bg-green-500 rounded-full mt-2"></div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-green-700">文字起こし完了</span>
                                <span class="text-sm text-gray-500">1時間45分前</span>
                            </div>
                            <p class="text-sm text-gray-600">AI文字起こし完了（精度96%、15,680文字）</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start gap-3">
                        <div class="w-2 h-2 bg-blue-500 rounded-full mt-2 animate-pulse"></div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-blue-700">AI要約処理中</span>
                                <span class="text-sm text-gray-500">現在</span>
                            </div>
                            <p class="text-sm text-gray-600">重要ポイントの抽出と要約を生成中（65%完了）</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- インテリジェンスパネル開閉ボタン（固定位置） -->
    <div class="intelligence-toggle" onclick="toggleIntelligencePanel()" title="インテリジェンスパネルを開閉">
        <div class="intelligence-toggle-icon">‹</div>
        <div class="intelligence-toggle-text">知能分析</div>
    </div>
    
    <!-- インテリジェンスパネル（右サイドバー） -->
    <div class="intelligence-panel" id="intelligencePanel">
        
        <div class="intelligence-header">
            <h3 class="font-semibold text-gray-800">🧠 インテリジェンス</h3>
            <button class="text-gray-400 hover:text-gray-600" onclick="toggleIntelligencePanel()" title="パネルを閉じる">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <div class="intelligence-content">
            <!-- 統計ウィジェット -->
            <div class="stats-widget">
                <h4 class="font-semibold text-gray-800 mb-3">📊 今日の統計</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">8</div>
                        <div class="stat-label">処理完了</div>
                        <div class="stat-trend positive">+3</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">12</div>
                        <div class="stat-label">処理中</div>
                        <div class="stat-trend positive">-2</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">96%</div>
                        <div class="stat-label">AI精度</div>
                        <div class="stat-trend positive">+1%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">2.3h</div>
                        <div class="stat-label">平均時間</div>
                        <div class="stat-trend positive">-0.5h</div>
                    </div>
                </div>
            </div>
            
            <!-- AI洞察 -->
            <div class="ai-insights">
                <div class="insight-header">
                    <span class="text-xl">🤖</span>
                    <span>AI洞察</span>
                </div>
                <ul class="insight-list">
                    <li class="insight-item">
                        <span class="insight-icon">💡</span>
                        <span>今日の処理効率が20%向上しています</span>
                    </li>
                    <li class="insight-item">
                        <span class="insight-icon">⚠️</span>
                        <span>3件の記録で処理遅延が発生中</span>
                    </li>
                    <li class="insight-item">
                        <span class="insight-icon">📈</span>
                        <span>ESG関連の質問が急増しています</span>
                    </li>
                </ul>
            </div>
            
            <!-- アクションパネル -->
            <div class="action-panel">
                <div class="action-header">
                    <div class="action-title">🎯 要対応アクション</div>
                    <div class="action-count">5</div>
                </div>
                <ul class="action-list">
                    <li class="action-item">
                        <div class="action-priority high"></div>
                        <div class="flex-1">
                            <div class="font-medium">BlackRockへの回答</div>
                            <div class="text-xs text-gray-500">期限: 今日</div>
                        </div>
                    </li>
                    <li class="action-item">
                        <div class="action-priority medium"></div>
                        <div class="flex-1">
                            <div class="font-medium">FAQ承認</div>
                            <div class="text-xs text-gray-500">期限: 明日</div>
                        </div>
                    </li>
                    <li class="action-item">
                        <div class="action-priority low"></div>
                        <div class="flex-1">
                            <div class="font-medium">レポート作成</div>
                            <div class="text-xs text-gray-500">期限: 来週</div>
                        </div>
                    </li>
                </ul>
            </div>
            
            <!-- 最近の活動 -->
            <div class="bg-gray-50 rounded-lg p-3">
                <h4 class="font-semibold text-gray-800 mb-2">📝 最近の活動</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span>FAQ 3件が公開されました</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                        <span>新しい音声ファイルがアップロード</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
                        <span>レビュー待ちが2件追加</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- エクスポートモーダル -->
<div id="exportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">📥 データエクスポート</h3>
                <button onclick="closeExportModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- エクスポート形式 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">出力形式</label>
                    <div class="grid grid-cols-3 gap-3">
                        <label class="export-format-option">
                            <input type="radio" name="exportFormat" value="excel" checked>
                            <div class="format-card">
                                <span class="text-2xl">📊</span>
                                <span class="font-medium">Excel</span>
                                <span class="text-xs text-gray-500">詳細分析用</span>
                            </div>
                        </label>
                        <label class="export-format-option">
                            <input type="radio" name="exportFormat" value="pdf">
                            <div class="format-card">
                                <span class="text-2xl">📄</span>
                                <span class="font-medium">PDF</span>
                                <span class="text-xs text-gray-500">報告書用</span>
                            </div>
                        </label>
                        <label class="export-format-option">
                            <input type="radio" name="exportFormat" value="csv">
                            <div class="format-card">
                                <span class="text-2xl">📋</span>
                                <span class="font-medium">CSV</span>
                                <span class="text-xs text-gray-500">データ分析用</span>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- エクスポート内容 -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">対象データ</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded" checked>
                                <span class="ml-2 text-sm">基本情報（日時、投資家、ステータス）</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded" checked>
                                <span class="ml-2 text-sm">処理統計（進捗、AI精度、時間）</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded">
                                <span class="ml-2 text-sm">文字起こしテキスト</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded">
                                <span class="ml-2 text-sm">AI分析結果</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded">
                                <span class="ml-2 text-sm">FAQ内容</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">期間フィルタ</label>
                        <div class="space-y-2">
                            <div>
                                <label class="text-xs text-gray-600">開始日</label>
                                <input type="date" class="form-control-sm w-full">
                            </div>
                            <div>
                                <label class="text-xs text-gray-600">終了日</label>
                                <input type="date" class="form-control-sm w-full">
                            </div>
                            <div>
                                <label class="text-xs text-gray-600">ステータス</label>
                                <select class="form-control-sm w-full">
                                    <option>すべて</option>
                                    <option>処理中のみ</option>
                                    <option>完了済みのみ</option>
                                    <option>エラーのみ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- プリセットオプション -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">クイックプリセット</label>
                    <div class="flex gap-2">
                        <button class="btn-sm btn-secondary" onclick="applyExportPreset('executive')">
                            経営陣向けサマリー
                        </button>
                        <button class="btn-sm btn-secondary" onclick="applyExportPreset('detailed')">
                            詳細分析レポート
                        </button>
                        <button class="btn-sm btn-secondary" onclick="applyExportPreset('compliance')">
                            コンプライアンス報告
                        </button>
                    </div>
                </div>
                
                <div class="flex gap-3 pt-4 border-t">
                    <button class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md font-medium hover:bg-blue-700" onclick="executeExport()">
                        <span class="mr-2">📥</span>
                        エクスポート実行
                    </button>
                    <button class="px-4 py-2 text-gray-600 hover:text-gray-800" onclick="closeExportModal()">
                        キャンセル
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 詳細フィルタモーダル -->
<div id="filterModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">🔍 詳細フィルタ</h3>
                <button onclick="closeFilterModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- 基本フィルタ -->
                <div class="space-y-4">
                    <h4 class="font-semibold text-gray-800">📋 基本条件</h4>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">期間</label>
                        <div class="space-y-2">
                            <input type="date" class="form-control-sm w-full" placeholder="開始日">
                            <input type="date" class="form-control-sm w-full" placeholder="終了日">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">投資家種別</label>
                        <div class="space-y-1">
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded" checked>
                                <span class="ml-2 text-sm">機関投資家</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded" checked>
                                <span class="ml-2 text-sm">海外投資家</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded" checked>
                                <span class="ml-2 text-sm">個人投資家</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded" checked>
                                <span class="ml-2 text-sm">アナリスト</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">会議種別</label>
                        <select class="form-control-sm w-full" multiple size="4">
                            <option>決算説明会</option>
                            <option>個別面談</option>
                            <option>スモールミーティング</option>
                            <option>ESG説明会</option>
                            <option>IR Day</option>
                        </select>
                    </div>
                </div>
                
                <!-- 処理状況フィルタ -->
                <div class="space-y-4">
                    <h4 class="font-semibold text-gray-800">⚙️ 処理状況</h4>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ステータス</label>
                        <div class="space-y-1">
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded">
                                <span class="ml-2 text-sm">アップロード待ち</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded">
                                <span class="ml-2 text-sm">文字起こし中</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded" checked>
                                <span class="ml-2 text-sm">AI分析中</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded">
                                <span class="ml-2 text-sm">FAQ作成中</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded">
                                <span class="ml-2 text-sm">レビュー待ち</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded">
                                <span class="ml-2 text-sm">公開済み</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">優先度</label>
                        <div class="space-y-1">
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded" checked>
                                <span class="ml-2 text-sm text-red-600">🔴 緊急</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded">
                                <span class="ml-2 text-sm text-yellow-600">🟡 中</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded">
                                <span class="ml-2 text-sm text-green-600">🟢 低</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">担当者</label>
                        <select class="form-control-sm w-full">
                            <option>すべて</option>
                            <option>IR担当者A</option>
                            <option>IR担当者B</option>
                            <option>IR担当者C</option>
                            <option>IR部長</option>
                        </select>
                    </div>
                </div>
                
                <!-- 高度なフィルタ -->
                <div class="space-y-4">
                    <h4 class="font-semibold text-gray-800">🤖 AI分析</h4>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">AI精度</label>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-600">最小:</span>
                                <input type="range" class="flex-1" min="0" max="100" value="80">
                                <span class="text-sm font-medium">80%</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-600">最大:</span>
                                <input type="range" class="flex-1" min="0" max="100" value="100">
                                <span class="text-sm font-medium">100%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">処理時間</label>
                        <select class="form-control-sm w-full">
                            <option>すべて</option>
                            <option>1時間以内</option>
                            <option>3時間以内</option>
                            <option>1日以内</option>
                            <option>1日超過</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">キーワード検索</label>
                        <input type="text" class="form-control-sm w-full" placeholder="タイトル、投資家名、内容で検索">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">タグ</label>
                        <div class="space-y-1">
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded">
                                <span class="ml-2 text-sm">ESG</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded">
                                <span class="ml-2 text-sm">DX戦略</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded">
                                <span class="ml-2 text-sm">M&A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded">
                                <span class="ml-2 text-sm">配当政策</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- フィルタプリセット -->
            <div class="mt-6 pt-4 border-t">
                <label class="block text-sm font-medium text-gray-700 mb-2">クイックフィルタ</label>
                <div class="flex flex-wrap gap-2">
                    <button class="btn-sm btn-secondary" onclick="applyFilterPreset('urgent')">
                        🚨 緊急対応必要
                    </button>
                    <button class="btn-sm btn-secondary" onclick="applyFilterPreset('stalled')">
                        ⏸️ 処理停滞中
                    </button>
                    <button class="btn-sm btn-secondary" onclick="applyFilterPreset('completed_today')">
                        ✅ 本日完了
                    </button>
                    <button class="btn-sm btn-secondary" onclick="applyFilterPreset('high_accuracy')">
                        🎯 高精度AI分析
                    </button>
                    <button class="btn-sm btn-secondary" onclick="applyFilterPreset('overseas')">
                        🌏 海外投資家
                    </button>
                </div>
            </div>
            
            <div class="flex gap-3 pt-4 border-t mt-4">
                <button class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md font-medium hover:bg-blue-700" onclick="applyFilters()">
                    <span class="mr-2">🔍</span>
                    フィルタ適用
                </button>
                <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md font-medium hover:bg-gray-200" onclick="resetFilters()">
                    リセット
                </button>
                <button class="px-4 py-2 text-gray-600 hover:text-gray-800" onclick="closeFilterModal()">
                    キャンセル
                </button>
            </div>
        </div>
    </div>
</div>

<!-- クイックアクションモーダル -->
<div id="quickActionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">一括処理</h3>
                <button onclick="closeQuickAction()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">処理対象</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" class="rounded" checked>
                            <span class="ml-2 text-sm">処理停滞中の記録（3件）</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="rounded">
                            <span class="ml-2 text-sm">レビュー待ちの記録（5件）</span>
                        </label>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">実行する処理</label>
                    <select class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                        <option>AI要約の再実行</option>
                        <option>FAQ生成をスキップして次へ</option>
                        <option>強制的にレビュー段階へ移行</option>
                    </select>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md font-medium hover:bg-blue-700" onclick="executeBulkProcess()">
                        一括処理を実行
                    </button>
                    <button class="px-4 py-2 text-gray-600 hover:text-gray-800" onclick="closeQuickAction()">
                        キャンセル
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// グローバル状態管理
let selectedActivityId = 'activity-001';
let currentTab = 'overview';
let currentFilter = 'all';
let intelligencePanelCollapsed = false;

// アクティビティ選択
function selectActivity(activityId) {
    // 前の選択を解除
    document.querySelectorAll('.activity-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // 新しい選択を設定
    event.target.closest('.activity-card').classList.add('selected');
    selectedActivityId = activityId;
    
    // メインワークスペースの内容を更新
    updateWorkspaceContent(activityId);
}

// ワークスペース内容更新
function updateWorkspaceContent(activityId) {
    // 実際の実装では、activityIdに基づいてAPIからデータを取得
    console.log('ワークスペース更新:', activityId);
    
    // デモ用: 異なる記録の内容を表示
    const activityData = {
        'activity-002': {
            title: 'BlackRock個別面談',
            investor: 'BlackRock Inc.',
            status: 'FAQ生成中',
            progress: 75
        },
        'activity-003': {
            title: '個人投資家説明会',
            investor: '個人投資家',
            status: '公開済み',
            progress: 100
        }
    };
    
    if (activityData[activityId]) {
        // UIを動的に更新
        console.log('記録詳細を更新:', activityData[activityId]);
    }
}

// フィルター適用
function filterStream(filter) {
    // フィルターボタンのアクティブ状態を更新
    document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('active');
    });
    event.target.classList.add('active');
    
    currentFilter = filter;
    console.log('フィルター適用:', filter);
    
    // 実際の実装では、フィルターに基づいてアクティビティリストを更新
}

// テーブル操作機能
let selectedTableRows = new Set();

function selectTableRow(row) {
    row.classList.toggle('selected');
    const checkbox = row.querySelector('input[type="checkbox"]');
    checkbox.checked = !checkbox.checked;
    
    const activityId = row.dataset.activityId || 'activity-001';
    if (checkbox.checked) {
        selectedTableRows.add(activityId);
    } else {
        selectedTableRows.delete(activityId);
    }
    
    updateTableSelection();
}

function toggleAllTableRows(masterCheckbox) {
    const rows = document.querySelectorAll('.table-row');
    rows.forEach(row => {
        const checkbox = row.querySelector('input[type="checkbox"]');
        checkbox.checked = masterCheckbox.checked;
        
        if (masterCheckbox.checked) {
            row.classList.add('selected');
            selectedTableRows.add(row.dataset.activityId || 'activity-001');
        } else {
            row.classList.remove('selected');
            selectedTableRows.clear();
        }
    });
    
    updateTableSelection();
}

function updateTableSelection() {
    const count = selectedTableRows.size;
    document.getElementById('selectedCount').textContent = count;
    
    const bulkActionBar = document.getElementById('bulkActionBar');
    if (count > 0) {
        bulkActionBar.classList.remove('hidden');
    } else {
        bulkActionBar.classList.add('hidden');
    }
}

function clearTableSelection() {
    selectedTableRows.clear();
    document.querySelectorAll('.table-row').forEach(row => {
        row.classList.remove('selected');
        row.querySelector('input[type="checkbox"]').checked = false;
    });
    document.getElementById('selectAllTable').checked = false;
    updateTableSelection();
}

function executeBulkTableAction() {
    const action = document.getElementById('bulkActionSelect').value;
    if (!action) {
        alert('操作を選択してください');
        return;
    }
    
    const count = selectedTableRows.size;
    console.log(`一括操作実行: ${action}, 対象: ${count}件`);
    
    switch (action) {
        case 'assign':
            showAssigneeChangeModal();
            break;
        case 'status':
            showStatusChangeModal();
            break;
        case 'priority':
            showPriorityChangeModal();
            break;
        case 'export':
            exportSelectedRecords();
            break;
        case 'delete':
            if (confirm(`選択した${count}件の記録を削除しますか？`)) {
                deleteSelectedRecords();
            }
            break;
    }
}

function sortTable(column) {
    console.log(`テーブルソート: ${column}`);
    // 実装: テーブルの行をソート
    showNotification(`${column}でソートしました`);
}

function changeTablePageSize(size) {
    console.log(`ページサイズ変更: ${size}`);
    showNotification(`${size}件/ページに変更しました`);
}

function previousTablePage() {
    console.log('前のページ');
}

function nextTablePage() {
    console.log('次のページ');
}

function editRecord(activityId) {
    console.log(`記録編集: ${activityId}`);
    showNotification('編集画面を開きます');
}

function viewRecord(activityId) {
    console.log(`記録詳細: ${activityId}`);
    selectActivity(activityId);
}

// 詳細タブ機能
function switchDetailTab(tabName) {
    // タブボタンのアクティブ状態を更新
    document.querySelectorAll('.workspace-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // タブコンテンツの表示切り替え
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    const tabContent = document.getElementById(`tab-${tabName}`);
    if (tabContent) {
        tabContent.classList.add('active');
    }
    
    currentTab = tabName;
    console.log('詳細タブ切り替え:', tabName);
    
    // タブ別の追加処理
    switch (tabName) {
        case 'analysis':
            loadAIAnalysis();
            break;
        case 'transcript':
            loadTranscriptData();
            break;
        case 'timeline':
            loadTimelineData();
            break;
    }
}

function loadAIAnalysis() {
    // AI分析データの読み込み
    console.log('AI分析データを読み込み中...');
}

function loadTranscriptData() {
    // 文字起こしデータの読み込み
    console.log('文字起こしデータを読み込み中...');
}

function loadTimelineData() {
    // タイムラインデータの読み込み
    console.log('タイムラインデータを読み込み中...');
}

// 通知表示
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    
    const bgColor = {
        'success': 'bg-green-500',
        'info': 'bg-blue-500', 
        'warning': 'bg-yellow-500',
        'error': 'bg-red-500'
    }[type] || 'bg-green-500';
    
    notification.className = `fixed bottom-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-500 translate-y-0 z-50`;
    notification.innerHTML = `
        <div class="flex items-center gap-2">
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // 自動で消去
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.transform = 'translateY(100px)';
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 500);
        }
    }, 5000);
}

// ビューモード切り替え
let currentViewMode = 'stream';

function setViewMode(mode) {
    console.log('ビューモード変更:', mode);
    
    // 前のビューを非表示
    const currentView = document.getElementById(`view-${currentViewMode}`);
    if (currentView) {
        currentView.classList.add('hidden');
        currentView.classList.remove('active');
    }
    
    // 新しいビューを表示
    const newView = document.getElementById(`view-${mode}`);
    if (newView) {
        newView.classList.remove('hidden');
        newView.classList.add('active');
    }
    
    // ボタンのアクティブ状態を更新
    document.querySelectorAll('.btn-toolbar').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // 詳細タブの表示/非表示制御
    const detailTabs = document.getElementById('detailTabs');
    if (mode === 'stream' && selectedActivityId) {
        detailTabs.style.display = 'flex';
    } else {
        detailTabs.style.display = 'none';
    }
    
    currentViewMode = mode;
    
    // ビューモード変更時の追加処理
    switch (mode) {
        case 'kanban':
            initializeKanbanView();
            break;
        case 'table':
            initializeTableView();
            break;
        case 'stream':
            updateStreamView();
            break;
    }
}

// かんばんビュー初期化
function initializeKanbanView() {
    console.log('かんばんビューを初期化');
    // ドラッグ&ドロップ機能の初期化（実際の実装では追加）
    
    // カードクリック時の詳細表示
    document.querySelectorAll('.kanban-card').forEach(card => {
        card.onclick = function() {
            const activityId = this.dataset.activityId || 'activity-001';
            selectActivity(activityId);
        };
    });
}

// テーブルビュー初期化
function initializeTableView() {
    console.log('テーブルビューを初期化');
    updateTableSelection();
}

// ストリームビュー更新
function updateStreamView() {
    console.log('ストリームビューを更新');
}

// 一括処理
function bulkProcess() {
    document.getElementById('quickActionModal').classList.remove('hidden');
}

function closeQuickAction() {
    document.getElementById('quickActionModal').classList.add('hidden');
}

function executeBulkProcess() {
    alert('一括処理を実行しました');
    closeQuickAction();
    
    // UIを更新（実際の実装では処理状況を反映）
    updateProcessingStatus();
}

// 処理状況更新
function updateProcessingStatus() {
    // 実際の実装では、サーバーから最新状況を取得してUIを更新
    console.log('処理状況を更新');
}

// エクスポート機能
function exportData() {
    document.getElementById('exportModal').classList.remove('hidden');
}

function closeExportModal() {
    document.getElementById('exportModal').classList.add('hidden');
}

function applyExportPreset(type) {
    const formatInputs = document.querySelectorAll('input[name="exportFormat"]');
    const checkboxes = document.querySelectorAll('#exportModal input[type="checkbox"]');
    
    // プリセットに応じて設定を変更
    switch (type) {
        case 'executive':
            // 経営陣向け: PDF、基本情報とサマリーのみ
            formatInputs[1].checked = true; // PDF
            checkboxes[0].checked = true;   // 基本情報
            checkboxes[1].checked = true;   // 処理統計
            checkboxes[2].checked = false;  // 文字起こし
            checkboxes[3].checked = true;   // AI分析
            checkboxes[4].checked = false;  // FAQ
            break;
        case 'detailed':
            // 詳細分析: Excel、すべてのデータ
            formatInputs[0].checked = true; // Excel
            checkboxes.forEach(cb => cb.checked = true);
            break;
        case 'compliance':
            // コンプライアンス: PDF、基本情報と文字起こし
            formatInputs[1].checked = true; // PDF
            checkboxes[0].checked = true;   // 基本情報
            checkboxes[1].checked = false;  // 処理統計
            checkboxes[2].checked = true;   // 文字起こし
            checkboxes[3].checked = false;  // AI分析
            checkboxes[4].checked = true;   // FAQ
            break;
    }
}

function executeExport() {
    const format = document.querySelector('input[name="exportFormat"]:checked').value;
    const selectedData = [];
    
    document.querySelectorAll('#exportModal input[type="checkbox"]:checked').forEach(cb => {
        selectedData.push(cb.nextElementSibling.textContent);
    });
    
    console.log(`エクスポート実行: ${format}形式, データ: ${selectedData.join(', ')}`);
    
    // 実際の実装では、サーバーにエクスポート要求を送信
    showNotification(`${format.toUpperCase()}形式でエクスポートを開始しました`);
    closeExportModal();
    
    // エクスポート進捗のシミュレーション
    setTimeout(() => {
        showNotification('エクスポートが完了しました。ダウンロードを開始します。');
    }, 3000);
}

// フィルター機能
function showFilters() {
    document.getElementById('filterModal').classList.remove('hidden');
}

function closeFilterModal() {
    document.getElementById('filterModal').classList.add('hidden');
}

function applyFilterPreset(type) {
    const checkboxes = document.querySelectorAll('#filterModal input[type="checkbox"]');
    
    // まずすべてをリセット
    checkboxes.forEach(cb => cb.checked = false);
    
    switch (type) {
        case 'urgent':
            // 緊急対応必要: 緊急優先度のみ
            document.querySelector('#filterModal input[type="checkbox"][checked]').checked = true; // AI分析中
            document.querySelectorAll('#filterModal input[type="checkbox"]')[10].checked = true; // 緊急優先度
            break;
        case 'stalled':
            // 処理停滞中: AI分析中で長時間経過
            document.querySelectorAll('#filterModal input[type="checkbox"]')[6].checked = true; // AI分析中
            break;
        case 'completed_today':
            // 本日完了: 公開済み + 本日の日付
            document.querySelectorAll('#filterModal input[type="checkbox"]')[9].checked = true; // 公開済み
            break;
        case 'high_accuracy':
            // 高精度AI分析: AI精度90%以上
            document.querySelector('#filterModal input[type="range"]').value = 90;
            break;
        case 'overseas':
            // 海外投資家のみ
            document.querySelectorAll('#filterModal input[type="checkbox"]')[1].checked = true; // 海外投資家
            break;
    }
}

function applyFilters() {
    const filters = collectFilterSettings();
    console.log('フィルタ適用:', filters);
    
    // 実際の実装では、フィルタに基づいてデータを更新
    showNotification('フィルタを適用しました');
    closeFilterModal();
    
    // 現在のビューを更新
    switch (currentViewMode) {
        case 'table':
            updateTableWithFilters(filters);
            break;
        case 'kanban':
            updateKanbanWithFilters(filters);
            break;
        case 'stream':
            updateStreamWithFilters(filters);
            break;
    }
}

function resetFilters() {
    // すべてのフィルタ設定をリセット
    document.querySelectorAll('#filterModal input[type="checkbox"]').forEach(cb => {
        cb.checked = cb.hasAttribute('checked');
    });
    document.querySelectorAll('#filterModal input[type="date"]').forEach(input => {
        input.value = '';
    });
    document.querySelectorAll('#filterModal select').forEach(select => {
        select.selectedIndex = 0;
    });
    document.querySelectorAll('#filterModal input[type="range"]').forEach(range => {
        range.value = range.getAttribute('value') || range.min;
    });
    document.querySelector('#filterModal input[type="text"]').value = '';
}

function collectFilterSettings() {
    return {
        dateRange: {
            start: document.querySelectorAll('#filterModal input[type="date"]')[0].value,
            end: document.querySelectorAll('#filterModal input[type="date"]')[1].value
        },
        investorTypes: Array.from(document.querySelectorAll('#filterModal input[type="checkbox"]:checked'))
            .map(cb => cb.nextElementSibling.textContent.trim()),
        keyword: document.querySelector('#filterModal input[type="text"]').value,
        accuracyRange: {
            min: document.querySelectorAll('#filterModal input[type="range"]')[0].value,
            max: document.querySelectorAll('#filterModal input[type="range"]')[1].value
        }
    };
}

function updateTableWithFilters(filters) {
    console.log('テーブルビューにフィルタを適用:', filters);
    // 実装: テーブルの行を条件に基づいて表示/非表示
}

function updateKanbanWithFilters(filters) {
    console.log('かんばんビューにフィルタを適用:', filters);
    // 実装: かんばんカードを条件に基づいて表示/非表示
}

function updateStreamWithFilters(filters) {
    console.log('ストリームビューにフィルタを適用:', filters);
    // 実装: ストリームアイテムを条件に基づいて表示/非表示
}

// 一括処理で使用される補助関数
function showAssigneeChangeModal() {
    showNotification('担当者変更モーダルを開きます', 'info');
}

function showStatusChangeModal() {
    showNotification('ステータス変更モーダルを開きます', 'info');
}

function showPriorityChangeModal() {
    showNotification('優先度変更モーダルを開きます', 'info');
}

function exportSelectedRecords() {
    const count = selectedTableRows.size;
    showNotification(`選択した${count}件の記録をエクスポートします`, 'success');
}

function deleteSelectedRecords() {
    const count = selectedTableRows.size;
    selectedTableRows.clear();
    updateTableSelection();
    showNotification(`${count}件の記録を削除しました`, 'warning');
}

function selectAllRecords() {
    const allCheckboxes = document.querySelectorAll('.table-row input[type="checkbox"]');
    const masterCheckbox = document.getElementById('selectAllTable');
    toggleAllTableRows(masterCheckbox);
}

// 強制次ステージ
function forceNextStage() {
    if (confirm('AI要約をスキップして次の段階に進みますか？')) {
        alert('FAQ生成段階に移行しました');
        updateProcessingStatus();
    }
}

// 処理中断
function cancelProcessing() {
    if (confirm('処理を中断しますか？')) {
        alert('処理を中断しました');
        updateProcessingStatus();
    }
}

// リアルタイム更新
function startRealtimeUpdates() {
    // 実際の実装では、WebSocketやSSEでリアルタイム更新
    setInterval(() => {
        updateProcessingStatus();
    }, 30000); // 30秒ごとに更新
}

// インテリジェンスパネル開閉機能
function toggleIntelligencePanel() {
    const dialogueCenter = document.querySelector('.dialogue-center');
    const intelligencePanel = document.getElementById('intelligencePanel');
    const toggleButton = document.querySelector('.intelligence-toggle');
    
    if (!dialogueCenter || !intelligencePanel || !toggleButton) {
        console.error('必要な要素が見つかりません');
        return;
    }
    
    intelligencePanelCollapsed = !intelligencePanelCollapsed;
    
    if (intelligencePanelCollapsed) {
        dialogueCenter.classList.add('intelligence-collapsed');
        intelligencePanel.classList.add('collapsed');
        toggleButton.title = 'インテリジェンスパネルを開く';
        
        // 成功通知
        showNotification('🔍 知能分析パネルを閉じました', 'info');
    } else {
        dialogueCenter.classList.remove('intelligence-collapsed');
        intelligencePanel.classList.remove('collapsed');
        toggleButton.title = 'インテリジェンスパネルを閉じる';
        
        // 成功通知
        showNotification('🧠 知能分析パネルを開きました', 'success');
    }
    
    // 状態をローカルストレージに保存
    localStorage.setItem('intelligencePanelCollapsed', intelligencePanelCollapsed);
    
    console.log('インテリジェンスパネル:', intelligencePanelCollapsed ? '閉じる' : '開く');
}

// 通知表示機能
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-500 translate-x-0 z-50`;
    
    // タイプに応じた色を設定
    if (type === 'success') {
        notification.className += ' bg-green-500 text-white';
    } else if (type === 'info') {
        notification.className += ' bg-blue-500 text-white';
    } else if (type === 'warning') {
        notification.className += ' bg-yellow-500 text-white';
    } else if (type === 'error') {
        notification.className += ' bg-red-500 text-white';
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // アニメーション
    setTimeout(() => {
        notification.style.transform = 'translateX(0px)';
        notification.style.opacity = '1';
    }, 100);
    
    // 3秒後に非表示
    setTimeout(() => {
        notification.style.transform = 'translateX(400px)';
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 500);
    }, 3000);
}

// キーボードヘルプの表示
function showKeyboardHelp() {
    const helpModal = document.createElement('div');
    helpModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    helpModal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">⌨️ キーボードショートカット</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600">インテリジェンスパネル開閉</span>
                    <kbd class="px-2 py-1 bg-gray-100 rounded">Ctrl+I</kbd>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">一括処理</span>
                    <kbd class="px-2 py-1 bg-gray-100 rounded">B</kbd>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">このヘルプ</span>
                    <kbd class="px-2 py-1 bg-gray-100 rounded">H</kbd>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(helpModal);
    
    // クリックで閉じる
    helpModal.addEventListener('click', function(e) {
        if (e.target === helpModal) {
            helpModal.remove();
        }
    });
}

function initializeIntelligencePanel() {
    console.log('インテリジェンスパネル初期化開始');
    
    // ローカルストレージから前回の状態を復元
    const saved = localStorage.getItem('intelligencePanelCollapsed');
    console.log('保存された状態:', saved);
    
    const dialogueCenter = document.querySelector('.dialogue-center');
    const intelligencePanel = document.getElementById('intelligencePanel');
    const toggleButton = document.querySelector('.intelligence-toggle');
    
    if (!dialogueCenter || !intelligencePanel || !toggleButton) {
        console.error('初期化: 必要な要素が見つかりません', {
            dialogueCenter: !!dialogueCenter,
            intelligencePanel: !!intelligencePanel,
            toggleButton: !!toggleButton
        });
        return;
    }
    
    if (saved !== null) {
        intelligencePanelCollapsed = JSON.parse(saved);
        console.log('復元された状態:', intelligencePanelCollapsed);
        
        if (intelligencePanelCollapsed) {
            console.log('初期化: パネルを閉じた状態で復元');
            dialogueCenter.classList.add('intelligence-collapsed');
            intelligencePanel.classList.add('collapsed');
            toggleButton.title = 'インテリジェンスパネルを開く';
        } else {
            toggleButton.title = 'インテリジェンスパネルを閉じる';
        }
    } else {
        console.log('保存された状態なし、デフォルト状態を使用');
        toggleButton.title = 'インテリジェンスパネルを閉じる';
    }
    
    // 初期化完了の通知
    setTimeout(() => {
        showNotification('💬 対話記録センターが読み込まれました', 'success');
    }, 500);
}

// 初期化
document.addEventListener('DOMContentLoaded', function() {
    console.log('ページ読み込み完了、初期化開始');
    
    // デバッグ用: ローカルストレージをクリア（必要に応じて）
    localStorage.removeItem('intelligencePanelCollapsed');
    
    // インテリジェンスパネルの状態を初期化
    initializeIntelligencePanel();
    
    // 初期選択状態を設定
    selectActivity('activity-001');
    
    // リアルタイム更新を開始
    startRealtimeUpdates();
    
    // キーボードショートカット
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'f':
                    e.preventDefault();
                    showFilters();
                    break;
                case 'e':
                    e.preventDefault();
                    exportData();
                    break;
                case 'b':
                    e.preventDefault();
                    bulkProcess();
                    break;
                case 'i':
                    e.preventDefault();
                    toggleIntelligencePanel();
                    break;
            }
        }
    });
});

// 自動更新によるプログレス更新（デモ用）
setTimeout(() => {
    document.querySelector('.stage-circle.processing').classList.remove('processing');
    document.querySelector('.stage-circle.processing').classList.add('completed');
    document.querySelector('.stage-circle.processing').innerHTML = '✓';
}, 5000);
</script>
{% endblock %} 